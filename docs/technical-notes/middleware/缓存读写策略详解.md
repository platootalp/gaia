# ç¼“å­˜è¯»å†™ç­–ç•¥

ä¸‹é¢æ˜¯å¯¹äº”ç§æ ¸å¿ƒç¼“å­˜è¯»å†™ç­–ç•¥ï¼ˆ**Cache Aside**ã€**Read Through**ã€**Write Through**ã€**Write Behind**ã€**Write Around
**ï¼‰çš„**è¶…è¯¦ç»†è§£æ**ï¼ŒåŒ…æ‹¬ï¼š

- **æ ¸å¿ƒåŸç†**
- **å®Œæ•´æ“ä½œæµç¨‹ï¼ˆå«ä¼ªä»£ç å’Œæ—¶åºè¯´æ˜ï¼‰**
- **æ¯ä¸€æ­¥çš„é€»è¾‘è§£é‡Š**
- **æµç¨‹å›¾ï¼ˆä½¿ç”¨ Mermaid è¯­æ³•ï¼Œå¯ç›´æ¥åœ¨æ”¯æŒ Mermaid çš„ç¼–è¾‘å™¨/æ–‡æ¡£ä¸­æ¸²æŸ“ï¼‰**
- **ä¼˜ç¼ºç‚¹æ·±åº¦åˆ†æ**
- **å…¸å‹åº”ç”¨åœºæ™¯ä¸é¿å‘æŒ‡å—**

---

## ğŸ§  å‰ç½®æ¦‚å¿µè¯´æ˜

åœ¨ç¼“å­˜ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬é€šå¸¸æœ‰ï¼š

- **Applicationï¼ˆAppï¼‰**ï¼šä¸šåŠ¡åº”ç”¨
- **Cache**ï¼šç¼“å­˜å±‚ï¼ˆå¦‚ Redisã€Memcachedï¼‰
- **Databaseï¼ˆDBï¼‰**ï¼šæŒä¹…åŒ–å­˜å‚¨ï¼ˆå¦‚ MySQLï¼‰

ç¼“å­˜ç­–ç•¥çš„æ ¸å¿ƒç›®æ ‡æ˜¯åœ¨ **æ€§èƒ½ï¼ˆä½å»¶è¿Ÿï¼‰**ã€**ä¸€è‡´æ€§ï¼ˆæ­£ç¡®æ€§ï¼‰** å’Œ **å¯é æ€§ï¼ˆå®¹é”™ï¼‰** ä¹‹é—´å–å¾—å¹³è¡¡ã€‚

---

## 1. Cache Asideï¼ˆæ—è·¯ç¼“å­˜ / Lazy Loadingï¼‰

### âœ… æ ¸å¿ƒæ€æƒ³

- åº”ç”¨ç›´æ¥æ“ä½œ **Cache + DB**
- **è¯»**ï¼šå…ˆæŸ¥ç¼“å­˜ï¼Œæœªå‘½ä¸­å†æŸ¥ DB å¹¶å›å¡«ç¼“å­˜
- **å†™**ï¼šå…ˆæ›´æ–° DBï¼Œ**å†åˆ é™¤ç¼“å­˜**ï¼ˆä¸æ˜¯æ›´æ–°ï¼ï¼‰

> âš ï¸ ä¸ºä»€ä¹ˆå†™æ—¶**åˆ é™¤**ç¼“å­˜è€Œä¸æ˜¯**æ›´æ–°**ï¼Ÿ
> - é¿å…å†™å…¥æ— ç”¨æ•°æ®ï¼ˆè¯¥æ•°æ®å¯èƒ½æ°¸è¿œä¸ä¼šè¢«è¯»ï¼‰
> - é¿å…å¹¶å‘ä¸‹â€œå…ˆæ›´æ–°ç¼“å­˜ä½† DB æ›´æ–°å¤±è´¥â€å¯¼è‡´è„æ•°æ®
> - åˆ é™¤æ˜¯å¹‚ç­‰æ“ä½œï¼Œæ›´å®‰å…¨

---

### ğŸ“œ è¯»æ“ä½œæµç¨‹ï¼ˆä¼ªä»£ç ï¼‰

```python
def get_user(user_id):
    user = cache.get(f"user:{user_id}")
    if user is None:
        user = db.query("SELECT * FROM users WHERE id = ?", user_id)
        if user:
            cache.set(f"user:{user_id}", user, ttl=3600)
    return user
```

### âœï¸ å†™æ“ä½œæµç¨‹ï¼ˆä¼ªç ï¼‰

```python
def update_user(user_id, name):
    # 1. å…ˆæ›´æ–°æ•°æ®åº“
    db.execute("UPDATE users SET name = ? WHERE id = ?", name, user_id)
    # 2. åˆ é™¤ç¼“å­˜ï¼ˆä¸æ˜¯ setï¼ï¼‰
    cache.delete(f"user:{user_id}")
```

---

### ğŸ”„ æ—¶åºå›¾ï¼ˆMermaidï¼‰

```mermaid
sequenceDiagram
    participant App
    participant Cache
    participant DB
    App ->> Cache: GET key
    alt Hit
        Cache -->> App: è¿”å›æ•°æ®
    else Miss
        Cache -->> App: null
        App ->> DB: æŸ¥è¯¢æ•°æ®
        DB -->> App: è¿”å›æ•°æ®
        App ->> Cache: SET key=value (å¸¦TTL)
        Cache -->> App: ç¡®è®¤
        App -->> Client: è¿”å›æ•°æ®
    end
```

```mermaid
sequenceDiagram
    participant App
    participant DB
    participant Cache
    App ->> DB: UPDATE data
    DB -->> App: æˆåŠŸ
    App ->> Cache: DELETE key
    Cache -->> App: ç¡®è®¤
```

---

### âœ… ä¼˜ç‚¹

- å®ç°ç®€å•ï¼Œé€»è¾‘æ¸…æ™°
- ç¼“å­˜åªå­˜çƒ­ç‚¹æ•°æ®ï¼Œå†…å­˜æ•ˆç‡é«˜
- åº”ç”¨å®Œå…¨æŒæ§ç¼“å­˜è¡Œä¸º

### âŒ ç¼ºç‚¹

- **å­˜åœ¨çŸ­æš‚ä¸ä¸€è‡´çª—å£**ï¼šDBæ›´æ–°åã€ç¼“å­˜åˆ é™¤å‰ï¼Œè‹¥æœ‰å¹¶å‘è¯»ï¼Œå¯èƒ½è¯»åˆ°æ—§ç¼“å­˜
- **ç¼“å­˜ç©¿é€é£é™©**ï¼šæ¶æ„è¯·æ±‚ä¸å­˜åœ¨çš„ key ä¼šæ‰“ç©¿ DB
- **é¦–æ¬¡è¯»å¿…ç©¿é€ DB**

### ğŸ›  å¹¶å‘é—®é¢˜è§£å†³æ–¹æ¡ˆ

1. **å»¶è¿ŸåŒåˆ ï¼ˆDouble Deleteï¼‰**ï¼š
   ```python
   update_user():
       db.update()
       cache.delete(key)
       sleep(100ms)  # ç­‰å¾…å¯èƒ½çš„å¹¶å‘è¯»å®Œæˆ
       cache.delete(key)  # äºŒæ¬¡æ¸…ç†
   ```
2. **æ¶ˆæ¯é˜Ÿåˆ—é‡è¯•**ï¼šåˆ é™¤å¤±è´¥æ—¶å‘æ¶ˆæ¯å¼‚æ­¥é‡è¯•
3. **åˆ†å¸ƒå¼é”ï¼ˆæ…ç”¨ï¼‰**ï¼šå¯¹ key åŠ é”ï¼Œä½†å½±å“æ€§èƒ½

### ğŸ¯ é€‚ç”¨åœºæ™¯

- è¯»å¤šå†™å°‘ï¼ˆå¦‚å•†å“è¯¦æƒ…ã€ç”¨æˆ·ä¿¡æ¯ï¼‰
- å¯æ¥å—æœ€ç»ˆä¸€è‡´æ€§ï¼ˆå¦‚ç”µå•†ã€ç¤¾äº¤ï¼‰
- éœ€è¦çµæ´»æ§åˆ¶ç¼“å­˜ç­–ç•¥ï¼ˆå¦‚è‡ªå®šä¹‰ TTLï¼‰

---

## 2. Read Throughï¼ˆè¯»ç©¿é€ï¼‰

### âœ… æ ¸å¿ƒæ€æƒ³

- **ç¼“å­˜å±‚å°è£… DB è¯»é€»è¾‘**
- App åªä¸ Cache äº¤äº’ï¼ŒCache æœªå‘½ä¸­æ—¶**è‡ªåŠ¨ä» DB åŠ è½½**

> ğŸ”§ å®ç°å‰æï¼šç¼“å­˜ç³»ç»Ÿéœ€æ”¯æŒ **CacheLoader**ï¼ˆå¦‚ Guava Cacheã€Caffeineï¼‰

---

### ğŸ“œ ä¼ªä»£ç ï¼ˆä»¥ Caffeine ä¸ºä¾‹ï¼‰

```java
LoadingCache<String, User> cache = Caffeine.newBuilder()
        .build(key -> {
            // è‡ªåŠ¨ä» DB åŠ è½½
            return db.getUserById(key);
        });

User user = cache.get("user:123"); // æœªå‘½ä¸­æ—¶è‡ªåŠ¨è°ƒç”¨ loader
```

---

### ğŸ”„ æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant App
    participant Cache
    participant DB
    App ->> Cache: GET key
    alt Hit
        Cache -->> App: è¿”å›æ•°æ®
    else Miss
        Cache ->> DB: è‡ªåŠ¨è°ƒç”¨ CacheLoader
        DB -->> Cache: è¿”å›æ•°æ®
        Cache ->> Cache: æœ¬åœ°ç¼“å­˜
        Cache -->> App: è¿”å›æ•°æ®
    end
```

> âœï¸ å†™æ“ä½œä»éœ€ App ç›´æ¥æ“ä½œ DBï¼ˆæˆ–é…åˆ Write Throughï¼‰

---

### âœ… ä¼˜ç‚¹

- App æ— éœ€å¤„ç†ç¼“å­˜æœªå‘½ä¸­é€»è¾‘
- è‡ªåŠ¨åŠ è½½ï¼Œä»£ç ç®€æ´
- æœ¬åœ°ç¼“å­˜é«˜æ•ˆï¼ˆå¦‚ Caffeineï¼‰

### âŒ ç¼ºç‚¹

- **ä»…é€‚ç”¨äºæœ¬åœ°ç¼“å­˜**ï¼ˆRedis ç­‰è¿œç¨‹ç¼“å­˜æ— æ³•ç›´æ¥å®ç°ï¼‰
- æ— æ³•çµæ´»æ§åˆ¶åŠ è½½é€»è¾‘ï¼ˆå¦‚å¤šè¡¨ JOINï¼‰
- å†·å¯åŠ¨æ—¶å¤§é‡è¯·æ±‚å¯èƒ½å‹å® DBï¼ˆéœ€é…åˆ Refresh-Aheadï¼‰

### ğŸ¯ é€‚ç”¨åœºæ™¯

- æœ¬åœ°ç¼“å­˜ï¼ˆå¦‚ JVM å†…ç¼“å­˜ï¼‰
- æ•°æ®ç»“æ„ç®€å•ã€åŠ è½½é€»è¾‘å›ºå®šçš„åœºæ™¯

---

## 3. Write Throughï¼ˆå†™ç©¿é€ï¼‰

### âœ… æ ¸å¿ƒæ€æƒ³

- **å†™æ“ä½œåŒæ­¥ç©¿é€åˆ° DB**
- App å†™ Cache â†’ Cache **åŒæ­¥å†™ DB** â†’ æ›´æ–°è‡ªèº«

> ğŸ”§ éœ€ç¼“å­˜ç³»ç»Ÿæ”¯æŒ **WriteThroughCache** æ¥å£

---

### ğŸ“œ ä¼ªä»£ç 

```java
Cache<String, User> cache = Caffeine.newBuilder()
        .writer(new CacheWriter<String, User>() {
            @Override
            public void write(String key, User user) {
                db.updateUser(user); // åŒæ­¥å†™ DB
            }

            @Override
            public void delete(String key, User user, RemovalCause cause) {
                db.deleteUser(key);
            }
        })
        .build();
```

---

### ğŸ”„ æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant App
    participant Cache
    participant DB
    App ->> Cache: PUT key=value
    Cache ->> DB: åŒæ­¥å†™å…¥æ•°æ®
    DB -->> Cache: æˆåŠŸ
    Cache ->> Cache: æ›´æ–°æœ¬åœ°ç¼“å­˜
    Cache -->> App: ç¡®è®¤
```

---

### âœ… ä¼˜ç‚¹

- æ•°æ®å¼ºä¸€è‡´æ€§ï¼ˆå†™æ“ä½œåŸå­æ€§ï¼‰
- App æ— éœ€å…³å¿ƒ DB å†™å…¥
- ç¼“å­˜ä¸ DB å§‹ç»ˆåŒæ­¥

### âŒ ç¼ºç‚¹

- **å†™æ€§èƒ½å— DB æ‹–ç´¯**ï¼ˆåŒæ­¥é˜»å¡ï¼‰
- å®ç°å¤æ‚ï¼ˆéœ€ç¼“å­˜å±‚æ”¯æŒå†™é€ï¼‰
- ä¸é€‚ç”¨äºé«˜å†™å…¥åååœºæ™¯

### ğŸ¯ é€‚ç”¨åœºæ™¯

- é‡‘èäº¤æ˜“ã€è®¢å•çŠ¶æ€ç­‰å¼ºä¸€è‡´æ€§åœºæ™¯
- æœ¬åœ°ç¼“å­˜ + åŒæ­¥å­˜å‚¨ï¼ˆå¦‚åµŒå…¥å¼æ•°æ®åº“ï¼‰

---

## 4. Write Behindï¼ˆWrite Backï¼Œå†™å›ï¼‰

### âœ… æ ¸å¿ƒæ€æƒ³

- **å†™æ“ä½œåªæ›´æ–°ç¼“å­˜ï¼Œå¼‚æ­¥æ‰¹é‡åˆ·å…¥ DB**
- ç¼“å­˜ä½œä¸º**å”¯ä¸€å†™å…¥ç‚¹**

---

### ğŸ“œ å·¥ä½œæµç¨‹

1. App å†™å…¥ç¼“å­˜
2. ç¼“å­˜è®°å½•å˜æ›´æ—¥å¿—ï¼ˆWALï¼‰
3. åå°çº¿ç¨‹æŒ‰ç­–ç•¥ï¼ˆæ—¶é—´/æ•°é‡ï¼‰æ‰¹é‡å†™å…¥ DB

> ğŸ”§ éœ€ç¼“å­˜ç³»ç»Ÿæ”¯æŒæŒä¹…åŒ–æ—¥å¿—ï¼ˆå¦‚ Redis AOF + è‡ªå®šä¹‰åˆ·ç›˜ï¼‰

---

### ğŸ”„ æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant App
    participant Cache
    participant BackgroundThread
    participant DB
    App ->> Cache: PUT key=value
    Cache ->> Cache: æ›´æ–°å†…å­˜ + è®°å½•WAL
    Cache -->> App: ç«‹å³è¿”å›ï¼ˆä½å»¶è¿Ÿï¼‰
    Note over BackgroundThread: å¼‚æ­¥æ‰¹å¤„ç†
    BackgroundThread ->> DB: æ‰¹é‡å†™å…¥ï¼ˆåˆå¹¶é‡å¤æ›´æ–°ï¼‰
    DB -->> BackgroundThread: ç¡®è®¤
    BackgroundThread ->> Cache: æ¸…ç†WAL
```

---

### âœ… ä¼˜ç‚¹

- **å†™æ€§èƒ½æé«˜**ï¼ˆæ—  DB åŒæ­¥ç­‰å¾…ï¼‰
- å‡å°‘ DB å‹åŠ›ï¼ˆåˆå¹¶å¤šæ¬¡æ›´æ–°ï¼‰
- é€‚åˆé«˜ååå†™å…¥

### âŒ ç¼ºç‚¹

- **æ•°æ®ä¸¢å¤±é£é™©**ï¼šç¼“å­˜å®•æœº â†’ WAL ä¸¢å¤± â†’ æ•°æ®ä¸¢å¤±
- ä¸€è‡´æ€§æœ€å¼±ï¼ˆDB æ»åï¼‰
- å®ç°å¤æ‚ï¼ˆéœ€ WALã€æ‰¹å¤„ç†ã€å¤±è´¥é‡è¯•ï¼‰

### ğŸ¯ é€‚ç”¨åœºæ™¯

- æ—¥å¿—æ”¶é›†ã€ç›‘æ§æŒ‡æ ‡ã€ç‚¹å‡»æµ
- å¯å®¹å¿æ•°æ®ä¸¢å¤±çš„åœºæ™¯ï¼ˆå¦‚â€œç‚¹èµæ•°â€ï¼‰
- å†™å¯†é›†å‹ç³»ç»Ÿï¼ˆå¦‚ IoT æ•°æ®ä¸ŠæŠ¥ï¼‰

> ğŸ”¥ æ³¨æ„ï¼š**Redis é»˜è®¤ä¸æ˜¯ Write Behind**ï¼éœ€è‡ªè¡Œå®ç°å¼‚æ­¥åˆ·ç›˜é€»è¾‘ã€‚

---

## 5. Write Aroundï¼ˆç»•è¿‡ç¼“å­˜å†™å…¥ï¼‰

### âœ… æ ¸å¿ƒæ€æƒ³

- **å†™æ“ä½œç›´æ¥ç»•è¿‡ç¼“å­˜ï¼Œåªå†™ DB**
- ç¼“å­˜ä»…é€šè¿‡**è¯»æ“ä½œ**æˆ–**è¿‡æœŸ**æ›´æ–°

---

### ğŸ“œ ä¼ªä»£ç 

```python
def update_user(user_id, name):
    # ç›´æ¥å†™ DBï¼Œä¸ç¢°ç¼“å­˜
    db.execute("UPDATE users SET name = ? WHERE id = ?", name, user_id)

def get_user(user_id):
    user = cache.get(f"user:{user_id}")
    if not user:
        user = db.query("SELECT * FROM users WHERE id = ?", user_id)
        cache.set(f"user:{user_id}", user, ttl=3600)
    return user
```

---

### ğŸ”„ æ—¶åºå›¾ï¼ˆå†™ï¼‰

```mermaid
sequenceDiagram
    participant App
    participant DB
    App ->> DB: ç›´æ¥å†™å…¥
    DB -->> App: ç¡®è®¤
    Note right of App: ç¼“å­˜æœªè¢«æ›´æ–°ï¼
```

---

### âœ… ä¼˜ç‚¹

- é¿å…ç¼“å­˜è¢«**ä½é¢‘è®¿é—®æ•°æ®**æ±¡æŸ“
- èŠ‚çœç¼“å­˜å†™å…¥å¼€é”€ï¼ˆæ—  SET/DELETE æ“ä½œï¼‰

### âŒ ç¼ºç‚¹

- **å†™åç«‹å³è¯» = ç¼“å­˜æœªå‘½ä¸­** â†’ å¿…ç„¶ç©¿é€ DB
- çƒ­ç‚¹æ•°æ®å†™å…¥åé¦–æ¬¡è¯»å»¶è¿Ÿé«˜

### ğŸ¯ é€‚ç”¨åœºæ™¯

- å†™å…¥å**é•¿æ—¶é—´ä¸è¯»**çš„æ•°æ®ï¼ˆå¦‚å®¡è®¡æ—¥å¿—ã€å¤‡ä»½è®°å½•ï¼‰
- æ‰¹é‡å¯¼å…¥æ•°æ®ï¼ˆé¿å…ç¼“å­˜çˆ†ç‚¸ï¼‰
- å†™æ“ä½œè¿œå¤šäºè¯»ï¼ˆå¦‚ä¼ æ„Ÿå™¨æ•°æ®å†™å…¥ï¼‰

---

## ğŸ“Š ç­–ç•¥å¯¹æ¯”æ€»è¡¨

| ç­–ç•¥                | ä¸€è‡´æ€§  | è¯»æ€§èƒ½   | å†™æ€§èƒ½   | å®ç°å¤æ‚åº¦ | æ•°æ®å¯é æ€§ | å…¸å‹åœºæ™¯           |
|-------------------|------|-------|-------|-------|-------|----------------|
| **Cache Aside**   | æœ€ç»ˆä¸€è‡´ | â­â­â­â­  | â­â­    | â­     | â­â­â­â­  | é€šç”¨ï¼ˆç”µå•†ã€ç¤¾äº¤ï¼‰      |
| **Read Through**  | å¼ºä¸€è‡´  | â­â­â­â­  | -     | â­â­    | â­â­â­â­  | æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰ |
| **Write Through** | å¼ºä¸€è‡´  | -     | â­     | â­â­â­   | â­â­â­â­  | é‡‘èã€è®¢å•          |
| **Write Behind**  | å¼±ä¸€è‡´  | -     | â­â­â­â­â­ | â­â­â­â­  | â­     | æ—¥å¿—ã€ç›‘æ§ã€IoT      |
| **Write Around**  | æœ€ç»ˆä¸€è‡´ | â­ï¼ˆå†™åï¼‰ | â­â­â­â­  | â­     | â­â­â­â­  | å®¡è®¡æ—¥å¿—ã€æ‰¹é‡å¯¼å…¥      |

> æ³¨ï¼šâ­è¶Šå¤šè¡¨ç¤ºæ€§èƒ½/å¯é æ€§è¶Šé«˜

---

## ğŸ›  å®é™…å·¥ç¨‹å»ºè®®

1. **é»˜è®¤ç”¨ Cache Aside**ï¼š90% åœºæ™¯é€‚ç”¨
2. **é˜²ç¼“å­˜é›ªå´©**ï¼šTTL åŠ éšæœºæŠ–åŠ¨ï¼ˆå¦‚ `3600 Â± 300s`ï¼‰
3. **é˜²ç¼“å­˜ç©¿é€**ï¼šå¯¹ç©ºç»“æœä¹Ÿç¼“å­˜ï¼ˆ`NULL` + çŸ­ TTLï¼‰
4. **é«˜å¹¶å‘å†™**ï¼šè€ƒè™‘ **å…ˆåˆ ç¼“å­˜ + æ¶ˆæ¯é˜Ÿåˆ—å»¶è¿ŸåŒåˆ **
5. **å¤šçº§ç¼“å­˜**ï¼šæœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰ + è¿œç¨‹ç¼“å­˜ï¼ˆRedisï¼‰
