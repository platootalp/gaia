你是一名资深 Java SDK 设计专家，精通 Spring Boot、OkHttp、GuavafastJson、Lombok 等主流生态，在 SDK
设计上具有丰富经验，擅长设计高内聚、低耦合、可扩展的 SDK 组件，严格遵循阿里 Java 开发规范与 Clean Code 原则。
现在，请你基于以下我提供的详细输入，输出一份完整、可落地的 SDK 设计方案。
---

## **【第一部分：需求与上下文输入】**

* **1. 需求目标**
    * **核心价值**：让 Java 应用能以极低的成本、高可靠性和高性能的方式，将文件安全地上传到我们的云存储服务。
    * **业务场景**：云存储、内容分发（CDN）、媒体处理、数据备份。
* **2. 使用场景与调用方**
    * **调用方类型**：后端微服务（处理用户头像、文档等）、大数据任务（上传日志、数据报告）、第三方合作伙伴（通过集成我们的服务上传内容）。
    * **运行环境**：主要运行在 Spring Boot 应用中，也需要兼容纯 Java 应用和 Serverless 环境（如 AWS Lambda）。
    * **并发量级预估**：中到高频（50-500 QPS），并伴有突发流量。
* **3. 功能要求**
    * **核心功能列表**：
        * 功能点 1：简单文件上传
            * 对应 API 端点：`/api/v1/files`
            * 请求方式：`POST` (Content-Type: multipart/form-data)
            * 关键请求参数：`file` (文件流), `path` (存储路径), `metadata` (可选的JSON字符串元数据)
            * 关键响应数据：`fileId`, `url`
        * 功能点 2：分块上传
            * 对应 API 端点：
                - 初始化：`POST /api/v1/multipart/init`
                - 上传分块：`PUT /api/v1/multipart/{uploadId}/{partNumber}`
                - 完成上传：`POST /api/v1/multipart/complete`
            * 请求方式：`POST`, `PUT`, `POST`
            * 关键请求参数：
                - 初始化：`fileName`, `totalSize`, `partSize`
                - 上传分块：分块二进制数据
                - 完成上传：`uploadId`, `partETags` (分块号和ETag的列表)
            * 关键响应数据：
                - 初始化：`uploadId`
                - 上传分块：`etag`
                - 完成上传：`fileId`, `url`
        * 功能点 3：获取上传进度
            * 对应 API 端点：SDK 内部状态管理，非直接 API 调用。
            * 请求方式：N/A
            * 关键请求参数：N/A
            * 关键响应数据：通过回调或 `CompletableFuture` 返回进度百分比。
    * **认证方式**：API Key + Secret，使用签名算法（如 HMAC-SHA256）对请求进行签名。

## **4. 非功能性设计要求 **

### **4.1 性能与吞吐**

* **小文件性能**：文件 < 5MB 时，平均上传延迟 < 200ms，P99 延迟 < 1s。
* **大文件性能**：支持 GB 级文件稳定上传，保证持续吞吐率 ≥ 10MB/s（视网络带宽而定）。
* **连接复用**：客户端基于 OkHttp 连接池，支持 HTTP/1.1 与 HTTP/2 自动复用，减少建连开销。
* **流式处理**：所有上传下载均采用流式处理，避免 OOM。

---

### **4.2 稳定性与可靠性**

* **重试机制**：内置可配置重试策略（仅针对网络异常和 5xx 错误重试），支持指数退避与最大重试次数限制。
* **幂等性**：分块上传与断点续传需具备幂等性，保证重复请求不产生副作用。
* **容错策略**：对网络中断、服务端异常、DNS 解析失败等提供降级与快速失败机制。
* **限流与熔断**：支持 QPS、带宽限流、熔断与自动降级策略，防止级联故障。

---

### **4.3 可扩展性**

* **SPI 机制**：基于 Java SPI 提供扩展点，包括签名算法、进度监听器、认证策略、重试策略等。
* **模块化架构**：SDK 采用分层设计（core/client/transport），支持按需引入依赖与功能裁剪。
* **配置灵活性**：支持外部化配置与 Spring Boot `@ConfigurationProperties` 注入。

---

### **4.4 可观测性**

* **日志体系**：与主流日志框架（SLF4J、Log4j2、Logback）兼容；支持多级别日志输出。
* **事件与回调**：支持上传/下载进度监听、状态回调与错误通知机制。
* **指标采集**：预留接口采集上传速率、失败率、平均RT、P99延迟等指标，便于与 Prometheus / Micrometer 集成。
* **链路追踪**：支持 MDC TraceId 注入，便于在调用链中定位问题。

---

### **4.5 可维护性**

* **代码规范**：严格遵循阿里巴巴 Java 开发规范与 Clean Code 原则。
* **可测试性**：支持 Mock 网络请求与单元测试，提供测试用工具类和接口桩（stub）。
* **异常体系**：定义统一异常模型与错误码规范，区分网络异常、认证错误、服务端错误等。
* **文档支持**：提供完整 JavaDoc、示例代码与使用手册，便于二次开发与维护。

---

### **4.6 可移植性与兼容性**

* **依赖管理**：核心依赖仅限 OkHttp 4.12.0、Jackson、Lombok，避免引入 Feign、Spring MVC 等重型框架。
* **Java 版本**：最低兼容 JDK 8，推荐使用 JDK 17 以上。
* **平台兼容**：在 Windows、Linux、MacOS 环境下可稳定运行。
* **云适配**：支持腾讯云 COS、华为云 OBS 等多云后端，结构上具备扩展性。

---

### **4.7 安全性**

* **认证安全**：敏感凭证采用内存加密缓存，防止日志泄露。
* **数据安全**：支持 HTTPS 传输与签名机制，防止中间人攻击。
* **访问控制**：上传下载需基于临时凭证与签名校验。

---

* **5. 其他约束**
    * **目标 Java 版本**：Java 8
    * **服务端 API 规范**：RESTful
    * **序列化协议**：JSON (用于元数据), Multipart (用于文件体)
    * **已有技术栈**：当前底层采用 Feign，期望重构为 OkHttp 4.12.0。

---

## **【第二部分：设计方案输出】**

1️⃣ **架构设计概述**
...
2️⃣ **核心类设计**
...
3️⃣ **调用示例代码**
...
4️⃣ **错误处理与重试机制设计**
...
5️⃣ **最佳实践与扩展点**
...
6️⃣ **单元测试与Mock建议**
...
7️⃣ **文档与发布建议**
...
---

## **【最终指令】**

在设计时，请始终牢记 DDD 思想的“领域模型清晰、接口职责单一”原则，优先考虑企业级 SDK 的长期可维护性和平滑演进性。输出内容应包含清晰、可读的
Java 代码片段和结构化的文档。请基于以上输入，输出一份完整的、可落地的文件上传 SDK 设计方案。
