# JVM 垃圾收集器详解

## 1. 概述

* 什么是垃圾收集器
* JVM 中的垃圾回收机制简述
* 各主流垃圾收集器的适用场景对比

---

## 2. CMS（Concurrent Mark Sweep）垃圾收集器

### 2.1 简介

* 发展背景
* 设计目标与适用场景

### 2.2 工作原理

* 内存布局
* 垃圾回收算法（标记-清除）

### 2.3 工作流程

* 初始标记（Stop The World）
* 并发标记
* 重新标记（Stop The World）
* 并发清除

### 2.4 特点分析

- **优势**

  并发收集、低停顿

- **劣势（碎片问题、并发失败）**

  CMS 收集器对处理器资源非常敏感

  无法处理“浮动垃圾”（Floating Garbage）

  采用标记-清除算法，会有大量空间碎片产生

### 2.5 调优建议

* 常用参数
* 典型调优策略

---

## 3. G1（Garbage First）垃圾收集器

### 3.1 简介

* 设计目标
* 适用场景

### 3.2 工作原理

* 内存分区（Region）
* 并行与并发回收
* 混合收集（Young + Old）

### 3.3 工作流程

* 初始标记
* 并发标记
* 最终标记
* 筛选回收（Evacuation）

### 3.4 特点分析

* 停顿可预测

* 减少碎片

* 优势与限制

  

### 3.5 调优建议

在使用垃圾回收器（特别是 **G1**）进行调优时，以下是一些关键参数和设置建议，帮助你平衡 **吞吐量**（吞吐量是指应用程序的运行时间占总时间的比率）和 **延迟**（即垃圾回收过程中的停顿时间）。

#### 关键参数

| 参数                                     | 作用                                           | 适用场景                               |
| ---------------------------------------- | ---------------------------------------------- | -------------------------------------- |
| **`-XX:+UseG1GC`**                       | 启用 G1 垃圾回收器                             | 大堆应用，要求可控的停顿时间和吞吐量   |
| **`-XX:MaxGCPauseMillis`**               | 设置期望的最大 GC 停顿时间（毫秒）             | 需要控制停顿时间的低延迟应用           |
| **`-XX:InitiatingHeapOccupancyPercent`** | 设置堆占用百分比，决定何时触发 GC              | 根据堆大小、应用吞吐量要求调整         |
| **`-XX:G1HeapRegionSize`**               | 设置堆区域的大小（如 8MB 或 16MB）             | 影响回收效率，适合大堆或内存密集型应用 |
| **`-Xms` / `-Xmx`**                      | 设置堆的初始大小和最大大小                     | 保证堆内存稳定，避免频繁扩展/压缩堆    |
| **`-XX:ParallelGCThreads`**              | 设置并行 GC 的线程数量                         | 多核机器上提高吞吐量                   |
| **`-XX:ConcGCThreads`**                  | 设置并发 GC 的线程数量                         | 增加并发处理能力，减小停顿时间         |
| **`-XX:G1MixedGCLiveThresholdPercent`**  | 设置 G1 在混合垃圾回收期间保留活跃对象的百分比 | 控制 G1 回收策略和延迟                 |
| **`-XX:MinMetaspaceFreeRatio`**          | 设置 Metaspace 空间的最小空闲比例              | 控制 Metaspace 空间使用                |
| **`-XX:MaxMetaspaceFreeRatio`**          | 设置 Metaspace 空间的最大空闲比例              | 防止 Metaspace 过度扩展                |



#### 堆大小设置

堆的大小对 GC 性能和内存管理至关重要。正确配置堆大小可以有效减少垃圾回收次数并提高应用性能。

1. **初始堆大小 (`-Xms`) 与最大堆大小 (`-Xmx`)**

   - **`-Xms`**：设置 JVM 初始堆大小。较大的初始堆可以避免 JVM 启动时进行扩展，减少 GC 的次数。
   - **`-Xmx`**：设置 JVM 最大堆大小。要确保堆不会超过系统的物理内存，避免频繁的垃圾回收或 OutOfMemory 错误。
   - 一般建议设置 **`-Xms` 和 `-Xmx` 为相同值**，避免堆的动态扩展。

   示例：

   ```bash
   -Xms8g -Xmx8g
   ```

2. **堆区域大小 (`-XX:G1HeapRegionSize`)**

   - G1 使用堆区域管理堆内存，调整区域大小可以影响垃圾回收的性能。通常，较大的堆区域适用于大堆应用程序，减少 GC 的次数，但也可能增加某些场景下的 GC 停顿。
   - 推荐值：`16MB` 或 `32MB`。较小的区域对于小堆应用有效，但对大堆应用可能影响性能。

   示例：

   ```bash
   -XX:G1HeapRegionSize=16m
   ```



#### 吞吐量 vs 延迟平衡

G1 垃圾回收器的设计目标是平衡 **吞吐量** 和 **延迟**。你可以根据应用的实际需求来调整相关参数。

1. **延迟优先（低停顿时间）**

   - 对于对延迟敏感的应用（例如高频交易系统、实时数据处理系统等），需要确保垃圾回收的停顿时间尽可能短。
   - 使用 **`-XX:MaxGCPauseMillis`** 来设置期望的最大停顿时间，G1 会尽量优化垃圾回收过程以满足这个目标。

   示例（期望最大 GC 停顿时间为 200 毫秒）：

   ```bash
   -XX:MaxGCPauseMillis=200
   ```

2. **吞吐量优先（减少 GC 频率）**

   - 对于吞吐量要求较高的应用（如批量数据处理、后台任务等），可以适当放宽停顿时间的限制，优先考虑减少垃圾回收的频率。
   - 可以通过增加 **`-XX:ParallelGCThreads`** 来利用多核 CPU 加速垃圾回收过程，增加吞吐量。
   - **`-XX:G1HeapRegionSize`** 可以设置为较大的区域，以减少混合垃圾回收频率，从而提高吞吐量。

   示例（吞吐量优先，允许较长的 GC 停顿时间）：

   ```bash
   -XX:MaxGCPauseMillis=500
   -XX:ParallelGCThreads=8
   ```

3. **综合调优（平衡延迟和吞吐量）**

   - 对于大多数常规应用，目标通常是尽量平衡延迟和吞吐量。
   - 可以设置 **`-XX:MaxGCPauseMillis`** 为适当的值，同时监控吞吐量，逐步调整参数。

   示例：

   ```bash
   -XX:MaxGCPauseMillis=200
   -XX:ParallelGCThreads=4
   -XX:ConcGCThreads=4
   ```



#### 进一步调优建议

- **监控 GC 日志**：启用 GC 日志，观察 GC 停顿时间、堆内存使用情况、垃圾回收次数等，以便根据实际情况做出调整。

  ```bash
  -Xloggc:/path/to/gc.log
  -XX:+PrintGCDetails
  -XX:+PrintGCDateStamps
  -XX:+PrintGCApplicationStoppedTime
  ```

- **堆内存动态调整**：可以通过 **`-XX:InitiatingHeapOccupancyPercent`** 来控制堆占用百分比，调整何时触发垃圾回收，减少不必要的回收。

  示例：

  ```bash
  -XX:InitiatingHeapOccupancyPercent=70
  ```

- **监控内存使用**：使用 `jstat` 或 **JVM 堆分析工具**（如 `jvisualvm` 或 `MAT`）来分析内存使用情况，定位可能的内存泄漏或其他性能瓶颈。



## 4. ZGC（Z Garbage Collector）

### 4.1 简介

* 出现背景
* 目标（亚毫秒级停顿）

### 4.2 工作原理

* Region 分区模型
* 并发染色指针（Colored Pointer）
* 内存重映射（Remap）

### 4.3 工作流程

* 并发标记
* 并发重定位
* 并发清理

### 4.4 特点分析

* 停顿时间（<10ms）
* 海量内存支持（TB级别）
* 低延迟高吞吐
* 局限性（需要特定 JDK 版本）

### 4.5 调优建议

* 参数配置
* 适用场景
* 常见误区

---

## 5. 垃圾收集器对比总结

* CMS vs G1 vs ZGC
* 性能、延迟、吞吐对比
* 选择建议

---

## 6. 实践与案例

* 常见 GC 日志分析
* 性能调优实战
* 典型问题排查（Full GC频繁、内存碎片、长时间停顿等）

