# ä¼ä¸šçº§å¾®æœåŠ¡æ¶æ„è¯¦è§£

**ç‰ˆæœ¬ï¼š1.0**  
**é€‚ç”¨å¯¹è±¡**ï¼šç³»ç»Ÿæ¶æ„å¸ˆã€åç«¯å¼€å‘å·¥ç¨‹å¸ˆã€DevOps å·¥ç¨‹å¸ˆã€SRE å›¢é˜Ÿ  
**æ–‡æ¡£ç›®æ ‡**ï¼šå…¨é¢é˜è¿°åŸºäº Spring Cloud Gateway çš„ç°ä»£å¾®æœåŠ¡è¾¹ç•Œæ§åˆ¶ä½“ç³»ï¼Œæ¶µç›–ç½‘ç»œåˆ†å±‚ã€ç»„ä»¶èŒè´£ã€å®‰å…¨æœºåˆ¶ã€æµé‡æ²»ç†åŠå¯è§‚æµ‹æ€§è®¾è®¡ã€‚

---

## ç›®å½•

1. [å¼•è¨€](#1-å¼•è¨€)  
   1.1 å¾®æœåŠ¡æ¶æ„æ¼”è¿›èƒŒæ™¯  
   1.2 API ç½‘å…³çš„æ ¸å¿ƒå®šä½  
   1.3 æ–‡æ¡£ç»“æ„è¯´æ˜

2. [æ•´ä½“æ¶æ„æµç¨‹å›¾](#2-æ•´ä½“æ¶æ„æµç¨‹å›¾)  
   2.1 å…¬ç½‘è¯·æ±‚è·¯å¾„æ¦‚è§ˆ  
   2.2 å†…ç½‘æœåŠ¡é€šä¿¡è·¯å¾„æ¦‚è§ˆ

3. [å…¬ç½‘è¯·æ±‚å¤„ç†æµç¨‹è¯¦è§£](#3-å…¬ç½‘è¯·æ±‚å¤„ç†æµç¨‹è¯¦è§£)  
   3.1 DNS è§£æ  
   3.2 CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰  
   3.3 DDoS é˜²æŠ¤ä¸ Web åº”ç”¨é˜²ç«å¢™ï¼ˆWAFï¼‰  
   3.4 å…¬ç½‘è´Ÿè½½å‡è¡¡å™¨ï¼ˆL7 LBï¼‰  
   3.5 Spring Cloud Gatewayï¼ˆAPI ç½‘å…³ï¼‰  
   3.6 è®¤è¯é‰´æƒæœåŠ¡ï¼ˆAuth Serverï¼‰  
   3.7 æœåŠ¡å‘ç°ä¸å†…éƒ¨è´Ÿè½½å‡è¡¡  
   3.8 ç›®æ ‡å¾®æœåŠ¡å®ä¾‹  
   3.9 æ•°æ®ä¾èµ–å±‚ï¼ˆæ•°æ®åº“/ç¼“å­˜/MQï¼‰

4. [å…¸å‹è¯·æ±‚ç¤ºä¾‹åˆ†æï¼šGET /order/123](#4-å…¸å‹è¯·æ±‚ç¤ºä¾‹åˆ†æget-order123)  
   4.1 å®Œæ•´è°ƒç”¨é“¾è·¯åˆ†è§£  
   4.2 å„é˜¶æ®µæ•°æ®æµè½¬ä¸çŠ¶æ€å˜åŒ–

5. [Spring Cloud Gateway æ ¸å¿ƒåŠŸèƒ½è¯¦è§£](#5-spring-cloud-gateway-æ ¸å¿ƒåŠŸèƒ½è¯¦è§£)  
   5.1 è·¯ç”±é…ç½®ï¼ˆRoutingï¼‰  
   5.2 æ–­è¨€ï¼ˆPredicatesï¼‰  
   5.3 è¿‡æ»¤å™¨ï¼ˆFiltersï¼‰  
   5.3.1 å±€éƒ¨è¿‡æ»¤å™¨  
   5.3.2 å…¨å±€è¿‡æ»¤å™¨  
   5.4 é™æµæ§åˆ¶ï¼ˆRate Limitingï¼‰  
   5.5 è¯·æ±‚é‡å†™ä¸å¤´ä¿¡æ¯ç®¡ç†  
   5.6 ç†”æ–­ä¸é™çº§æ”¯æŒï¼ˆé›†æˆ Resilience4jï¼‰  
   5.7 æ—¥å¿—è®°å½•ä¸è®¿é—®å®¡è®¡

6. [è®¤è¯ä¸é‰´æƒ æœºåˆ¶è®¾è®¡](#6-è®¤è¯ä¸é‰´æƒæœºåˆ¶è®¾è®¡)  
   6.1 JWT åŸç†ä¸ç»“æ„  
   6.2 OAuth2 åè®®é›†æˆæ¨¡å¼  
   6.3 è‡ªå®šä¹‰ Token æ ¡éªŒé€»è¾‘  
   6.4 æƒé™ä¸Šä¸‹æ–‡ä¼ é€’ï¼ˆThreadLocal / Reactor Contextï¼‰

7. [æœåŠ¡å‘ç°ä¸å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡](#7-æœåŠ¡å‘ç°ä¸å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡)  
   7.1 æ³¨å†Œä¸­å¿ƒé€‰å‹å¯¹æ¯”ï¼ˆEureka vs Nacos vs Consulï¼‰  
   7.2 Spring Cloud LoadBalancer å®ç°åŸç†  
   7.3 è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ˆRound Robin, Weighted, Randomï¼‰  
   7.4 å¥åº·æ£€æŸ¥æœºåˆ¶

8. [å†…ç½‘å¾®æœåŠ¡é—´é€šä¿¡æœºåˆ¶](#8-å†…ç½‘å¾®æœåŠ¡é—´é€šä¿¡æœºåˆ¶)  
   8.1 Feign Client è°ƒç”¨æµç¨‹  
   8.2 OpenFeign + Ribbon é›†æˆæ–¹å¼  
   8.3 gRPC è·¨è¯­è¨€è°ƒç”¨åœºæ™¯  
   8.4 æœåŠ¡ç½‘æ ¼ï¼ˆIstioï¼‰æ›¿ä»£æ–¹æ¡ˆç®€ä»‹

9. [å®‰å…¨æ€§è®¾è®¡è§„èŒƒ](#9-å®‰å…¨æ€§è®¾è®¡è§„èŒƒ)  
   9.1 ä¼ è¾“å±‚å®‰å…¨ï¼ˆHTTPS / mTLSï¼‰  
   9.2 è¾“å…¥éªŒè¯ä¸å‚æ•°è¿‡æ»¤  
   9.3 é˜²é‡æ”¾æ”»å‡»ä¸æ—¶é—´æˆ³æ ¡éªŒ  
   9.4 æ•æ„Ÿå­—æ®µè„±æ•å¤„ç†  
   9.5 å®‰å…¨å¤´è®¾ç½®ï¼ˆCSP, HSTS, X-Frame-Optionsï¼‰

10. [é«˜å¯ç”¨ä¸æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#10-é«˜å¯ç”¨ä¸æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)  
    10.1 ç½‘å…³é›†ç¾¤éƒ¨ç½²æ¨¡å¼  
    10.2 æ°´å¹³æ‰©å±•ä¸è‡ªåŠ¨æ‰©ç¼©å®¹  
    10.3 è¿æ¥æ± ä¼˜åŒ–ï¼ˆNetty EventLoop é…ç½®ï¼‰  
    10.4 å“åº”å‹ç¼©ä¸ç¼“å­˜ç­–ç•¥  
    10.5 æ€§èƒ½å‹æµ‹å»ºè®®ï¼ˆJMeter / wrkï¼‰

11. [å¯è§‚æµ‹æ€§ä½“ç³»å»ºè®¾](#11-å¯è§‚æµ‹æ€§ä½“ç³»å»ºè®¾)  
    11.1 åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼ˆSleuth + Zipkinï¼‰  
    11.2 æŒ‡æ ‡ç›‘æ§ï¼ˆMicrometer + Prometheusï¼‰  
    11.3 æ—¥å¿—èšåˆï¼ˆELK / Lokiï¼‰  
    11.4 å‘Šè­¦æœºåˆ¶ï¼ˆAlertmanagerï¼‰  
    11.5 ç›‘æ§å¤§ç›˜è®¾è®¡ï¼ˆGrafanaï¼‰

12. [é…ç½®ç®¡ç†ä¸åŠ¨æ€æ›´æ–°](#12-é…ç½®ç®¡ç†ä¸åŠ¨æ€æ›´æ–°)  
    12.1 é…ç½®ä¸­å¿ƒé›†æˆï¼ˆNacos Config / Spring Cloud Configï¼‰  
    12.2 åŠ¨æ€è·¯ç”±åˆ·æ–°æœºåˆ¶  
    12.3 ç°åº¦å‘å¸ƒæ”¯æŒï¼ˆåŸºäº Header æˆ– IP çš„è·¯ç”±åˆ†æµï¼‰

13. [å¸¸è§é—®é¢˜æ’æŸ¥æŒ‡å—](#13-å¸¸è§é—®é¢˜æ’æŸ¥æŒ‡å—)  
    13.1 è·¯ç”±ä¸ç”Ÿæ•ˆåŸå› åˆ†æ  
    13.2 è®¤è¯å¤±è´¥å¸¸è§åœºæ™¯  
    13.3 é™æµå¤±æ•ˆæ’æŸ¥æ­¥éª¤  
    13.4 é«˜å»¶è¿Ÿé—®é¢˜è¯Šæ–­æ–¹æ³•

14. [æœªæ¥æ¼”è¿›æ–¹å‘](#14-æœªæ¥æ¼”è¿›æ–¹å‘)  
    14.1 å‘æœåŠ¡ç½‘æ ¼è¿ç§»å¯è¡Œæ€§  
    14.2 BFFï¼ˆBackend For Frontendï¼‰æ¨¡å¼åº”ç”¨  
    14.3 å¤šç§Ÿæˆ·ç½‘å…³è®¾è®¡æ€è·¯  
    14.4 GraphQL èšåˆç½‘å…³æ¢ç´¢

15. [é™„å½•](#15-é™„å½•)  
    15.1 æœ¯è¯­è¡¨  
    15.2 æ¨èæŠ€æœ¯æ ˆç»„åˆ  
    15.3 å‚è€ƒèµ„æ–™ä¸å®˜æ–¹æ–‡æ¡£é“¾æ¥

---

## 1 å¼•è¨€

### 1.1 å¾®æœåŠ¡æ¶æ„æ¼”è¿›èƒŒæ™¯

éšç€ä¸šåŠ¡å¤æ‚åº¦æå‡ï¼Œå•ä½“åº”ç”¨åœ¨å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§å’Œè¿­ä»£æ•ˆç‡æ–¹é¢é€æ¸æš´éœ²å‡ºç“¶é¢ˆã€‚å¾®æœåŠ¡æ¶æ„é€šè¿‡å°†ç³»ç»Ÿæ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹éƒ¨ç½²çš„æœåŠ¡å•å…ƒï¼Œå®ç°äº†æ¨¡å—è§£è€¦ã€æŠ€æœ¯å¼‚æ„å’Œå›¢é˜Ÿè‡ªæ²»ã€‚ç„¶è€Œï¼ŒæœåŠ¡æ•°é‡çš„å¢é•¿ä¹Ÿå¸¦æ¥äº†æ–°çš„æŒ‘æˆ˜ï¼š

- å¦‚ä½•ç»Ÿä¸€å¯¹å¤–æš´éœ²æ¥å£ï¼Ÿ
- å¦‚ä½•é›†ä¸­ç®¡ç†è®¤è¯ã€é™æµã€æ—¥å¿—ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Ÿ
- å¦‚ä½•ä¿éšœç³»ç»Ÿçš„å®‰å…¨æ€§å’Œç¨³å®šæ€§ï¼Ÿ

åœ¨æ­¤èƒŒæ™¯ä¸‹ï¼Œ**API ç½‘å…³**ä½œä¸ºç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ï¼Œæˆä¸ºå¾®æœåŠ¡æ¶æ„ä¸­ä¸å¯æˆ–ç¼ºçš„ä¸€ç¯ã€‚

### 1.2 API ç½‘å…³çš„æ ¸å¿ƒå®šä½

API ç½‘å…³æ˜¯æ‰€æœ‰å¤–éƒ¨è¯·æ±‚è¿›å…¥ç³»ç»Ÿçš„å”¯ä¸€é€šé“ï¼Œæ‰¿æ‹…ä»¥ä¸‹å…³é”®èŒè´£ï¼š

- **è·¯ç”±è½¬å‘**ï¼šæ ¹æ®è¯·æ±‚è·¯å¾„ã€Header ç­‰æ¡ä»¶å°†è¯·æ±‚åˆ†å‘è‡³å¯¹åº”å¾®æœåŠ¡ã€‚
- **è®¤è¯é‰´æƒ**ï¼šéªŒè¯ç”¨æˆ·èº«ä»½åˆæ³•æ€§ï¼Œé˜²æ­¢æœªæˆæƒè®¿é—®ã€‚
- **æµé‡æ§åˆ¶**ï¼šé˜²æ­¢çªå‘æµé‡å¯¼è‡´æœåŠ¡é›ªå´©ã€‚
- **åè®®è½¬æ¢**ï¼šæ”¯æŒ RESTã€gRPCã€WebSocket ç­‰å¤šç§åè®®æ¥å…¥ã€‚
- **å¯è§‚æµ‹æ€§å¢å¼º**ï¼šç»Ÿä¸€æ”¶é›†æ—¥å¿—ã€æŒ‡æ ‡ã€é“¾è·¯ä¿¡æ¯ã€‚
- **å®‰å…¨é˜²æŠ¤**ï¼šæŠµå¾¡å¸¸è§ Web æ”»å‡»ï¼ˆXSSã€SQL æ³¨å…¥ç­‰ï¼‰ã€‚

Spring Cloud Gateway ä½œä¸º Spring ç”Ÿæ€åŸç”Ÿçš„å“åº”å¼ç½‘å…³æ¡†æ¶ï¼Œå‡­å€Ÿå…¶é«˜æ€§èƒ½ã€æ˜“é›†æˆã€å¯æ‰©å±•æ€§å¼ºç­‰ç‰¹ç‚¹ï¼Œå·²æˆä¸º Java
å¾®æœåŠ¡ç”Ÿæ€ä¸­æœ€ä¸»æµçš„ç½‘å…³è§£å†³æ–¹æ¡ˆä¹‹ä¸€ã€‚

### 1.3 æ–‡æ¡£ç»“æ„è¯´æ˜

æœ¬æ–‡æ¡£å›´ç»• Spring Cloud Gateway
æ„å»ºå®Œæ•´çš„å¾®æœåŠ¡è¾¹ç•Œæ²»ç†ä½“ç³»ï¼Œè¯¦ç»†æè¿°ä»å…¬ç½‘è¯·æ±‚å‘èµ·ï¼Œç»ç”±å¤šå±‚åŸºç¡€è®¾æ–½ç»„ä»¶ï¼Œæœ€ç»ˆåˆ°è¾¾ç›®æ ‡å¾®æœåŠ¡å¹¶è¿”å›ç»“æœçš„å…¨è¿‡ç¨‹ã€‚åŒæ—¶æ¶µç›–å†…ç½‘æœåŠ¡é—´è°ƒç”¨æœºåˆ¶ã€å®‰å…¨æ€§è®¾è®¡ã€ç›‘æ§å‘Šè­¦ç­‰å…³é”®ä¸»é¢˜ï¼Œæ—¨åœ¨ä¸ºæŠ€æœ¯äººå‘˜æä¾›ä¸€å¥—æ ‡å‡†åŒ–ã€å¯è½åœ°çš„æŠ€æœ¯å‚è€ƒæ–¹æ¡ˆã€‚

---

## 2 æ•´ä½“æ¶æ„æµç¨‹å›¾

### 2.1 å…¬ç½‘è¯·æ±‚è·¯å¾„æ¦‚è§ˆ

```
[ç”¨æˆ·] 
   â†“
[DNS è§£æ]
   â†“
[CDNï¼ˆå¯é€‰ï¼‰]
   â†“
[DDoS é˜²æŠ¤ / WAF]
   â†“
[å…¬ç½‘è´Ÿè½½å‡è¡¡å™¨ï¼ˆALB/SLB/Nginxï¼‰]
   â†“
[Spring Cloud Gateway]
   â†“
[è®¤è¯é‰´æƒæœåŠ¡ï¼ˆAuth Serverï¼‰]
   â†“
[æœåŠ¡å‘ç°ï¼ˆNacos/Eurekaï¼‰]
   â†“
[å†…éƒ¨è´Ÿè½½å‡è¡¡ï¼ˆRibbon/LoadBalancerï¼‰]
   â†“
[ç›®æ ‡å¾®æœåŠ¡å®ä¾‹ï¼ˆå¦‚ order-serviceï¼‰]
   â†“
[æ•°æ®åº“ / Redis / Kafka ç­‰ä¾èµ–ç»„ä»¶]
```

> æ‰€æœ‰å¤–éƒ¨æµé‡å¿…é¡»ç»è¿‡ä¸Šè¿°å±‚çº§ï¼Œç¡®ä¿â€œå…ˆæ‹¦æˆªã€å†æ”¾è¡Œâ€çš„å®‰å…¨åŸåˆ™ã€‚

### 2.2 å†…ç½‘æœåŠ¡é€šä¿¡è·¯å¾„æ¦‚è§ˆ

å½“å¾®æœåŠ¡ä¹‹é—´éœ€è¦ç›¸äº’è°ƒç”¨æ—¶ï¼ˆä¾‹å¦‚ payment-service è°ƒç”¨ user-serviceï¼‰ï¼Œæµç¨‹å¦‚ä¸‹ï¼š

```
[è°ƒç”¨æ–¹å¾®æœåŠ¡] 
   â†“
[Feign Client / WebClient]
   â†“
[æœåŠ¡å‘ç°ï¼ˆNacosï¼‰]
   â†“
[å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼ˆSpring Cloud LoadBalancerï¼‰]
   â†“
[è¢«è°ƒç”¨æ–¹å¾®æœåŠ¡]
```

è¯¥è¿‡ç¨‹å‘ç”Ÿåœ¨å†…ç½‘å¯ä¿¡åŒºåŸŸï¼Œä½†ä»éœ€è¿›è¡Œèº«ä»½è¯†åˆ«ä¸æƒé™æ§åˆ¶ã€‚

---

## 3 å…¬ç½‘è¯·æ±‚å¤„ç†æµç¨‹è¯¦è§£

### 3.1 DNS è§£æ

**ä½œç”¨**ï¼šå°†åŸŸåï¼ˆå¦‚ `api.example.com`ï¼‰è§£æä¸ºå…¬ç½‘ IP åœ°å€ï¼Œé€šå¸¸æ˜¯è´Ÿè½½å‡è¡¡å™¨çš„è™šæ‹Ÿ IPã€‚

**å…³é”®æŠ€æœ¯**ï¼š

- æ™ºèƒ½ DNSï¼šæ ¹æ®å®¢æˆ·ç«¯åœ°ç†ä½ç½®é€‰æ‹©æœ€è¿‘çš„æ•°æ®ä¸­å¿ƒï¼Œé™ä½å»¶è¿Ÿã€‚
- DNS è½®è¯¢ï¼šå®ç°ç®€å•çš„è´Ÿè½½å‡è¡¡ã€‚
- TTL æ§åˆ¶ï¼šæ§åˆ¶ç¼“å­˜æ—¶é—´ï¼Œä¾¿äºå¿«é€Ÿåˆ‡æ¢ IPã€‚

**æ¨èå·¥å…·**ï¼šAWS Route53ã€é˜¿é‡Œäº‘äº‘è§£æã€CoreDNSã€‚

---

### 3.2 CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰

**ä½œç”¨**ï¼š

- ç¼“å­˜é™æ€èµ„æºï¼ˆJSã€CSSã€å›¾ç‰‡ã€å­—ä½“æ–‡ä»¶ï¼‰ï¼Œå‡å°‘æºç«™å‹åŠ›ã€‚
- æå‡å…¨çƒç”¨æˆ·çš„è®¿é—®é€Ÿåº¦ã€‚
- æŠµå¾¡éƒ¨åˆ† DDoS æ”»å‡»ï¼ˆè¾¹ç¼˜èŠ‚ç‚¹å¸æ”¶æµé‡ï¼‰ã€‚

**å·¥ä½œæœºåˆ¶**ï¼š

- è‹¥è¯·æ±‚è·¯å¾„åŒ¹é…é™æ€èµ„æºè§„åˆ™ï¼ˆå¦‚ `/static/**`ï¼‰ï¼ŒCDN ç›´æ¥å“åº”ã€‚
- åŠ¨æ€ API è¯·æ±‚ï¼ˆå¦‚ `/api/order/**`ï¼‰ç©¿é€å›æºè‡³åç«¯æœåŠ¡å™¨ã€‚

**æ³¨æ„äº‹é¡¹**ï¼š

- ä¸åº”å¯¹æ•æ„Ÿæ¥å£å¯ç”¨ç¼“å­˜ã€‚
- è®¾ç½®åˆç†çš„ Cache-Control å¤´ä»¥æ§åˆ¶ç¼“å­˜è¡Œä¸ºã€‚

**å¸¸ç”¨å¹³å°**ï¼šCloudflareã€Akamaiã€é˜¿é‡Œäº‘ CDNã€è…¾è®¯äº‘ CDNã€‚

---

### 3.3 DDoS é˜²æŠ¤ä¸ Web åº”ç”¨é˜²ç«å¢™ï¼ˆWAFï¼‰

**ä½œç”¨**ï¼š

- **DDoS é˜²æŠ¤**ï¼šé˜²å¾¡å¤§è§„æ¨¡æµé‡æ”»å‡»ï¼ˆSYN Floodã€UDP Floodã€HTTP Floodï¼‰ã€‚
- **WAF**ï¼šæ£€æµ‹å¹¶é˜»æ–­ Web å±‚æ”»å‡»ï¼ŒåŒ…æ‹¬ï¼š
    - SQL æ³¨å…¥
    - XSSï¼ˆè·¨ç«™è„šæœ¬ï¼‰
    - CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰
    - æ–‡ä»¶åŒ…å«æ¼æ´
    - å‘½ä»¤æ‰§è¡Œ

**éƒ¨ç½²ä½ç½®**ï¼šé€šå¸¸ä½äºå…¬ç½‘ LB ä¹‹å‰ï¼Œä½œä¸ºç¬¬ä¸€é“å®‰å…¨é˜²çº¿ã€‚

**å®ç°æ–¹å¼**ï¼š

- äº‘å‚å•†æä¾›æ‰˜ç®¡æœåŠ¡ï¼ˆå¦‚ AWS Shieldã€é˜¿é‡Œäº‘å®‰éª‘å£«ï¼‰ã€‚
- å¼€æºæ–¹æ¡ˆï¼šModSecurity + OWASP Core Rule Setã€‚

**ä¼˜åŠ¿**ï¼š

- å®æ—¶å¨èƒæƒ…æŠ¥æ›´æ–°ã€‚
- æ”¯æŒè‡ªå®šä¹‰è§„åˆ™å¼•æ“ã€‚
- å¯è§†åŒ–æ”»å‡»æ—¥å¿—ä¸æŠ¥è¡¨ã€‚

---

### 3.4 å…¬ç½‘è´Ÿè½½å‡è¡¡å™¨ï¼ˆL7 LBï¼‰

**ä½œç”¨**ï¼š

- æ¥æ”¶æ¥è‡ªäº’è”ç½‘çš„ HTTPS æµé‡ã€‚
- ç»ˆæ­¢ SSL/TLS åŠ å¯†ï¼ˆå³â€œSSL å¸è½½â€ï¼‰ï¼Œå‡è½»åç«¯æœåŠ¡è´Ÿæ‹…ã€‚
- å°†æ˜æ–‡ HTTP è¯·æ±‚è½¬å‘è‡³åç«¯ç½‘å…³é›†ç¾¤ã€‚
- æ‰§è¡Œå¥åº·æ£€æŸ¥ï¼Œè‡ªåŠ¨å‰”é™¤å¼‚å¸¸èŠ‚ç‚¹ã€‚

**ç±»å‹**ï¼š

- **å››å±‚è´Ÿè½½å‡è¡¡ï¼ˆL4ï¼‰**ï¼šåŸºäº TCP/UDP åè®®è½¬å‘ï¼Œé€Ÿåº¦å¿«ä½†æ— æ³•è§£æ HTTP å†…å®¹ã€‚
- **ä¸ƒå±‚è´Ÿè½½å‡è¡¡ï¼ˆL7ï¼‰**ï¼šå¯è§£æ HTTP Headerã€Hostã€Pathï¼Œæ”¯æŒæ›´ç²¾ç»†çš„è·¯ç”±ç­–ç•¥ã€‚

**å¸¸è§äº§å“**ï¼š

- AWS ALBï¼ˆApplication Load Balancerï¼‰
- é˜¿é‡Œäº‘ SLBï¼ˆServer Load Balancerï¼‰
- Nginx Ingress Controller
- HAProxy

**é…ç½®è¦ç‚¹**ï¼š

- å¯ç”¨ HTTP/2 æ”¯æŒã€‚
- é…ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼ˆconnect timeout, read timeoutï¼‰ã€‚
- å¼€å¯è®¿é—®æ—¥å¿—ç”¨äºå®¡è®¡ã€‚

---

### 3.5 Spring Cloud Gatewayï¼ˆAPI ç½‘å…³ï¼‰

**æ ¸å¿ƒèŒè´£**ï¼š

- è·¯ç”±è½¬å‘ï¼šæ ¹æ®é¢„å®šä¹‰è§„åˆ™å°†è¯·æ±‚å¯¼å‘å…·ä½“å¾®æœåŠ¡ã€‚
- è®¤è¯å‰ç½®ï¼šç»Ÿä¸€å¤„ç†èº«ä»½éªŒè¯ï¼Œé¿å…å„æœåŠ¡é‡å¤å®ç°ã€‚
- é™æµç†”æ–­ï¼šä¿æŠ¤åç«¯æœåŠ¡å…å—è¿‡è½½å½±å“ã€‚
- è¯·æ±‚æ”¹å†™ï¼šæ·»åŠ /åˆ é™¤ Headerã€ä¿®æ”¹è·¯å¾„ã€‚
- æ—¥å¿—åŸ‹ç‚¹ï¼šè®°å½•è®¿é—®æ—¥å¿—ã€æ€§èƒ½æŒ‡æ ‡ã€‚
- åè®®é€‚é…ï¼šæ”¯æŒ WebSocketã€gRPC ç­‰é HTTP åè®®ã€‚

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š

- åŸºäº Spring WebFlux å’Œ Project Reactorï¼Œé‡‡ç”¨éé˜»å¡ I/O æ¨¡å‹ï¼Œå•æœºååèƒ½åŠ›å¼ºã€‚
- æ”¯æŒä¸ Eurekaã€Nacosã€Consul ç­‰æ³¨å†Œä¸­å¿ƒé›†æˆã€‚
- æä¾›ä¸°å¯Œçš„å†…ç½®è¿‡æ»¤å™¨ï¼Œå¹¶æ”¯æŒè‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨ã€‚
- å¯ç»“åˆ Redis å®ç°åˆ†å¸ƒå¼é™æµã€‚

**éƒ¨ç½²å»ºè®®**ï¼š

- è‡³å°‘éƒ¨ç½²ä¸¤ä¸ªå®ä¾‹ï¼Œè·¨å¯ç”¨åŒºåˆ†å¸ƒã€‚
- ä½¿ç”¨ Kubernetes StatefulSet æˆ– Deployment ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€‚
- é…ç½®å°±ç»ªæ¢é’ˆï¼ˆreadinessProbeï¼‰å’Œå­˜æ´»æ¢é’ˆï¼ˆlivenessProbeï¼‰ã€‚

---

### 3.6 è®¤è¯é‰´æƒæœåŠ¡ï¼ˆAuth Serverï¼‰

**ä½œç”¨**ï¼š

- éªŒè¯ JWT æˆ– OAuth2 Token çš„æœ‰æ•ˆæ€§ã€‚
- è¿”å›ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼ˆuser_idã€roleã€tenant_id ç­‰ï¼‰ã€‚
- æ”¯æŒ Token åˆ·æ–°ã€æ³¨é”€ï¼ˆåŠ å…¥é»‘åå•ï¼‰ç­‰åŠŸèƒ½ã€‚

**å®ç°æ–¹å¼**ï¼š

- ä½¿ç”¨ Keycloakã€Auth0 ç­‰æˆç†Ÿå¼€æºæ–¹æ¡ˆã€‚
- è‡ªç ”è½»é‡çº§é‰´æƒæœåŠ¡ï¼Œå¯¹æ¥ä¼ä¸š LDAP/OAuth2 IDPã€‚

**äº¤äº’æµç¨‹**ï¼š

1. ç½‘å…³æå– Authorization å¤´å‘èµ·æ ¡éªŒè¯·æ±‚ï¼›
2. Auth Server è§£æç­¾åã€éªŒè¯è¿‡æœŸæ—¶é—´ã€æŸ¥è¯¢é»‘åå•ï¼›
3. è¿”å›ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯æˆ–é”™è¯¯ç ã€‚

**å®‰å…¨è¦æ±‚**ï¼š

- Token å¿…é¡»ä½¿ç”¨ HS256 æˆ– RS256 ç­¾åç®—æ³•ã€‚
- ç§é’¥ä¸¥æ ¼ä¿å¯†ï¼Œå®šæœŸè½®æ¢ã€‚
- æ”¯æŒçŸ­æ—¶æ•ˆ Token + Refresh Token æœºåˆ¶ã€‚

---

### 3.7 æœåŠ¡å‘ç°ä¸å†…éƒ¨è´Ÿè½½å‡è¡¡

**æœåŠ¡å‘ç°**ï¼š

- å¾®æœåŠ¡å¯åŠ¨æ—¶å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªèº«ä¿¡æ¯ï¼ˆIPã€ç«¯å£ã€å…ƒæ•°æ®ï¼‰ã€‚
- ç½‘å…³å®šæœŸæ‹‰å–æœåŠ¡å®ä¾‹åˆ—è¡¨ï¼Œæ„ŸçŸ¥æ–°å¢æˆ–ä¸‹çº¿èŠ‚ç‚¹ã€‚

**å¸¸ç”¨æ³¨å†Œä¸­å¿ƒå¯¹æ¯”**ï¼š

| æ³¨å†Œä¸­å¿ƒ   | CAP ç‰¹æ€§    | é…ç½®ç®¡ç† | å¥åº·æ£€æŸ¥        | é€‚ç”¨åœºæ™¯       |
|--------|-----------|------|-------------|------------|
| Eureka | AP        | å¦    | å¿ƒè·³æœºåˆ¶        | Netflix ç”Ÿæ€ |
| Nacos  | AP/CP å¯åˆ‡æ¢ | æ˜¯    | TCP/HTTP/å¿ƒè·³ | é˜¿é‡Œç³»ã€æ··åˆäº‘    |
| Consul | CP        | æ˜¯    | å¤šç§æ¢æµ‹æ–¹å¼      | å¤šæ•°æ®ä¸­å¿ƒ      |

**å†…éƒ¨è´Ÿè½½å‡è¡¡**ï¼š

- Spring Cloud Gateway é»˜è®¤ä½¿ç”¨ `Spring Cloud LoadBalancer`ã€‚
- æ”¯æŒè½®è¯¢ï¼ˆRound Robinï¼‰ã€éšæœºï¼ˆRandomï¼‰ã€æƒé‡ï¼ˆWeightedï¼‰ç­‰ç­–ç•¥ã€‚
- æ”¯æŒé‡è¯•æœºåˆ¶ï¼ˆRetryableRoutePredicateFactoryï¼‰ã€‚

---

### 3.8 ç›®æ ‡å¾®æœåŠ¡å®ä¾‹

**å®šä¹‰**ï¼šå®é™…å¤„ç†ä¸šåŠ¡é€»è¾‘çš„å¾®æœåŠ¡è¿›ç¨‹ï¼Œå¦‚è®¢å•æœåŠ¡ã€ç”¨æˆ·æœåŠ¡ã€æ”¯ä»˜æœåŠ¡ç­‰ã€‚

**è¿è¡Œç¯å¢ƒ**ï¼š

- Kubernetes Pod
- è™šæ‹Ÿæœºï¼ˆVMï¼‰
- å®¹å™¨ç¼–æ’å¹³å°ï¼ˆDocker Swarmï¼‰

**é€šä¿¡åè®®**ï¼š

- HTTP/RESTï¼ˆæœ€å¸¸è§ï¼‰
- gRPCï¼ˆé«˜æ€§èƒ½ã€è·¨è¯­è¨€ï¼‰
- æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¼‚æ­¥è§£è€¦ï¼‰

**å¼€å‘æ¡†æ¶**ï¼š

- Spring Boot
- Go Micro
- Node.js Express

**å…³é”®è¦æ±‚**ï¼š

- å®ç°å¥åº·æ£€æŸ¥æ¥å£ï¼ˆ`/actuator/health`ï¼‰ã€‚
- æ”¯æŒä¼˜é›…åœæœºã€‚
- è¾“å‡ºç»“æ„åŒ–æ—¥å¿—ã€‚

---

### 3.9 æ•°æ®ä¾èµ–å±‚ï¼ˆæ•°æ®åº“/ç¼“å­˜/MQï¼‰

**ç»„æˆ**ï¼š

- **å…³ç³»å‹æ•°æ®åº“**ï¼šMySQLã€PostgreSQLã€Oracle
- **NoSQL æ•°æ®åº“**ï¼šMongoDBã€Cassandra
- **ç¼“å­˜ç³»ç»Ÿ**ï¼šRedisã€Memcached
- **æ¶ˆæ¯ä¸­é—´ä»¶**ï¼šKafkaã€RabbitMQã€RocketMQ

**å®‰å…¨ç­–ç•¥**ï¼š

- æ‰€æœ‰æ•°æ®åº“ä½äºå†…ç½‘éš”ç¦»åŒºï¼Œç¦æ­¢å…¬ç½‘è®¿é—®ã€‚
- ä½¿ç”¨ä¸“ç”¨è´¦å·è¿æ¥ï¼Œæœ€å°æƒé™åŸåˆ™ã€‚
- æ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨ï¼ˆå¦‚å¯†ç ã€èº«ä»½è¯å·ï¼‰ã€‚

**æ€§èƒ½ä¼˜åŒ–**ï¼š

- æŸ¥è¯¢èµ°ç´¢å¼•ï¼Œé¿å…å…¨è¡¨æ‰«æã€‚
- Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼Œè®¾ç½®åˆç†è¿‡æœŸæ—¶é—´ã€‚
- æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°å¡«è°·ï¼Œå¼‚æ­¥å¤„ç†è€—æ—¶ä»»åŠ¡ã€‚

---

## 4 å…¸å‹è¯·æ±‚ç¤ºä¾‹åˆ†æï¼šGET /order/123

### 4.1 å®Œæ•´è°ƒç”¨é“¾è·¯åˆ†è§£

```http
GET https://api.example.com/order/123 HTTP/1.1
Host: api.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Accept: application/json
```

#### æ­¥éª¤ 1ï¼šDNS è§£æ

- `api.example.com` â†’ è§£æä¸º ALB çš„å…¬ç½‘ IPï¼ˆå¦‚ 203.0.113.10ï¼‰

#### æ­¥éª¤ 2ï¼šWAF æ£€æŸ¥

- æ£€æµ‹æ˜¯å¦å­˜åœ¨æ¶æ„ Payloadï¼Œè‹¥æ— åˆ™æ”¾è¡Œã€‚

#### æ­¥éª¤ 3ï¼šå…¬ç½‘ LB ç»ˆæ­¢ HTTPS

- ä½¿ç”¨è¯ä¹¦è§£å¯† TLSï¼Œå¾—åˆ°æ˜æ–‡ HTTP è¯·æ±‚ã€‚
- è½¬å‘è‡³ Spring Cloud Gateway é›†ç¾¤ã€‚

#### æ­¥éª¤ 4ï¼šç½‘å…³å¤„ç†

- åŒ¹é…è·¯ç”±è§„åˆ™ï¼š`Path=/order/**` â†’ è½¬å‘è‡³ `ORDER-SERVICE`
- æå– Token å¹¶è°ƒç”¨ Auth Server éªŒè¯
- æ‰§è¡Œé™æµåˆ¤æ–­ï¼ˆæ¯ç§’æœ€å¤š 10 æ¬¡ï¼‰
- æ·»åŠ è¯·æ±‚å¤´ï¼š`X-User-ID=u123`, `X-Request-ID=abc-123`

#### æ­¥éª¤ 5ï¼šæœåŠ¡å‘ç°

- æŸ¥è¯¢ Nacos è·å– `ORDER-SERVICE` å®ä¾‹åˆ—è¡¨ï¼š
    - `http://10.0.1.10:8080`ï¼ˆå¥åº·ï¼‰
    - `http://10.0.1.11:8080`ï¼ˆå¥åº·ï¼‰

#### æ­¥éª¤ 6ï¼šè´Ÿè½½å‡è¡¡é€‰æ‹©å®ä¾‹

- ä½¿ç”¨è½®è¯¢ç­–ç•¥é€‰æ‹© `10.0.1.10:8080`

#### æ­¥éª¤ 7ï¼šå¾®æœåŠ¡å¤„ç†

- æ¥æ”¶è¯·æ±‚ï¼š`GET /order/123`
- æ£€æŸ¥ç¼“å­˜ï¼šRedis ä¸­æ˜¯å¦å­˜åœ¨ `order:123`
- è‹¥ä¸å­˜åœ¨ï¼ŒæŸ¥è¯¢ MySQL ä¸»åº“
- è¿”å› JSON å“åº”

#### æ­¥éª¤ 8ï¼šå“åº”è¿”å›

- ç½‘å…³è®°å½•æ—¥å¿—ã€ä¸ŠæŠ¥æŒ‡æ ‡
- LB é‡æ–°åŠ å¯†ä¸º HTTPS
- è¿”å›å®¢æˆ·ç«¯

---

## 5 Spring Cloud Gateway æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### 5.1 è·¯ç”±é…ç½®ï¼ˆRoutingï¼‰

è·¯ç”±æ˜¯ç½‘å…³æœ€åŸºæœ¬çš„å•å…ƒï¼Œå®šä¹‰äº†â€œä»€ä¹ˆè¯·æ±‚ â†’ è½¬å‘åˆ°å“ªé‡Œâ€ã€‚

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: order-service-route
          uri: lb://ORDER-SERVICE
          predicates:
            - Path=/order/**
            - Method=GET,POST
            - Header=Content-Type,application/json
          filters:
            - StripPrefix=1
            - AddRequestHeader=X-Source,GATEWAY
```

- `uri`: `lb://` è¡¨ç¤ºä½¿ç”¨æœåŠ¡å‘ç°ï¼›`http://` è¡¨ç¤ºå›ºå®šåœ°å€ã€‚
- `predicates`: åŒ¹é…æ¡ä»¶ï¼Œå…¨éƒ¨æ»¡è¶³æ‰è§¦å‘è·¯ç”±ã€‚
- `filters`: è¯·æ±‚/å“åº”å¤„ç†é€»è¾‘ã€‚

---

### 5.2 æ–­è¨€ï¼ˆPredicatesï¼‰

æ–­è¨€å†³å®šæ˜¯å¦åº”ç”¨æŸæ¡è·¯ç”±ã€‚å¸¸ç”¨å†…ç½®æ–­è¨€ï¼š

| æ–­è¨€     | ç¤ºä¾‹                          | è¯´æ˜          |
|--------|-----------------------------|-------------|
| Path   | `- Path=/user/**`           | è·¯å¾„åŒ¹é…        |
| Method | `- Method=GET,POST`         | è¯·æ±‚æ–¹æ³•é™åˆ¶      |
| Header | `- Header=Authorization,.+` | å­˜åœ¨æŸä¸ª Header |
| Host   | `- Host=**.example.com`     | åŸŸååŒ¹é…        |
| Query  | `- Query=name`              | åŒ…å«æŒ‡å®šæŸ¥è¯¢å‚æ•°    |
| Cookie | `- Cookie=session,id123`    | åŒ¹é… Cookie   |

---

### 5.3 è¿‡æ»¤å™¨ï¼ˆFiltersï¼‰

#### 5.3.1 å±€éƒ¨è¿‡æ»¤å™¨ï¼ˆGatewayFilterï¼‰

ä»…ä½œç”¨äºç‰¹å®šè·¯ç”±ã€‚

```yaml
filters:
  - StripPrefix=1           # å»æ‰ç¬¬ä¸€çº§è·¯å¾„
  - AddRequestHeader=X-Trace-Id,{requestId}
  - RewritePath=/foo/(?<path>.*), /$\{path}
```

#### 5.3.2 å…¨å±€è¿‡æ»¤å™¨ï¼ˆGlobalFilterï¼‰

å¯¹æ‰€æœ‰è¯·æ±‚ç”Ÿæ•ˆï¼Œå¸¸ç”¨äºè®¤è¯ã€æ—¥å¿—ç­‰é€šç”¨é€»è¾‘ã€‚

```java

@Component
public class AuthenticationFilter implements GlobalFilter, Ordered {
	@Override
	public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
		// è®¤è¯é€»è¾‘
		return chain.filter(exchange);
	}

	@Override
	public int getOrder() {
		return -1; // ä¼˜å…ˆæ‰§è¡Œ
	}
}
```

---

### 5.4 é™æµæ§åˆ¶ï¼ˆRate Limitingï¼‰

åŸºäº Redis å®ç°åˆ†å¸ƒå¼ä»¤ç‰Œæ¡¶ç®—æ³•ã€‚

```yaml
filters:
  - name: RequestRateLimiter
    args:
      redis-rate-limiter.replenishRate: 10   # æ¯ç§’è¡¥å……10ä¸ªä»¤ç‰Œ
      redis-rate-limiter.burstCapacity: 20   # æœ€å¤§å®¹é‡20
      key-resolver: "#{@apiKeyResolver}"     # é™æµç»´åº¦ï¼ˆIP/UserIDï¼‰
```

```java

@Bean
public KeyResolver apiKeyResolver() {
	return exchange -> Mono.just(
			exchange.getRequest().getRemoteAddress().getHostName()
	);
}
```

---

### 5.5 è¯·æ±‚é‡å†™ä¸å¤´ä¿¡æ¯ç®¡ç†

- ä¿®æ”¹è·¯å¾„ï¼š`RewritePath`
- æ·»åŠ  Headerï¼š`AddRequestHeader`
- åˆ é™¤ Headerï¼š`RemoveRequestHeader`
- è®¾ç½®å“åº”å¤´ï¼š`AddResponseHeader`

---

### 5.6 ç†”æ–­ä¸é™çº§æ”¯æŒï¼ˆé›†æˆ Resilience4jï¼‰

```yaml
filters:
  - name: CircuitBreaker
    args:
      name: orderServiceCB
      fallbackUri: forward:/fallback/order
```

é…åˆ Resilience4j é…ç½®è¶…æ—¶ã€é”™è¯¯ç‡é˜ˆå€¼ï¼Œè§¦å‘ç†”æ–­åè¿”å›é»˜è®¤å€¼æˆ–é”™è¯¯é¡µã€‚

---

### 5.7 æ—¥å¿—è®°å½•ä¸è®¿é—®å®¡è®¡

å¯ç”¨è®¿é—®æ—¥å¿—ï¼š

```yaml
logging:
  level:
    org.springframework.cloud.gateway: DEBUG
```

æˆ–ä½¿ç”¨è‡ªå®šä¹‰è¿‡æ»¤å™¨è¾“å‡ºç»“æ„åŒ–æ—¥å¿—ï¼š

```json
{
  "timestamp": "2025-04-05T10:00:00Z",
  "method": "GET",
  "path": "/order/123",
  "client_ip": "1.2.3.4",
  "user_id": "u123",
  "status": 200,
  "latency_ms": 45
}
```

## 6 è®¤è¯ä¸é‰´æƒæœºåˆ¶è®¾è®¡

åœ¨ç°ä»£å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡è¾¹ç•Œæ¨¡ç³Šã€è°ƒç”¨é“¾è·¯å¤æ‚ï¼Œä¼ ç»Ÿçš„ä¼šè¯ç®¡ç†æ–¹å¼å·²æ— æ³•æ»¡è¶³é«˜å¹¶å‘ã€åˆ†å¸ƒå¼åœºæ™¯ä¸‹çš„èº«ä»½éªŒè¯éœ€æ±‚ã€‚Spring Cloud Gateway ä½œä¸ºç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ï¼Œæ‰¿æ‹…ç€â€œç¬¬ä¸€é“é˜²çº¿â€çš„èŒè´£ï¼Œå¿…é¡»å®ç°**é«˜æ•ˆã€å®‰å…¨ã€å¯æ‰©å±•çš„èº«ä»½è®¤è¯ä¸æƒé™æ§åˆ¶æœºåˆ¶**ã€‚
æœ¬ç« å°†ä»ç†è®ºåŸºç¡€åˆ°å·¥ç¨‹å®è·µï¼Œè¯¦ç»†é˜è¿°åŸºäº **JWT** å’Œ **OAuth2** çš„è®¤è¯ä½“ç³»å¦‚ä½•åœ¨ Spring Cloud Gateway ä¸­è½åœ°ï¼Œå¹¶æä¾›å®Œæ•´çš„å®‰å…¨æ€§ä¿éšœæ–¹æ¡ˆã€‚

---

### 6.1 JWT åŸç†ä¸ç»“æ„è¯¦è§£

#### 6.1.1 ä»€ä¹ˆæ˜¯ JWTï¼Ÿ

JSON Web Tokenï¼ˆJWTï¼‰æ˜¯ä¸€ç§å¼€æ”¾æ ‡å‡†ï¼ˆ[RFC 7519](https://datatracker.ietf.org/doc/html/rfc7519)ï¼‰ï¼Œç”¨äºåœ¨ç½‘ç»œåº”ç”¨ä¹‹é—´ä»¥ JSON æ ¼å¼å®‰å…¨åœ°ä¼ è¾“å£°æ˜ä¿¡æ¯ï¼ˆclaimsï¼‰ã€‚å®ƒæ˜¯ä¸€ä¸ªè‡ªåŒ…å«çš„ä»¤ç‰Œï¼Œæ— éœ€æœåŠ¡ç«¯å­˜å‚¨çŠ¶æ€å³å¯å®Œæˆèº«ä»½éªŒè¯ã€‚

å…¸å‹ JWT ç»“æ„å¦‚ä¸‹ï¼š

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9
.
eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJleHAiOjE1MTYyNDI2MjIsInJvbGVzIjpbIlVTRVIiXX0
.
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```

ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œç”¨ `.` åˆ†éš”ï¼š

| éƒ¨åˆ† | å†…å®¹ |
|------|------|
| **Header** | ç­¾åç®—æ³•ï¼ˆalgï¼‰ã€ä»¤ç‰Œç±»å‹ï¼ˆtypï¼‰ |
| **Payload** | ç”¨æˆ·æ ‡è¯†ã€è§’è‰²ã€è¿‡æœŸæ—¶é—´ç­‰å£°æ˜ï¼ˆclaimsï¼‰ |
| **Signature** | ä½¿ç”¨å¯†é’¥å¯¹å‰ä¸¤éƒ¨åˆ†è¿›è¡Œç­¾åï¼Œé˜²æ­¢ç¯¡æ”¹ |

#### 6.1.2 Header è§£æ

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

- `alg`ï¼šè¡¨ç¤ºç­¾åæ‰€ä½¿ç”¨çš„ç®—æ³•ï¼Œå¸¸è§æœ‰ï¼š
    - `HS256`ï¼šHMAC + SHA-256ï¼ˆå¯¹ç§°åŠ å¯†ï¼‰
    - `RS256`ï¼šRSA + SHA-256ï¼ˆéå¯¹ç§°åŠ å¯†ï¼‰
- `typ`ï¼šå›ºå®šä¸º `"JWT"`ã€‚

#### 6.1.3 Payload å¸¸è§å£°æ˜ï¼ˆClaimsï¼‰

JWT æ”¯æŒå¤šç§é¢„å®šä¹‰çš„æ ‡å‡†å£°æ˜å’Œè‡ªå®šä¹‰å£°æ˜ï¼š

| å£°æ˜ | å«ä¹‰ | æ˜¯å¦å¿…éœ€ |
|------|------|----------|
| `iss` (Issuer) | ç­¾å‘è€… | å¦ |
| `sub` (Subject) | ä¸»ä½“ï¼ˆé€šå¸¸æ˜¯ç”¨æˆ·IDï¼‰ | æ˜¯ |
| `aud` (Audience) | æ¥æ”¶æ–¹ | å¦ |
| `exp` (Expiration Time) | è¿‡æœŸæ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰ | å¼ºçƒˆå»ºè®® |
| `nbf` (Not Before) | ç”Ÿæ•ˆæ—¶é—´ | å¦ |
| `iat` (Issued At) | ç­¾å‘æ—¶é—´ | å»ºè®® |
| `jti` (JWT ID) | å”¯ä¸€IDï¼Œé˜²é‡æ”¾æ”»å‡» | å¯é€‰ä½†æ¨è |

> âš ï¸ æ³¨æ„ï¼šPayload æ˜¯ Base64 ç¼–ç è€ŒéåŠ å¯†ï¼Œ**ä¸åº”å­˜æ”¾æ•æ„Ÿä¿¡æ¯**ï¼ˆå¦‚å¯†ç ã€èº«ä»½è¯å·ï¼‰ã€‚

ç¤ºä¾‹ Payloadï¼š
```json
{
  "sub": "u12345",
  "name": "å¼ ä¸‰",
  "email": "zhangsan@example.com",
  "roles": ["USER", "PREMIUM"],
  "tenantId": "t-001",
  "iat": 1743600000,
  "exp": 1743603600
}
```

#### 6.1.4 Signature ç”Ÿæˆè¿‡ç¨‹

ç­¾åæ˜¯å¯¹å‰ä¸¤æ®µå­—ç¬¦ä¸²æ‹¼æ¥åä½¿ç”¨æŒ‡å®šç®—æ³•å’Œå¯†é’¥ç”Ÿæˆçš„å“ˆå¸Œå€¼ï¼š

```
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secret)
```

åªæœ‰æŒæœ‰ç›¸åŒå¯†é’¥çš„æœåŠ¡æ‰èƒ½éªŒè¯è¯¥ç­¾åçš„æœ‰æ•ˆæ€§ã€‚

---

### 6.2 JWT åœ¨ Spring Cloud Gateway ä¸­çš„åº”ç”¨æ¨¡å¼

#### 6.2.1 ç½‘å…³ä½œä¸º Token éªŒè¯ä¸­å¿ƒ

Spring Cloud Gateway ä¸åº”ç­¾å‘ Tokenï¼Œä½†åº”è´Ÿè´£éªŒè¯å…¶åˆæ³•æ€§ã€‚å…¸å‹çš„å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š

```
å®¢æˆ·ç«¯ â†’ Gateway â†’ è§£æ Authorization å¤´ â†’ éªŒè¯ç­¾å â†’ æ£€æŸ¥æ˜¯å¦è¿‡æœŸ â†’ æŸ¥è¯¢é»‘åå• â†’ è½¬å‘è¯·æ±‚
```

##### âœ… ä¼˜åŠ¿ï¼š
- æ‰€æœ‰å¾®æœåŠ¡æ— éœ€é‡å¤å®ç°è®¤è¯é€»è¾‘ã€‚
- ç»Ÿä¸€æ‹¦æˆªéæ³•è¯·æ±‚ï¼Œé™ä½åç«¯å‹åŠ›ã€‚
- æ˜“äºé›†ä¸­ç®¡ç†é»‘ç™½åå•ã€é™æµè§„åˆ™ã€‚

##### âŒ æŒ‘æˆ˜ï¼š
- è‹¥é‡‡ç”¨åŒæ­¥è¿œç¨‹æ ¡éªŒï¼ˆå¦‚è°ƒç”¨ `/introspect`ï¼‰ï¼Œå¯èƒ½å¼•å…¥å»¶è¿Ÿã€‚
- å¯†é’¥ç®¡ç†éœ€è°¨æ…ï¼Œé¿å…æ³„éœ²ã€‚

---

#### 6.2.2 å¯¹ç§°åŠ å¯† vs éå¯¹ç§°åŠ å¯†é€‰å‹

| ç‰¹æ€§ | HS256ï¼ˆå¯¹ç§°ï¼‰ | RS256ï¼ˆéå¯¹ç§°ï¼‰ |
|------|----------------|------------------|
| å¯†é’¥æ•°é‡ | 1ä¸ªå…±äº«å¯†é’¥ | å…¬é’¥+ç§é’¥ |
| å®‰å…¨æ€§ | è¾ƒä½ï¼ˆæ‰€æœ‰æœåŠ¡å…±äº«å¯†é’¥ï¼‰ | é«˜ï¼ˆä»…æˆæƒæœåŠ¡å™¨æŒæœ‰ç§é’¥ï¼‰ |
| æ€§èƒ½ | å¿«ï¼ˆæœ¬åœ°è§£æï¼‰ | ç¨æ…¢ï¼ˆRSA è®¡ç®—å¼€é”€å¤§ï¼‰ |
| é€‚ç”¨åœºæ™¯ | å†…éƒ¨å¯ä¿¡ç³»ç»Ÿ | ç¬¬ä¸‰æ–¹å¼€æ”¾å¹³å°ã€å¤šç§Ÿæˆ· SaaS |

> **æ¨èé€‰æ‹©**ï¼šç”Ÿäº§ç¯å¢ƒä¼˜å…ˆä½¿ç”¨ **RS256**ï¼Œæå‡æ•´ä½“å®‰å…¨æ€§ã€‚

##### ç¤ºä¾‹é…ç½®ï¼ˆRS256ï¼‰ï¼š
```java
@Bean
public JwtDecoder jwtDecoder() {
    return NimbusJwtDecoder.withPublicKey(rsaPublicKey()).build();
}
```

---

#### 6.2.3 Token é»‘åå•æœºåˆ¶ï¼ˆæ³¨é”€æ”¯æŒï¼‰

JWT å¤©ç„¶æ— çŠ¶æ€ï¼Œä¸€æ—¦ç­¾å‘éš¾ä»¥ä¸»åŠ¨å¤±æ•ˆã€‚ä¸ºæ­¤éœ€å¼•å…¥**é»‘åå•æœºåˆ¶**æ¥æ”¯æŒç™»å‡ºåŠŸèƒ½ã€‚

##### å®ç°æ–¹å¼ï¼š
- å°†å·²æ³¨é”€ Token çš„ `jti` æˆ– `sub+exp` å­˜å…¥ Redisã€‚
- è®¾ç½® TTL = å‰©ä½™æœ‰æ•ˆæœŸã€‚
- ç½‘å…³åœ¨éªŒè¯æ—¶æŸ¥è¯¢ Redis æ˜¯å¦å­˜åœ¨è¯¥ Tokenã€‚

```java
@Component
public class JwtBlacklistChecker {

    @Autowired
    private StringRedisTemplate redisTemplate;

    public boolean isTokenBlacklisted(String jti) {
        return Boolean.TRUE.equals(redisTemplate.hasKey("blacklist:token:" + jti));
    }

    public void addToBlacklist(String jti, long expirationSeconds) {
        redisTemplate.opsForValue().set(
            "blacklist:token:" + jti,
            "invalid",
            Duration.ofSeconds(expirationSeconds)
        );
    }
}
```

> ğŸ’¡ æ›¿ä»£æ–¹æ¡ˆï¼šä½¿ç”¨çŸ­æœŸ Token + Refresh Token æœºåˆ¶ï¼Œå‡å°‘å¯¹é»‘åå•çš„ä¾èµ–ã€‚

---

### 6.3 OAuth2 åè®®æ·±åº¦é›†æˆ

#### 6.3.1 OAuth2 æ ¸å¿ƒè§’è‰²

| è§’è‰² | è¯´æ˜ |
|------|------|
| Resource Owner | ç”¨æˆ· |
| Client | å®¢æˆ·ç«¯åº”ç”¨ï¼ˆå¦‚å‰ç«¯ã€ç§»åŠ¨Appï¼‰ |
| Authorization Server | è´Ÿè´£è®¤è¯å¹¶å‘æ”¾ Tokenï¼ˆå¦‚ Keycloakï¼‰ |
| Resource Server | æä¾›å—ä¿æŠ¤èµ„æºçš„æœåŠ¡ï¼ˆå¦‚è®¢å•æœåŠ¡ï¼‰ |

#### 6.3.2 æˆæƒæ¨¡å¼è¯¦è§£

| æ¨¡å¼ | æµç¨‹ç®€è¿° | é€‚ç”¨åœºæ™¯ | å®‰å…¨ç­‰çº§ |
|------|--------|----------|----------|
| **Authorization Code** | ç”¨æˆ·ç™»å½• â†’ è·å– code â†’ æ¢å– token | Web åº”ç”¨ã€å‰åç«¯åˆ†ç¦» | â˜…â˜…â˜…â˜…â˜… |
| **Client Credentials** | å®¢æˆ·ç«¯å‡­æ®ç›´æ¥æ¢å– token | æœåŠ¡é—´è°ƒç”¨ | â˜…â˜…â˜…â˜…â˜† |
| **Resource Owner Password Credentials** | ç”¨æˆ·åå¯†ç ç›´ä¼ æ¢å– token | å†…éƒ¨å¯ä¿¡å®¢æˆ·ç«¯ | â˜…â˜…â˜†â˜†â˜† |
| **Implicit** | ç›´æ¥è¿”å› tokenï¼ˆä¸æ¨èï¼‰ | æ—§ç‰ˆ SPA åº”ç”¨ | â˜…â˜†â˜†â˜†â˜† |

> ğŸ›‘ **æ³¨æ„**ï¼š`password` æ¨¡å¼å’Œ `implicit` æ¨¡å¼å·²è¢« OAuth 2.1 æ ‡è®°ä¸ºåºŸå¼ƒï¼Œæ–°é¡¹ç›®åº”é¿å…ä½¿ç”¨ã€‚

---

#### 6.3.3 ç½‘å…³é›†æˆ OAuth2 Introspection

å¯¹äºä¸æ”¯æŒæœ¬åœ°è§£æ JWT çš„åœºæ™¯ï¼ˆä¾‹å¦‚ä½¿ç”¨å¤–éƒ¨ IdPï¼‰ï¼Œå¯é€šè¿‡ **Token Introspection** æ¥å£éªŒè¯ Tokenã€‚

##### è¯·æ±‚ç¤ºä¾‹ï¼š
```http
POST /oauth2/introspect HTTP/1.1
Host: auth-server.example.com
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW
Content-Type: application/x-www-form-urlencoded

token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

##### æˆåŠŸå“åº”ï¼š
```json
{
  "active": true,
  "scope": "read write profile",
  "client_id": "gateway-client",
  "username": "user123",
  "token_type": "bearer",
  "exp": 1743609600,
  "iat": 1743606000,
  "sub": "u12345",
  "aud": "resource-server"
}
```

##### å¤±è´¥å“åº”ï¼š
```json
{ "active": false }
```

##### Java å®ç°ï¼ˆWebClient è°ƒç”¨ï¼‰ï¼š
```java
@Service
public class OAuth2Introspector {

    private final WebClient webClient;

    public OAuth2Introspector(WebClient.Builder webClientBuilder) {
        this.webClient = webClientBuilder.build();
    }

    public Mono<Map<String, Object>> introspect(String token) {
        return webClient.post()
            .uri("https://auth.example.com/oauth2/introspect")
            .headers(h -> h.setBasicAuth("client-id", "client-secret"))
            .bodyValue("token=" + token)
            .retrieve()
            .bodyToMono(new ParameterizedTypeReference<Map<String, Object>>() {})
            .onErrorReturn(Collections.emptyMap())
            .filter(response -> Boolean.TRUE.equals(response.get("active")))
            .timeout(Duration.ofSeconds(3));
    }
}
```

> âš ï¸ æ€§èƒ½æç¤ºï¼šé¢‘ç¹è°ƒç”¨ introspection æ¥å£ä¼šå½±å“ååé‡ï¼Œå»ºè®®ç»“åˆæœ¬åœ°ç¼“å­˜ï¼ˆCaffeine + TTLï¼‰ä¼˜åŒ–ã€‚

---

### 6.4 è‡ªå®šä¹‰å…¨å±€è®¤è¯è¿‡æ»¤å™¨ï¼ˆå®Œæ•´å®ç°ï¼‰

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„è®¤è¯è¿‡æ»¤å™¨ç¤ºä¾‹ï¼Œæ”¯æŒ JWT è§£æã€é»‘åå•æ£€æŸ¥ã€ä¸Šä¸‹æ–‡æ³¨å…¥ã€å¼‚å¸¸å¤„ç†ã€‚

```java
@Component
@RequiredArgsConstructor
public class AuthenticationFilter implements GlobalFilter, Ordered {

    private final JwtUtil jwtUtil;           // JWT å·¥å…·ç±»
    private final BlacklistService blacklistService;  // é»‘åå•æœåŠ¡

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        String path = request.getURI().getPath();

        // ç™½åå•è·¯å¾„è·³è¿‡è®¤è¯
        if (isPublicEndpoint(path)) {
            return chain.filter(exchange);
        }

        String authToken = extractToken(request);
        if (authToken == null) {
            return unauthorized(exchange, "Missing Authorization header");
        }

        try {
            // 1. è§£æ Token
            Claims claims = jwtUtil.parseToken(authToken);
            String jti = claims.getId();
            String subject = claims.getSubject();

            // 2. æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            Date expiration = claims.getExpiration();
            if (new Date().after(expiration)) {
                return forbidden(exchange, "Token expired");
            }

            // 3. æ£€æŸ¥é»‘åå•
            if (blacklistService.isTokenBlacklisted(jti)) {
                return forbidden(exchange, "Token has been revoked");
            }

            // 4. æ³¨å…¥ç”¨æˆ·ä¸Šä¸‹æ–‡åˆ° Reactor Context
            return chain.filter(exchange)
                .contextWrite(Context.of(
                    "userId", subject,
                    "username", claims.get("username", String.class),
                    "roles", claims.get("roles", List.class),
                    "tenantId", claims.get("tenantId", String.class)
                ));

        } catch (ExpiredJwtException e) {
            return forbidden(exchange, "Token expired");
        } catch (MalformedJwtException | SignatureException e) {
            return forbidden(exchange, "Invalid token signature");
        } catch (Exception e) {
            return internalError(exchange, "Authentication failed: " + e.getMessage());
        }
    }

    private String extractToken(ServerHttpRequest request) {
        String bearerToken = request.getHeaders().getFirst(HttpHeaders.AUTHORIZATION);
        if (bearerToken != null && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }

    private boolean isPublicEndpoint(String path) {
        return Stream.of("/login", "/register", "/actuator/health", "/oauth/token")
                     .anyMatch(path::startsWith);
    }

    private Mono<Void> unauthorized(ServerWebExchange exchange, String message) {
        return setResponse(exchange, HttpStatus.UNAUTHORIZED, message);
    }

    private Mono<Void> forbidden(ServerWebExchange exchange, String message) {
        return setResponse(exchange, HttpStatus.FORBIDDEN, message);
    }

    private Mono<Void> internalError(ServerWebExchange exchange, String message) {
        return setResponse(exchange, HttpStatus.INTERNAL_SERVER_ERROR, message);
    }

    private Mono<Void> setResponse(ServerWebExchange exchange, HttpStatus status, String message) {
        ServerHttpResponse response = exchange.getResponse();
        response.setStatusCode(status);
        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);

        ObjectMapper mapper = new ObjectMapper();
        byte[] bytes;
        try {
            bytes = mapper.writeValueAsBytes(Map.of("error", message, "status", status.value()));
        } catch (JsonProcessingException e) {
            bytes = "{\"error\":\"Internal error\"}".getBytes(StandardCharsets.UTF_8);
        }

        DataBuffer buffer = response.bufferFactory().wrap(bytes);
        return response.writeWith(Mono.just(buffer));
    }

    @Override
    public int getOrder() {
        return -1; // æœ€å…ˆæ‰§è¡Œ
    }
}
```

---

### 6.5 æƒé™ä¸Šä¸‹æ–‡ä¼ é€’æœºåˆ¶å¯¹æ¯”

| æ–¹å¼ | è¯´æ˜ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|----------|
| **Reactor Context** | Reactor åŸç”Ÿä¸Šä¸‹æ–‡ä¼ é€’æœºåˆ¶ | ç±»å‹å®‰å…¨ã€å¼‚æ­¥å‹å¥½ | ä»…é™å½“å‰çº¿ç¨‹æ ˆ | æ¨èé¦–é€‰ |
| **Request Attribute** | å­˜å‚¨åœ¨ `ServerWebExchange.getAttributes()` | ç®€å•æ˜“ç”¨ | ä¸è·¨çº¿ç¨‹ | å±€éƒ¨ä½¿ç”¨ |
| **Header æ³¨å…¥** | æ·»åŠ  `X-User-ID`, `X-Roles` ç­‰å¤´ | ä¸‹æ¸¸æœåŠ¡å¯è¯†åˆ« | æ˜æ–‡ä¼ è¾“é£é™© | å¾®æœåŠ¡é—´é€šä¿¡ |
| **ThreadLocal** | ä¼ ç»Ÿæ–¹å¼ | åŒæ­¥ç¯å¢ƒä¸‹æœ‰æ•ˆ | å¼‚æ­¥æ¨¡å‹ä¸‹å¤±æ•ˆ | ä¸æ¨è |

> âœ… **æœ€ä½³å®è·µç»„åˆ**ï¼š
> - ç½‘å…³å†…éƒ¨ä½¿ç”¨ `Reactor Context`ï¼›
> - è½¬å‘ç»™ä¸‹æ¸¸æœåŠ¡æ—¶é€šè¿‡ `Header` æ³¨å…¥å¿…è¦å­—æ®µï¼›
> - æ•æ„Ÿä¿¡æ¯ä¸åœ¨ Header ä¸­æš´éœ²ã€‚

---

### 6.6 å¤šç§Ÿæˆ·ç¯å¢ƒä¸‹çš„è®¤è¯æ‰©å±•

åœ¨ SaaS æ¶æ„ä¸­ï¼Œéœ€æ”¯æŒä¸åŒç§Ÿæˆ·çš„ç‹¬ç«‹è®¤è¯ä¸éš”ç¦»ã€‚

#### æ‰©å±•æ–¹æ¡ˆï¼š

1. **Tenant ID åµŒå…¥ Token**
   ```json
   {
     "sub": "u123",
     "tenantId": "t-001",
     "roles": ["TENANT_ADMIN"]
   }
   ```

2. **è·¯ç”±æ—¶æŒ‰ tenantId åˆ†æµ**
   ```yaml
   predicates:
     - Path=/api/**
     - Header=X-Tenant-ID,t-001
   uri: lb://SERVICE-CLUSTER-A
   ```

3. **é™æµç­–ç•¥æŒ‰ tenantId ç»´åº¦é…ç½®**
   ```java
   @Bean
   public KeyResolver tenantKeyResolver() {
       return exchange -> Mono.just(
           Objects.requireNonNull(exchange.getRequest().getHeaders().getFirst("X-Tenant-ID"))
       );
   }
   ```

4. **æ•°æ®æºéš”ç¦»**ï¼šç»“åˆåŠ¨æ€æ•°æ®æºæˆ– schema éš”ç¦»å®ç°æ•°æ®å±‚é¢å¤šç§Ÿæˆ·ã€‚

---

### 6.7 å®‰å…¨åŠ å›ºå»ºè®®

| é£é™© | é˜²èŒƒæªæ–½ |
|------|----------|
| Token æ³„éœ² | ä½¿ç”¨ HTTPSï¼›ç¦ç”¨æµè§ˆå™¨è‡ªåŠ¨å¡«å……ï¼›è®¾ç½®çŸ­æœ‰æ•ˆæœŸ |
| é‡æ”¾æ”»å‡» | æ·»åŠ  `jti` + æ—¶é—´æˆ³ + Nonceï¼›Redis è®°å½•å·²å¤„ç†è¯·æ±‚ |
| XSS æ³¨å…¥ | å‰ç«¯ç¦æ­¢ `innerHTML`ï¼›è®¾ç½® CSP å¤´ |
| CSRF æ”»å‡» | å¯¹éå¹‚ç­‰æ“ä½œè¦æ±‚ Token æˆ– SameSite Cookie |
| æš´åŠ›ç ´è§£ | ç™»å½•æ¥å£é™æµï¼ˆIP + ç”¨æˆ·ç»´åº¦ï¼‰ |
| æ—¥å¿—æ³„éœ² Token | æ—¥å¿—è„±æ•å¤„ç†ï¼Œç¦æ­¢æ‰“å° Authorization å¤´ |

---

### 6.8 æ€§èƒ½ä¸ç¼“å­˜ä¼˜åŒ–å»ºè®®

| ä¼˜åŒ–é¡¹ | æè¿° |
|--------|------|
| **æœ¬åœ°ç¼“å­˜ Token è§£æç»“æœ** | ä½¿ç”¨ Caffeine ç¼“å­˜æœ€è¿‘è§£ææˆåŠŸçš„ Tokenï¼ˆTTL = å‰©ä½™æœ‰æ•ˆæœŸï¼‰ |
| **å¼‚æ­¥é»‘åå•æ ¡éªŒ** | ä½¿ç”¨ `publishOn` é¿å…é˜»å¡ä¸»çº¿ç¨‹ |
| **æ‰¹é‡åˆ·æ–°å…¬é’¥** | å®šæœŸä» JWK Set Endpoint æ›´æ–°å…¬é’¥ï¼ˆå¦‚ `.well-known/jwks.json`ï¼‰ |
| **è¿æ¥æ± å¤ç”¨** | WebClient ä½¿ç”¨è¿æ¥æ± å‡å°‘æ¡æ‰‹å¼€é”€ |

ç¤ºä¾‹ï¼šå¸¦ç¼“å­˜çš„ JWT éªŒè¯
```java
@Cacheable(value = "jwt_claims", key = "#token", condition = "#token.length() < 1000")
public Claims parseToken(String token) {
    return Jwts.parser().setSigningKey(publicKey).parseClaimsJws(token).getBody();
}
```

---

### 6.9 å°ç»“ï¼šè®¤è¯æµç¨‹å†³ç­–æ ‘

```text
                      å¼€å§‹
                        â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                           â”‚
   æ˜¯å¦ä½¿ç”¨å¤–éƒ¨ IdP?            æ˜¯å¦ä¸ºå†…éƒ¨ç³»ç»Ÿï¼Ÿ
         â”‚                           â”‚
        YES                          NO
         â”‚                           â”‚
   ä½¿ç”¨ OAuth2 Introspection     ä½¿ç”¨æœ¬åœ° JWT éªŒè¯
         â”‚                           â”‚
   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
   â”‚            â”‚             â”‚             â”‚
å¯¹ç§°åŠ å¯†ï¼Ÿ   éå¯¹ç§°åŠ å¯†ï¼Ÿ     å¯¹ç§°åŠ å¯†ï¼Ÿ    éå¯¹ç§°åŠ å¯†ï¼Ÿ
   â”‚            â”‚             â”‚             â”‚
  NO           YES           NO            YES
   â”‚            â”‚             â”‚             â”‚
ä½¿ç”¨ RS256   ä½¿ç”¨ RS256   ä½¿ç”¨ HS256    ä½¿ç”¨ RS256ï¼ˆæ¨èï¼‰
```

> **æœ€ç»ˆæ¨èæ–¹æ¡ˆ**ï¼š  
> **éå¯¹ç§°åŠ å¯† JWT + ç½‘å…³æœ¬åœ°éªŒè¯ + é»‘åå•æœºåˆ¶ + Reactor Context ä¸Šä¸‹æ–‡ä¼ é€’**

---

## 7 æœåŠ¡å‘ç°ä¸å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡

åœ¨åˆ†å¸ƒå¼å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡å®ä¾‹åŠ¨æ€ä¼¸ç¼©ã€è·¨èŠ‚ç‚¹éƒ¨ç½²å·²æˆä¸ºå¸¸æ€ã€‚ä¼ ç»Ÿçš„é™æ€ IP è°ƒç”¨æ–¹å¼å·²æ— æ³•æ»¡è¶³ç³»ç»Ÿå¼¹æ€§éœ€æ±‚ã€‚**æœåŠ¡å‘ç°ï¼ˆService Discoveryï¼‰** å’Œ **å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼ˆClient-Side Load Balancingï¼‰** æ˜¯æ”¯æ’‘å¾®æœåŠ¡è‡ªæ²»é€šä¿¡çš„å…³é”®åŸºç¡€è®¾æ–½ã€‚

Spring Cloud Gateway ä½œä¸ºæµé‡å…¥å£ï¼Œåœ¨è·¯ç”±è½¬å‘æ—¶å¿…é¡»ä¾èµ–æœåŠ¡å‘ç°æœºåˆ¶è·å–ç›®æ ‡å¾®æœåŠ¡çš„å¯ç”¨å®ä¾‹åˆ—è¡¨ï¼Œå¹¶é€šè¿‡è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹è¿›è¡Œè°ƒç”¨ã€‚æœ¬ç« å°†æ·±å…¥å‰–æè¯¥ä½“ç³»çš„æŠ€æœ¯åŸç†ä¸å·¥ç¨‹å®è·µã€‚

---

### 7.1 æ³¨å†Œä¸­å¿ƒé€‰å‹å¯¹æ¯”ä¸æ ¸å¿ƒæœºåˆ¶è¯¦è§£

#### 7.1.1 æ ¸å¿ƒåŠŸèƒ½å®šä¹‰

æ³¨å†Œä¸­å¿ƒæ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„â€œç”µè¯ç°¿â€ï¼Œæä¾›ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›ï¼š

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **æœåŠ¡æ³¨å†Œ** | å¾®æœåŠ¡å¯åŠ¨æ—¶å‘æ³¨å†Œä¸­å¿ƒä¸ŠæŠ¥è‡ªèº«ä¿¡æ¯ï¼ˆIPã€ç«¯å£ã€å…ƒæ•°æ®ï¼‰ |
| **æœåŠ¡åæ³¨å†Œ** | åœæœºæ—¶ä¸»åŠ¨æ³¨é”€æˆ–è¶…æ—¶è‡ªåŠ¨å‰”é™¤ |
| **æœåŠ¡å‘ç°** | å®¢æˆ·ç«¯æŸ¥è¯¢æŸæœåŠ¡çš„æ‰€æœ‰å¯ç”¨å®ä¾‹ |
| **å¥åº·æ£€æŸ¥** | åˆ¤æ–­æœåŠ¡å®ä¾‹æ˜¯å¦å¯æ­£å¸¸å¤„ç†è¯·æ±‚ |
| **é…ç½®ç®¡ç†ï¼ˆå¯é€‰ï¼‰** | æ”¯æŒåŠ¨æ€é…ç½®æ¨é€ |

---

#### 7.1.2 Eurekaï¼šAP æ¨¡å‹ä¸‹çš„é«˜å¯ç”¨æ³¨å†Œä¸­å¿ƒ

##### æ¶æ„ç‰¹ç‚¹ï¼š
- ç”± Netflix å¼€å‘ï¼ŒåŸºäº **APï¼ˆAvailability + Partition Toleranceï¼‰** æ¨¡å‹è®¾è®¡ã€‚
- å¼ºè°ƒæœåŠ¡å¯ç”¨æ€§ï¼Œå³ä½¿éƒ¨åˆ†èŠ‚ç‚¹æ•…éšœä»å¯è¯»å†™ã€‚
- é‡‡ç”¨ **è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ï¼ˆSelf-Preservation Modeï¼‰**ï¼šå½“ç½‘ç»œåˆ†åŒºå‘ç”Ÿæ—¶ï¼ŒEureka Server ä¸ä¼šç«‹å³åˆ é™¤å¿ƒè·³å¤±è´¥çš„æœåŠ¡ï¼Œé˜²æ­¢è¯¯åˆ å¥åº·èŠ‚ç‚¹ã€‚

##### å¿ƒè·³æœºåˆ¶ï¼š
- å®¢æˆ·ç«¯æ¯ **30 ç§’**å‘é€ä¸€æ¬¡å¿ƒè·³ï¼ˆ`renew()`ï¼‰ã€‚
- æœåŠ¡ç«¯è‹¥è¿ç»­ **90 ç§’**æœªæ”¶åˆ°å¿ƒè·³ï¼Œåˆ™æ ‡è®°ä¸º `DOWN` çŠ¶æ€ã€‚
- è‡ªæˆ‘ä¿æŠ¤è§¦å‘æ¡ä»¶ï¼šæœ€è¿‘ 1 åˆ†é’Ÿæ”¶åˆ°çš„å¿ƒè·³æ•° < é˜ˆå€¼ï¼ˆé»˜è®¤ 85%ï¼‰ã€‚

##### ä¼˜ç‚¹ï¼š
- éƒ¨ç½²ç®€å•ï¼Œé›†æˆæ–¹ä¾¿ã€‚
- å¯¹ç½‘ç»œæŠ–åŠ¨å®¹å¿åº¦é«˜ï¼Œé€‚åˆäº‘ç¯å¢ƒã€‚

##### ç¼ºç‚¹ï¼š
- ä¸æ”¯æŒå¼ºä¸€è‡´æ€§åœºæ™¯ï¼ˆå¦‚é‡‘èäº¤æ˜“ç³»ç»Ÿï¼‰ã€‚
- æ— åŸç”Ÿé…ç½®ç®¡ç†åŠŸèƒ½ã€‚
- å·²è¿›å…¥ç»´æŠ¤æ¨¡å¼ï¼Œä¸å†ç§¯ææ›´æ–°ã€‚

> âœ… é€‚ç”¨åœºæ™¯ï¼šä¸­å°å‹é¡¹ç›®ã€å¯¹ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„å†…éƒ¨ç³»ç»Ÿã€‚

---

#### 7.1.3 Nacosï¼šé˜¿é‡Œå·´å·´å¼€æºçš„ä¸€ä½“åŒ–æœåŠ¡å¹³å°

##### æ¶æ„ç‰¹ç‚¹ï¼š
- åŒæ—¶æ”¯æŒ **AP ä¸ CP æ¨¡å¼åˆ‡æ¢**ï¼Œå…¼å®¹ä¸´æ—¶å®ä¾‹ï¼ˆephemeralï¼‰å’ŒæŒä¹…å®ä¾‹ï¼ˆpersistentï¼‰ã€‚
- æä¾› **æœåŠ¡å‘ç° + é…ç½®ç®¡ç†** åŒå¼•æ“ã€‚
- æ”¯æŒ DNSã€HTTPã€gRPC å¤šç§è®¿é—®åè®®ã€‚
- å†…ç½®é›†ç¾¤é€‰ä¸¾ï¼ˆRaft åè®®ï¼‰ã€å¥åº·æ£€æŸ¥ã€æƒé‡ç®¡ç†ã€‚

##### å¥åº·æ£€æŸ¥æ–¹å¼ï¼š
| å®ä¾‹ç±»å‹ | æ£€æŸ¥æ–¹å¼ |
|--------|----------|
| ä¸´æ—¶å®ä¾‹ï¼ˆé»˜è®¤ï¼‰ | å®¢æˆ·ç«¯ä¸ŠæŠ¥å¿ƒè·³ï¼ˆç±»ä¼¼ Eurekaï¼‰ |
| æŒä¹…å®ä¾‹ | æœåŠ¡ç«¯ä¸»åŠ¨æ¢æµ‹ï¼ˆTCP/HTTP/DNSï¼‰ |

##### å…ƒæ•°æ®æ‰©å±•ï¼š
æ”¯æŒè‡ªå®šä¹‰ metadataï¼Œå¯ç”¨äºç°åº¦å‘å¸ƒã€ç‰ˆæœ¬æ§åˆ¶ï¼š
```yaml
spring:
  cloud:
    nacos:
      discovery:
        metadata:
          version: v1
          weight: 100
          region: beijing
```

##### ä¼˜ç‚¹ï¼š
- åŠŸèƒ½å…¨é¢ï¼Œä¸€ç«™å¼è§£å†³æœåŠ¡ä¸é…ç½®é—®é¢˜ã€‚
- ç¤¾åŒºæ´»è·ƒï¼ŒæŒç»­è¿­ä»£ã€‚
- æ”¯æŒ Kubernetes åŸç”Ÿé›†æˆã€‚

> âœ… é€‚ç”¨åœºæ™¯ï¼šæ··åˆäº‘ã€å¤šç¯å¢ƒéƒ¨ç½²ã€éœ€è¦ç»Ÿä¸€é…ç½®ç®¡ç†çš„ä¼ä¸šçº§ç³»ç»Ÿã€‚

---

#### 7.1.4 Consulï¼šHashiCorp å‡ºå“çš„å¼ºä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ

##### æ¶æ„ç‰¹ç‚¹ï¼š
- åŸºäº **CPï¼ˆConsistency + Partition Toleranceï¼‰** æ¨¡å‹ï¼Œä½¿ç”¨ Raft åè®®ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚
- æ”¯æŒå¤šæ•°æ®ä¸­å¿ƒï¼ˆMulti-Datacenterï¼‰å¤åˆ¶ã€‚
- æä¾› DNS æ¥å£å’ŒæœåŠ¡ç½‘æ ¼é›†æˆï¼ˆConsul Connectï¼‰ã€‚
- å¥åº·æ£€æŸ¥ä¸°å¯Œï¼šHTTPã€TCPã€Dockerã€TTLã€Script ç­‰ã€‚

##### æ•°æ®åŒæ­¥æœºåˆ¶ï¼š
- åŒä¸€æ•°æ®ä¸­å¿ƒå†…é€šè¿‡ Raft åè®®é€‰ä¸¾ Leader å¹¶åŒæ­¥çŠ¶æ€ã€‚
- è·¨æ•°æ®ä¸­å¿ƒé€šè¿‡ WAN Gossip å®ç°æœ€ç»ˆä¸€è‡´æ€§ã€‚

##### æœåŠ¡æ³¨å†Œæ–¹å¼ï¼š
- Agent æ¨¡å¼ï¼šæ¯ä¸ªèŠ‚ç‚¹è¿è¡Œ consul agentï¼Œè´Ÿè´£æœ¬åœ°æœåŠ¡æ³¨å†Œä¸å¥åº·æ£€æŸ¥ã€‚
- HTTP APIï¼šç›´æ¥è°ƒç”¨ `/v1/agent/service/register` æ³¨å†ŒæœåŠ¡ã€‚

##### ä¼˜ç‚¹ï¼š
- å¼ºä¸€è‡´æ€§ä¿éšœï¼Œé€‚ç”¨äºé‡‘èã€æ”¯ä»˜ç±»ç³»ç»Ÿã€‚
- æ”¯æŒ mTLS åŠ å¯†é€šä¿¡ã€‚
- æˆç†Ÿçš„æœåŠ¡ç½‘æ ¼ç”Ÿæ€ã€‚

##### ç¼ºç‚¹ï¼š
- éƒ¨ç½²å¤æ‚ï¼Œéœ€ç»´æŠ¤ Server é›†ç¾¤å’Œ Client Agentã€‚
- æ€§èƒ½ä½äº Eureka/Nacosï¼ˆå› å¼ºä¸€è‡´å¼€é”€ï¼‰ã€‚

> âœ… é€‚ç”¨åœºæ™¯ï¼šé«˜å®‰å…¨ã€å¼ºä¸€è‡´æ€§è¦æ±‚çš„è¡Œä¸šåº”ç”¨ï¼ˆé“¶è¡Œã€ä¿é™©ã€æ”¿åŠ¡ï¼‰ã€‚

---

#### 7.1.4 é€‰å‹å†³ç­–çŸ©é˜µï¼ˆç»¼åˆè¯„ä¼°ï¼‰

| ç»´åº¦ | Eureka | Nacos | Consul |
|------|--------|--------|--------|
| æ˜“ç”¨æ€§ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† |
| åŠŸèƒ½å®Œæ•´æ€§ | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… |
| ä¸€è‡´æ€§ä¿éšœ | AP | AP/CP å¯åˆ‡æ¢ | CP |
| é…ç½®ç®¡ç† | âŒ | âœ… | âœ…ï¼ˆKV Storeï¼‰ |
| å¤šæ•°æ®ä¸­å¿ƒ | âŒ | âœ… | âœ… |
| DNS æ”¯æŒ | âŒ | âœ… | âœ… |
| ç”Ÿæ€æ•´åˆ | Spring Cloud Netflix | Spring Cloud Alibaba | HashiCorp Suite |
| ç¤¾åŒºæ´»è·ƒåº¦ | ä¸­ï¼ˆç»´æŠ¤æ¨¡å¼ï¼‰ | é«˜ | é«˜ |
| è¿ç»´æˆæœ¬ | ä½ | ä¸­ | é«˜ |

> ğŸ“Œ **æ¨èæ–¹æ¡ˆ**ï¼š
> - **åˆåˆ›é¡¹ç›® / å†…éƒ¨ç³»ç»Ÿ** â†’ Eureka
> - **ä¸­å¤§å‹ä¼ä¸š / æ··åˆäº‘** â†’ Nacos
> - **é‡‘èçº§ç³»ç»Ÿ / å¼ºä¸€è‡´æ€§** â†’ Consul

---

### 7.2 Spring Cloud LoadBalancer å®ç°åŸç†æ·±åº¦è§£æ

è‡ª Spring Cloud 2020 èµ·ï¼ŒRibbon è¢«æ­£å¼å¼ƒç”¨ï¼Œå®˜æ–¹æ¨èä½¿ç”¨ **Spring Cloud LoadBalancer** ä½œä¸ºæ–°ä¸€ä»£å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ç»„ä»¶ã€‚

#### 7.2.1 æ¶æ„æ¦‚è§ˆ

```
[WebClient / RestTemplate] 
        â†“
[LoadBalancerExchangeFilterFunction] â† æ‹¦æˆªè¯·æ±‚
        â†“
[ServiceInstanceListSupplier] â† è·å–å®ä¾‹åˆ—è¡¨ï¼ˆæ¥è‡ª Nacos/Eurekaï¼‰
        â†“
[ReactorLoadBalancer<ServiceInstance>] â† æ‰§è¡Œè´Ÿè½½å‡è¡¡ç®—æ³•
        â†“
[Selected Instance URI] â†’ æ›¿æ¢åŸå§‹ URL å‘èµ·è°ƒç”¨
```

---

#### 7.2.2 æ ¸å¿ƒæ¥å£è¯¦è§£

##### ï¼ˆ1ï¼‰`ServiceInstanceListSupplier`

è´Ÿè´£ä»æ³¨å†Œä¸­å¿ƒè·å–æŒ‡å®šæœåŠ¡çš„å®ä¾‹åˆ—è¡¨ã€‚

```java
public interface ServiceInstanceListSupplier extends Supplier<Flux<List<ServiceInstance>>> {
    String getServiceId(); // å¦‚ ORDER-SERVICE
}
```

ä¸åŒæ³¨å†Œä¸­å¿ƒæœ‰å„è‡ªçš„å®ç°ï¼š
- `NacosDiscoveryClient`
- `EurekaDiscoveryClient`
- `ConsulDiscoveryClient`

å¯é€šè¿‡ SPI è‡ªå®šä¹‰æ‰©å±•ã€‚

##### ï¼ˆ2ï¼‰`ReactorLoadBalancer<T>`

å“åº”å¼è´Ÿè½½å‡è¡¡å™¨æ¥å£ï¼Œè¿”å› `Mono<Response<T>>`ã€‚

```java
public interface ReactorLoadBalancer<T> {
    Mono<Response<T>> choose(Request request);
}
```

å…¶ä¸­ `Response<T>` åŒ…å«ï¼š
- `getServer()`ï¼šé€‰ä¸­çš„å®ä¾‹
- `getAllServers()`ï¼šæ‰€æœ‰å€™é€‰å®ä¾‹ï¼ˆç”¨äºç†”æ–­ç»Ÿè®¡ï¼‰

##### ï¼ˆ3ï¼‰å†…ç½®å®ç°ç±»

| ç±»å | ç­–ç•¥ |
|------|------|
| `RoundRobinLoadBalancer` | è½®è¯¢ |
| `RandomLoadBalancer` | éšæœº |
| `HealthCheckReactorLoadBalancer` | ç»“åˆå¥åº·æ£€æŸ¥è¿‡æ»¤å¼‚å¸¸å®ä¾‹ |

---

#### 7.2.3 ä¸ WebClient é›†æˆæµç¨‹

```java
WebClient.builder()
    .clientConnector(new ReactorClientHttpConnector(
        HttpClient.create().wiretap(true)))
    .build()
    .get()
    .uri("http://ORDER-SERVICE/order/123") // ä½¿ç”¨æœåŠ¡åè€Œéå…·ä½“IP
    .retrieve()
    .bodyToMono(Order.class)
    .block();
```

è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼š

1. `UriDefinitionRoutePredicateFactory` è¯†åˆ« `lb://ORDER-SERVICE` åè®®ï¼›
2. è§¦å‘ `LoadBalancerClient` æŸ¥è¯¢å®ä¾‹åˆ—è¡¨ï¼›
3. æ‰§è¡Œ `choose()` æ–¹æ³•é€‰å‡ºä¸€ä¸ªå®ä¾‹ï¼›
4. å°†é€»è¾‘ URI æ›¿æ¢ä¸ºçœŸå®åœ°å€ï¼ˆå¦‚ `http://10.0.1.10:8080/order/123`ï¼‰ï¼›
5. å‘èµ·å®é™… HTTP è¯·æ±‚ã€‚

---

#### 7.2.4 æºç çº§æ‰§è¡Œæµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰

```text
WebClient.request() 
   â†’ Interceptors.chain()
   â†’ LoadBalancerExchangeFilterFunction.filter()
       â†’ client.choose(serviceId) 
           â†’ ServiceInstanceListSupplier.get() 
               â†’ ä» Nacos/Eureka è·å–å®ä¾‹åˆ—è¡¨
           â†’ loadBalancer.choose()
               â†’ RoundRobin / Random ç­‰ç®—æ³•é€‰æ‹©å®ä¾‹
       â†’ exchange.mutate().request(builder -> builder.uri(realUri))
   â†’ ä¸‹æ¸¸ Filter æˆ– Netty å‘é€è¯·æ±‚
```

---

### 7.3 è´Ÿè½½å‡è¡¡ç­–ç•¥è¯¦è§£

#### 7.3.1 å†…ç½®ç­–ç•¥

| ç­–ç•¥ | å®ç°ç±» | ç‰¹ç‚¹ |
|------|--------|------|
| **è½®è¯¢ï¼ˆRound Robinï¼‰** | `RoundRobinLoadBalancer` | å‡åŒ€åˆ†é…ï¼Œæœ€å¸¸ç”¨ |
| **éšæœºï¼ˆRandomï¼‰** | `RandomLoadBalancer` | åˆ†å¸ƒæ›´éšæœºï¼Œé¿å…å‘¨æœŸæ€§çƒ­ç‚¹ |
| **åŠ æƒå“åº”æ—¶é—´ï¼ˆWeighted Response Timeï¼‰** | è‡ªå®šä¹‰æ‰©å±• | å“åº”å¿«çš„å®ä¾‹è·å¾—æ›´å¤šæµé‡ |
| **åŒºåŸŸæ„ŸçŸ¥ï¼ˆZone-Awareï¼‰** | `ZoneAvoidanceLoadBalancer`ï¼ˆRibboné—ç•™ï¼‰ | ä¼˜å…ˆåŒåŒºåŸŸå®ä¾‹ï¼Œé™ä½å»¶è¿Ÿ |

---

#### 7.3.2 è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥ç¤ºä¾‹ï¼šåŸºäºå“åº”æ—¶é—´åŠ æƒ

```java
@Component
@Primary
public class WeightedResponseTimeLoadBalancer implements ReactorLoadBalancer<ServiceInstance> {

    private final Map<String, Long> avgResponseTime = new ConcurrentHashMap<>();
    private final AtomicInteger position = new AtomicInteger(0);

    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        String serviceId = (String) request.getContext().get(RequestDataContext.SERVICE_ID);
        List<ServiceInstance> instances = getInstances(serviceId);

        if (instances.isEmpty()) {
            return Mono.just(ResponseHelper.empty());
        }

        // è®¡ç®—æ€»æƒé‡ï¼ˆå“åº”æ—¶é—´è¶ŠçŸ­ï¼Œæƒé‡è¶Šé«˜ï¼‰
        double totalWeight = instances.stream()
            .mapToDouble(instance -> 1.0 / Math.max(getAvgResponseTime(instance), 1))
            .sum();

        // éšæœºç”Ÿæˆä¸€ä¸ªæƒé‡åŒºé—´å†…çš„å€¼
        double randomWeight = ThreadLocalRandom.current().nextDouble() * totalWeight;
        double currentSum = 0;

        for (ServiceInstance instance : instances) {
            double weight = 1.0 / Math.max(getAvgResponseTime(instance), 1);
            currentSum += weight;
            if (randomWeight <= currentSum) {
                return Mono.just(new DefaultResponse(instance));
            }
        }

        // fallback
        return Mono.just(new DefaultResponse(instances.get(0)));
    }

    private long getAvgResponseTime(ServiceInstance instance) {
        return avgResponseTime.getOrDefault(instance.getInstanceId(), 100L);
    }

    private List<ServiceInstance> getInstances(String serviceId) {
        // ä» DiscoveryClient è·å–æœ€æ–°å®ä¾‹
        return discoveryClient.getInstances(serviceId);
    }
}
```

> âš ï¸ æ³¨æ„ï¼šéœ€é…åˆç›‘æ§ç³»ç»Ÿæ”¶é›†å„å®ä¾‹çš„ P90 å»¶è¿Ÿå¹¶å®šæœŸæ›´æ–° `avgResponseTime`ã€‚

---

#### 7.3.3 Zone-Aware è´Ÿè½½å‡è¡¡ï¼ˆè·¨åŒºåŸŸä¼˜åŒ–ï¼‰

åœ¨å¤šå¯ç”¨åŒºï¼ˆAZï¼‰æˆ–è·¨åœ°åŸŸéƒ¨ç½²ä¸­ï¼Œä¼˜å…ˆé€‰æ‹©åŒåŒºåŸŸå®ä¾‹å¯æ˜¾è‘—é™ä½å»¶è¿Ÿã€‚

##### å®ç°å‰æï¼š
- æ³¨å†Œä¸­å¿ƒæ”¯æŒ `zone` å…ƒæ•°æ®ï¼š
  ```yaml
  spring:
    cloud:
      nacos:
        discovery:
          metadata:
            zone: beijing-az1
  ```

##### é€‰æ‹©é€»è¾‘ï¼š
1. è·å–å®¢æˆ·ç«¯æ‰€åœ¨ zoneï¼›
2. ç­›é€‰ç›¸åŒ zone çš„å¥åº·å®ä¾‹ï¼›
3. è‹¥æ— å¯ç”¨å®ä¾‹ï¼Œåˆ™é™çº§åˆ°å…¶ä»– zoneã€‚

```java
@Bean
@ConditionalOnMissingBean
public ReactorLoadBalancer<ServiceInstance> zoneAwareLoadBalancer(
    Environment environment,
    ServiceInstanceListSupplier supplier) {

    String localZone = environment.getProperty("spring.cloud.nacos.discovery.metadata.zone", "unknown");

    return new ReactorLoadBalancer<ServiceInstance>() {
        @Override
        public Mono<Response<ServiceInstance>> choose(Request request) {
            return supplier.get()
                .flatMapMany(Flux::fromIterable)
                .collectList()
                .map(instances -> {
                    List<ServiceInstance> sameZone = instances.stream()
                        .filter(i -> localZone.equals(i.getMetadata().get("zone")))
                        .filter(this::isHealthy)
                        .toList();

                    if (!sameZone.isEmpty()) {
                        int idx = new Random().nextInt(sameZone.size());
                        return new DefaultResponse(sameZone.get(idx));
                    }

                    // Fallback to other zones
                    List<ServiceInstance> others = instances.stream()
                        .filter(this::isHealthy)
                        .toList();
                    if (!others.isEmpty()) {
                        int idx = new Random().nextInt(others.size());
                        return new DefaultResponse(others.get(idx));
                    }

                    return ResponseHelper.empty();
                });
        }

        private boolean isHealthy(ServiceInstance instance) {
            // å¯ç»“åˆ health endpoint æˆ– last heartbeat time åˆ¤æ–­
            return true;
        }
    };
}
```

---

### 7.4 å¥åº·æ£€æŸ¥æœºåˆ¶æ·±åº¦å¯¹æ¯”

| æ³¨å†Œä¸­å¿ƒ | æ£€æŸ¥æ–¹å¼ | é¢‘ç‡ | æ•…éšœæ£€æµ‹æ—¶é—´ | æ˜¯å¦æ”¯æŒè¢«åŠ¨æ¢æµ‹ |
|--------|----------|-------|----------------|--------------------|
| Eureka | å¿ƒè·³ä¸ŠæŠ¥ï¼ˆå®¢æˆ·ç«¯ï¼‰ | é»˜è®¤ 30s | ~90s | âŒ |
| Nacosï¼ˆä¸´æ—¶å®ä¾‹ï¼‰ | å¿ƒè·³ä¸ŠæŠ¥ | å¯é…ç½® | 3x heartbeat interval | âŒ |
| Nacosï¼ˆæŒä¹…å®ä¾‹ï¼‰ | ä¸»åŠ¨ TCP/HTTP æ¢æµ‹ | å¯é…ç½® | ç”± probe é¢‘ç‡å†³å®š | âœ… |
| Consul | ä¸»åŠ¨ HTTP/TCP/Script æ¢æµ‹ | å¯é…ç½® | æ¢æµ‹å‘¨æœŸ x å¤±è´¥æ¬¡æ•° | âœ… |

---

#### 7.4.1 å¿ƒè·³æœºåˆ¶ï¼ˆEureka/Nacos ä¸´æ—¶å®ä¾‹ï¼‰

- å®¢æˆ·ç«¯å®šæ—¶å‘é€å¿ƒè·³åŒ…ï¼ˆå¦‚ `/nacos/v1/ns/instance/beat`ï¼‰ï¼›
- æœåŠ¡ç«¯è®°å½•æœ€åå¿ƒè·³æ—¶é—´ï¼›
- è‹¥è¶…è¿‡é˜ˆå€¼æœªæ”¶åˆ°å¿ƒè·³ï¼Œåˆ™æ ‡è®°ä¸ºä¸å¥åº·ã€‚

##### ä¼˜ç‚¹ï¼š
- å¼€é”€å°ï¼Œé€‚åˆå¤§è§„æ¨¡å®ä¾‹ï¼›
- å®¢æˆ·ç«¯å¯æºå¸¦è´Ÿè½½ä¿¡æ¯ï¼ˆCPUã€QPSï¼‰ç”¨äºæ™ºèƒ½è°ƒåº¦ã€‚

##### ç¼ºç‚¹ï¼š
- æ— æ³•æ£€æµ‹å®ä¾‹å¡é¡¿ä½†ä»åœ¨å‘å¿ƒè·³çš„æƒ…å†µï¼ˆå‡æ´»ï¼‰ï¼›
- æ•…éšœå‘ç°å»¶è¿Ÿè¾ƒé•¿ã€‚

---

#### 7.4.2 ä¸»åŠ¨æ¢æµ‹æœºåˆ¶ï¼ˆNacos æŒä¹…å®ä¾‹ / Consulï¼‰

- æœåŠ¡ç«¯å®šæœŸå‘èµ· TCP è¿æ¥æˆ– HTTP GET è¯·æ±‚ï¼›
- æ ¹æ®å“åº”ç ã€è¶…æ—¶ã€è„šæœ¬è¾“å‡ºåˆ¤æ–­å¥åº·çŠ¶æ€ã€‚

##### æ¢æµ‹ç±»å‹ï¼š
| ç±»å‹ | ç¤ºä¾‹ |
|------|------|
| HTTP | `GET http://ip:port/actuator/health` â†’ 200 OK |
| TCP | å°è¯•å»ºç«‹è¿æ¥ï¼ŒæˆåŠŸå³è§†ä¸ºå¥åº· |
| Script | æ‰§è¡Œ shell è„šæœ¬ï¼Œexit code == 0 è¡¨ç¤ºå¥åº· |

##### ä¼˜ç‚¹ï¼š
- æ›´å‡†ç¡®åæ˜ çœŸå®æœåŠ¡èƒ½åŠ›ï¼›
- å¯æ£€æµ‹â€œå‡æ­»â€è¿›ç¨‹ã€‚

##### ç¼ºç‚¹ï¼š
- å¢åŠ æ³¨å†Œä¸­å¿ƒè´Ÿè½½ï¼›
- é…ç½®å¤æ‚ã€‚

---

#### 7.4.3 Spring Boot Actuator å¥åº·ç«¯ç‚¹é…ç½®

ç¡®ä¿å¾®æœåŠ¡æš´éœ²æ ‡å‡†å¥åº·æ¥å£ï¼š

```yaml
management:
  endpoint:
    health:
      show-details: always  # æˆ– when_authorized
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,metrics
```

å¯è‡ªå®šä¹‰å¥åº·æŒ‡ç¤ºå™¨ï¼š

```java
@Component
public class DatabaseHealthIndicator implements HealthIndicator {
    @Override
    public Health health() {
        try {
            jdbcTemplate.queryForObject("SELECT 1", Integer.class);
            return Health.up().withDetail("database", "connected").build();
        } catch (Exception e) {
            return Health.down(e).build();
        }
    }
}
```

---

### 7.5 æ€§èƒ½è°ƒä¼˜ä¸æœ€ä½³å®è·µ

| ä¼˜åŒ–é¡¹ | å»ºè®® |
|--------|------|
| **ç¼“å­˜å®ä¾‹åˆ—è¡¨** | è®¾ç½®åˆç†çš„åˆ·æ–°é—´éš”ï¼ˆå¦‚ 30sï¼‰ï¼Œé¿å…é¢‘ç¹æ‹‰å– |
| **å¯ç”¨æ‡’åŠ è½½** | `spring.cloud.loadbalancer.cache.enabled=true` |
| **åˆç†è®¾ç½®è¶…æ—¶** | é¿å…å› å•ä¸ªå®ä¾‹æ…¢å¯¼è‡´æ•´ä½“å»¶è¿Ÿä¸Šå‡ |
| **é‡è¯•æœºåˆ¶** | é…åˆ `RetryableRoutePredicateFactory` å®ç°å¤±è´¥é‡è¯• |
| **ç›‘æ§è´Ÿè½½å‡è¡¡è¡Œä¸º** | è®°å½•é€‰æ‹©æ—¥å¿—ï¼Œåˆ†ææµé‡åˆ†å¸ƒæ˜¯å¦å‡åŒ€ |

---

### 7.6 å¸¸è§é—®é¢˜æ’æŸ¥æŒ‡å—

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ³• |
|---------|----------|----------|
| æœåŠ¡æ— æ³•å‘ç° | æ³¨å†Œä¸­å¿ƒåœ°å€é”™è¯¯ | æ£€æŸ¥ `spring.cloud.nacos.discovery.server-addr` |
| å®ä¾‹æ˜¾ç¤ºä¸å¥åº· | å¥åº·æ£€æŸ¥å¤±è´¥ | æŸ¥çœ‹ `/actuator/health` è¿”å›å†…å®¹ |
| è´Ÿè½½ä¸å‡ | è½®è¯¢ç®—æ³•è¢«ç ´å | æ£€æŸ¥æ˜¯å¦å¯ç”¨äº† sticky session æˆ–ç¼“å­˜ |
| è°ƒç”¨æŠ¥ 503 | æ— å¯ç”¨å®ä¾‹ | æ£€æŸ¥æœåŠ¡æ˜¯å¦æ³¨å†ŒæˆåŠŸã€ç½‘ç»œè¿é€šæ€§ |
| DNS è§£æå¤±è´¥ | æœªå¼€å¯ DNS æ”¯æŒ | é…ç½® `spring.cloud.nacos.discovery.enable-http-health-state=false`ï¼ˆConsul/Nacosï¼‰ |

---

### 7.7 å°ç»“ï¼šæœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡è®¾è®¡åŸåˆ™

1. **é€‰å‹åŒ¹é…ä¸šåŠ¡éœ€æ±‚**ï¼šä¸­å°é¡¹ç›®ç”¨ Eurekaï¼Œå¤æ‚ç³»ç»Ÿä¼˜é€‰ Nacos æˆ– Consulã€‚
2. **ç»Ÿä¸€å…ƒæ•°æ®è§„èŒƒ**ï¼šå®šä¹‰æ ‡å‡† metadata å­—æ®µï¼ˆversionã€zoneã€weightï¼‰ç”¨äºé«˜çº§è·¯ç”±ã€‚
3. **å¥åº·æ£€æŸ¥å› åœ°åˆ¶å®œ**ï¼šå†…éƒ¨æœåŠ¡å¯ç”¨å¿ƒè·³ï¼Œå…³é”®æœåŠ¡å»ºè®®ä¸»åŠ¨æ¢æµ‹ã€‚
4. **è´Ÿè½½å‡è¡¡ç­–ç•¥å¯æ‰©å±•**ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹å¾å®šåˆ¶åŠ æƒã€åŒºåŸŸä¼˜å…ˆç­‰ç­–ç•¥ã€‚
5. **å¯è§‚æµ‹æ€§ä¸å¯å°‘**ï¼šè®°å½•æœåŠ¡æ³¨å†Œ/åæ³¨å†Œäº‹ä»¶ï¼Œç›‘æ§å®ä¾‹æ•°é‡æ³¢åŠ¨ã€‚

---
å½“ç„¶å¯ä»¥ã€‚ä»¥ä¸‹æ˜¯**ç¬¬å…«ç« ã€Šå†…ç½‘å¾®æœåŠ¡é—´é€šä¿¡æœºåˆ¶ã€‹çš„å…¨é¢å¢å¼ºç‰ˆ**ï¼Œå†…å®¹æ·±åº¦æ‰©å±•ï¼Œæ¶µç›– **Feign åŸç†å‰–æã€gRPC é«˜æ€§èƒ½é€šä¿¡ã€å¼‚æ­¥æ¶ˆæ¯è§£è€¦ã€æœåŠ¡ç½‘æ ¼æ¼”è¿›è·¯å¾„ã€åè®®é€‰å‹å†³ç­–æ ‘ã€æ€§èƒ½å¯¹æ¯”æµ‹è¯•ã€å®‰å…¨æ§åˆ¶ç­–ç•¥ã€ä¸Šä¸‹æ–‡ä¼ é€’ä¸é“¾è·¯è¿½è¸ªé›†æˆ**ç­‰å…³é”®ä¸»é¢˜ï¼Œé€‚åˆä½œä¸ºä¼ä¸šçº§å¾®æœåŠ¡é€šä¿¡æ¶æ„çš„è®¾è®¡è“æœ¬ã€‚

---

## 8 å†…ç½‘å¾®æœåŠ¡é—´é€šä¿¡æœºåˆ¶

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒæœåŠ¡ä¹‹é—´çš„é«˜æ•ˆã€å¯é ã€å®‰å…¨é€šä¿¡æ˜¯ç³»ç»Ÿç¨³å®šè¿è¡Œçš„æ ¸å¿ƒä¿éšœã€‚éšç€æœåŠ¡æ•°é‡å¢é•¿å’Œä¸šåŠ¡å¤æ‚åº¦æå‡ï¼Œå•ä¸€çš„è°ƒç”¨æ¨¡å¼å·²æ— æ³•æ»¡è¶³æ‰€æœ‰åœºæ™¯éœ€æ±‚ã€‚ç°ä»£å¾®æœåŠ¡ç³»ç»Ÿé€šå¸¸é‡‡ç”¨å¤šç§é€šä¿¡æ–¹å¼ç»„åˆä½¿ç”¨ï¼Œä»¥å®ç°**é«˜ååã€ä½å»¶è¿Ÿã€å¼ºä¸€è‡´æ€§æˆ–æœ€ç»ˆä¸€è‡´æ€§**çš„ä¸åŒç›®æ ‡ã€‚
æœ¬ç« å°†æ·±å…¥æ¢è®¨å››ç§ä¸»æµçš„å†…ç½‘é€šä¿¡èŒƒå¼ï¼š**å£°æ˜å¼ REST è°ƒç”¨ï¼ˆFeignï¼‰**ã€**é«˜æ€§èƒ½ RPCï¼ˆgRPCï¼‰**ã€**å¼‚æ­¥æ¶ˆæ¯é©±åŠ¨ï¼ˆMessage Queueï¼‰** å’Œ **æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰**ï¼Œå¹¶æä¾›é€‰å‹å»ºè®®ä¸å·¥ç¨‹å®è·µæŒ‡å¯¼ã€‚

---

### 8.1 OpenFeignï¼šå£°æ˜å¼ REST å®¢æˆ·ç«¯è¯¦è§£

#### 8.1.1 ä»€ä¹ˆæ˜¯ OpenFeignï¼Ÿ

OpenFeign æ˜¯ä¸€ä¸ªåŸºäºæ¥å£çš„**å£°æ˜å¼ HTTP å®¢æˆ·ç«¯**ï¼Œå…è®¸å¼€å‘è€…é€šè¿‡å®šä¹‰ Java æ¥å£çš„æ–¹å¼å‘èµ·è¿œç¨‹è°ƒç”¨ï¼Œæ— éœ€æ‰‹åŠ¨æ„å»º URLã€è®¾ç½® Header æˆ–è§£æå“åº”ä½“ã€‚

```java
@FeignClient(name = "USER-SERVICE", path = "/user", contextId = "userClient")
public interface UserClient {

    @GetMapping("/{id}")
    ResponseEntity<User> findById(@PathVariable("id") String userId);

    @PostMapping("/batch")
    List<User> findUsersByIds(@RequestBody List<String> userIds);

    @DeleteMapping("/{id}")
    void delete(@PathVariable("id") String id);
}
```

è°ƒç”¨æ—¶å¦‚åŒæœ¬åœ°æ–¹æ³•ï¼š
```java
User user = userClient.findById("u123").getBody();
```

---

#### 8.1.2 Feign çš„æ ¸å¿ƒæ‰§è¡Œæµç¨‹

```
[è°ƒç”¨æ–¹] â†’ [Feign Proxy] â†’ [Contract è§£ææ³¨è§£] â†’ [Encoder ç¼–ç è¯·æ±‚] 
         â†’ [LoadBalancer é€‰æ‹©å®ä¾‹] â†’ [Client å‘èµ· HTTP è¯·æ±‚]
         â† [Decoder è§£ç å“åº”] â† [è¿”å›ç»“æœ]
```

##### å„ç»„ä»¶èŒè´£ï¼š

| ç»„ä»¶ | åŠŸèƒ½ |
|------|------|
| **Feign.Builder** | æ„å»ºä»£ç†å¯¹è±¡ |
| **Contract** | è§£æ Spring MVC æ³¨è§£ï¼ˆå¦‚ `@GetMapping`ï¼‰ |
| **Encoder / Decoder** | åºåˆ—åŒ–è¯·æ±‚ä½“ / ååºåˆ—åŒ–å“åº”ä½“ï¼ˆé»˜è®¤ Jacksonï¼‰ |
| **Logger** | è®°å½•è¯·æ±‚æ—¥å¿—ï¼ˆå¯é…ç½® FULL çº§åˆ«ï¼‰ |
| **Client** | å®é™…å‘é€ HTTP è¯·æ±‚ï¼ˆæ”¯æŒ JDKã€OkHttpã€Apache HttpClientï¼‰ |
| **LoadBalancerFeignClient** | é›†æˆ Spring Cloud LoadBalancerï¼Œå®ç°æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡ |

---

#### 8.1.3 é›†æˆ Spring Cloud LoadBalancerï¼ˆæ›¿ä»£ Ribbonï¼‰

è‡ª Spring Cloud 2020 èµ·ï¼ŒRibbon è¢«å¼ƒç”¨ï¼ŒFeign é»˜è®¤é›†æˆ `Spring Cloud LoadBalancer`ã€‚

##### å¼•å…¥ä¾èµ–ï¼š
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
<!-- è‡ªåŠ¨å¯ç”¨ LoadBalancer -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
```

##### é…ç½®ç¤ºä¾‹ï¼š
```yaml
spring:
  cloud:
    loadbalancer:
      configurations: random # æˆ– round-robin
```

##### è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ˆè§ç¬¬7ç« ï¼‰ï¼ŒFeign ä¼šè‡ªåŠ¨æ„ŸçŸ¥ã€‚

---

#### 8.1.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®

| ä¼˜åŒ–é¡¹ | é…ç½®æ–¹å¼ | æ•ˆæœ |
|--------|----------|------|
| ä½¿ç”¨ OkHttp æ›¿ä»£ JDK Client | `feign.okhttp.enabled=true` | æ”¯æŒè¿æ¥æ± ã€GZIP å‹ç¼© |
| å¼€å¯ GZIP å‹ç¼© | `server.compression.enabled=true` | å‡å°‘ä¼ è¾“ä½“ç§¯ |
| è®¾ç½®è¶…æ—¶æ—¶é—´ | `feign.client.config.default.connectTimeout=5000` | é˜²æ­¢çº¿ç¨‹é˜»å¡ |
| å¯ç”¨é‡è¯•æœºåˆ¶ | ç»“åˆ `spring-retry` + `@Retryable` | æå‡è°ƒç”¨æˆåŠŸç‡ |

```yaml
feign:
  client:
    config:
      default:
        connectTimeout: 5000
        readTimeout: 10000
  okhttp:
    enabled: true
  httpclient:
    disabled: true
```

---

#### 8.1.5 å¼‚å¸¸å¤„ç†ä¸é™çº§ï¼ˆHystrix å·²æ·˜æ±°ï¼Œæ¨è Resilience4jï¼‰

è™½ç„¶ Hystrix å·²åœæ­¢ç»´æŠ¤ï¼Œä½†å¯é€šè¿‡ `Resilience4j` å®ç°ç†”æ–­ä¸é™çº§ï¼š

```java
@FeignClient(name = "ORDER-SERVICE", fallback = OrderServiceFallback.class)
public interface OrderClient {
    @GetMapping("/order/{id}")
    Order getOrder(@PathVariable("id") String orderId);
}

@Component
public class OrderServiceFallback implements OrderClient {
    @Override
    public Order getOrder(String orderId) {
        return new Order(orderId, "unknown", BigDecimal.ZERO, "fallback");
    }
}
```

é…åˆ Resilience4j é…ç½®ï¼š
```yaml
resilience4j.circuitbreaker:
  instances:
    orderService:
      failureRateThreshold: 50
      waitDurationInOpenState: 5000ms
      slidingWindowSize: 10
```

---

### 8.2 gRPCï¼šé«˜æ€§èƒ½è·¨è¯­è¨€ RPC æ¡†æ¶

#### 8.2.1 ä¸ºä»€ä¹ˆéœ€è¦ gRPCï¼Ÿ

å½“ç³»ç»Ÿå¯¹æ€§èƒ½è¦æ±‚æé«˜ï¼ˆå¦‚é‡‘èäº¤æ˜“ã€å®æ—¶é£æ§ã€é«˜é¢‘æŸ¥è¯¢ï¼‰ï¼Œä¼ ç»Ÿ REST/JSON æ¨¡å¼å­˜åœ¨ä»¥ä¸‹ç“¶é¢ˆï¼š

- æ–‡æœ¬è§£æå¼€é”€å¤§ï¼ˆJSON â†’ Objectï¼‰
- ä¼ è¾“ä½“ç§¯å¤§
- ä¸æ”¯æŒåŒå‘æµã€æœåŠ¡å™¨æ¨é€

gRPC åŸºäº **HTTP/2 + Protocol Buffers**ï¼Œå…·å¤‡ä»¥ä¸‹ä¼˜åŠ¿ï¼š

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **é«˜æ€§èƒ½** | Protobuf åºåˆ—åŒ–é€Ÿåº¦å¿«ï¼Œä½“ç§¯å°ï¼ˆæ¯” JSON å° 3~10 å€ï¼‰ |
| **å¤šè¯­è¨€æ”¯æŒ** | æ”¯æŒ Javaã€Goã€Pythonã€C++ã€Node.js ç­‰ |
| **æµå¼é€šä¿¡** | æ”¯æŒå®¢æˆ·ç«¯æµã€æœåŠ¡å™¨æµã€åŒå‘æµ |
| **å¼ºç±»å‹å¥‘çº¦** | `.proto` æ–‡ä»¶ä½œä¸ºæ¥å£å¥‘çº¦ï¼Œé¿å…å‰åç«¯ä¸ä¸€è‡´ |

---

#### 8.2.2 gRPC å››ç§é€šä¿¡æ¨¡å¼

| æ¨¡å¼ | æè¿° | ç¤ºä¾‹åœºæ™¯ |
|------|------|----------|
| **Unary RPC** | ä¸€é—®ä¸€ç­” | æŸ¥è¯¢è®¢å•è¯¦æƒ… |
| **Server Streaming RPC** | å®¢æˆ·ç«¯å‘ä¸€æ¬¡ï¼ŒæœåŠ¡ç«¯è¿”å›å¤šä¸ªæ¶ˆæ¯ | å®æ—¶æ—¥å¿—æ¨é€ |
| **Client Streaming RPC** | å®¢æˆ·ç«¯å‘å¤šä¸ªæ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯å›å¤ä¸€æ¬¡ | æ‰¹é‡ä¸Šä¼ æ•°æ® |
| **Bidirectional Streaming RPC** | åŒå‘æŒç»­é€šä¿¡ | èŠå¤©å®¤ã€å®æ—¶éŸ³è§†é¢‘ä¿¡ä»¤ |

---

#### 8.2.3 Java é›†æˆæ–¹æ¡ˆï¼ˆgRPC-Spring-Boot-Starterï¼‰

æ¨èä½¿ç”¨ [yidongnan/grpc-spring-boot-starter](https://github.com/yidongnan/grpc-spring-boot-starter)ï¼Œç®€åŒ– Spring Boot é›†æˆã€‚

##### æ­¥éª¤ 1ï¼šå®šä¹‰ `.proto` æ–‡ä»¶
```proto
syntax = "proto3";

package com.example.grpc;

service OrderService {
  rpc GetOrder (GetOrderRequest) returns (OrderResponse);
  rpc StreamOrders (StreamRequest) returns (stream OrderResponse);
}

message GetOrderRequest {
  string order_id = 1;
}

message OrderResponse {
  string order_id = 1;
  string status = 2;
  double amount = 3;
}
```

##### æ­¥éª¤ 2ï¼šç”Ÿæˆä»£ç 
```bash
protoc --plugin=protoc-gen-grpc-java --java_out=. --grpc-java_out=. order.proto
```

##### æ­¥éª¤ 3ï¼šæœåŠ¡ç«¯å®ç°
```java
@GRpcService
public class OrderGrpcServiceImpl extends OrderServiceGrpc.OrderServiceImplBase {
    @Override
    public void getOrder(GetOrderRequest request, StreamObserver<OrderResponse> responseObserver) {
        OrderResponse response = OrderResponse.newBuilder()
            .setOrderId(request.getOrderId())
            .setStatus("PAID")
            .setAmount(99.9)
            .build();
        responseObserver.onNext(response);
        responseObserver.onCompleted();
    }
}
```

##### æ­¥éª¤ 4ï¼šå®¢æˆ·ç«¯è°ƒç”¨
```java
@GrpcClient("order-service")
private OrderServiceBlockingStub orderServiceStub;

public OrderResponse getOrder(String id) {
    GetOrderRequest request = GetOrderRequest.newBuilder().setOrderId(id).build();
    return orderServiceStub.getOrder(request);
}
```

##### é…ç½®æ–‡ä»¶ï¼š
```yaml
grpc:
  client:
    order-service:
      address: dns:///order-service-headless
      enableKeepAlive: true
      keepAliveWithoutCalls: true
```

---

#### 8.2.4 æ€§èƒ½å‹æµ‹å¯¹æ¯”ï¼ˆFeign vs gRPCï¼‰

| æŒ‡æ ‡ | Feign (JSON) | gRPC (Protobuf) |
|------|---------------|------------------|
| QPSï¼ˆå•å®ä¾‹ï¼‰ | ~1,800 | ~6,500 |
| å¹³å‡å»¶è¿Ÿ | 8ms | 2.3ms |
| CPU å ç”¨ | è¾ƒé«˜ï¼ˆJSON è§£æï¼‰ | ä½ |
| å†…å­˜å ç”¨ | é«˜ | ä½ |
| é€‚ç”¨åœºæ™¯ | æ™®é€šä¸šåŠ¡è°ƒç”¨ | é«˜é¢‘ã€å¤§æ•°æ®é‡ã€ä½å»¶è¿Ÿåœºæ™¯ |

> âœ… å»ºè®®ï¼šæ ¸å¿ƒé“¾è·¯ã€æ”¯ä»˜ã€é£æ§ç­‰æ¨¡å—ä¼˜å…ˆä½¿ç”¨ gRPCã€‚

---

### 8.3 å¼‚æ­¥æ¶ˆæ¯é€šä¿¡ï¼šåŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„è§£è€¦è®¾è®¡

å¯¹äºéå®æ—¶ã€å¯å®¹å¿å»¶è¿Ÿçš„æ“ä½œï¼Œåº”é‡‡ç”¨**å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶**è¿›è¡ŒæœåŠ¡è§£è€¦ã€‚

#### 8.3.1 å…¸å‹åº”ç”¨åœºæ™¯

| åœºæ™¯ | è¯´æ˜ |
|------|------|
| è®¢å•åˆ›å»ºåé€šçŸ¥åº“å­˜æ‰£å‡ | é¿å…åŒæ­¥é˜»å¡ |
| ç”¨æˆ·æ³¨å†Œåå‘é€æ¬¢è¿é‚®ä»¶ | å¼‚æ­¥æ‰§è¡Œè€—æ—¶ä»»åŠ¡ |
| æ—¥å¿—èšåˆä¸åˆ†æ | æ‰¹é‡å†™å…¥ Elasticsearch |
| äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰ | è®°å½•çŠ¶æ€å˜æ›´äº‹ä»¶ |

---

#### 8.3.2 ä¸»æµæ¶ˆæ¯ä¸­é—´ä»¶å¯¹æ¯”

| ä¸­é—´ä»¶ | åè®® | ååé‡ | æ¶ˆæ¯å¯é æ€§ | é€‚ç”¨åœºæ™¯ |
|--------|------|---------|-------------|----------|
| Kafka | è‡ªå®šä¹‰äºŒè¿›åˆ¶ | æé«˜ï¼ˆç™¾ä¸‡çº§TPSï¼‰ | é«˜ï¼ˆæŒä¹…åŒ–+å‰¯æœ¬ï¼‰ | å¤§æ•°æ®ã€æ—¥å¿—ã€æµå¤„ç† |
| RabbitMQ | AMQP | ä¸­ç­‰ | é«˜ï¼ˆç¡®è®¤æœºåˆ¶ï¼‰ | é€šç”¨æ¶ˆæ¯ã€ä»»åŠ¡é˜Ÿåˆ— |
| RocketMQ | OpenMessaging | é«˜ | é«˜ï¼ˆäº‹åŠ¡æ¶ˆæ¯ï¼‰ | ç”µå•†ã€é‡‘èç±»ç³»ç»Ÿ |
| Pulsar | Pub/Sub + Queue | é«˜ | é«˜ï¼ˆåˆ†å±‚å­˜å‚¨ï¼‰ | å¤šç§Ÿæˆ·ã€äº‘åŸç”Ÿ |

> æ¨èé€‰æ‹©ï¼šKafkaï¼ˆæ—¥å¿—/äº‹ä»¶æµï¼‰ã€RocketMQï¼ˆäº‹åŠ¡æ¶ˆæ¯ï¼‰ã€RabbitMQï¼ˆè½»é‡çº§ä»»åŠ¡ï¼‰

---

#### 8.3.3 Spring é›†æˆç¤ºä¾‹ï¼ˆKafkaï¼‰

##### ç”Ÿäº§è€…ï¼š
```java
@Service
public class OrderEventPublisher {
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;

    public void publishOrderCreated(String orderId, String userId) {
        String event = "{\"orderId\":\"" + orderId + "\",\"userId\":\"" + userId + "\"}";
        kafkaTemplate.send("topic.order.created", orderId, event);
    }
}
```

##### æ¶ˆè´¹è€…ï¼š
```java
@Component
public class InventoryConsumer {
    @KafkaListener(topics = "topic.order.created")
    public void consume(String message) {
        // æ‰£å‡åº“å­˜é€»è¾‘
    }
}
```

##### é…ç½®ï¼š
```yaml
spring:
  kafka:
    bootstrap-servers: kafka:9092
    consumer:
      group-id: inventory-group
      auto-offset-reset: earliest
```

---

#### 8.3.4 æ¶ˆæ¯å¹‚ç­‰æ€§ä¸é¡ºåºæ€§ä¿éšœ

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| æ¶ˆæ¯é‡å¤æ¶ˆè´¹ | æ¶ˆè´¹ç«¯è®°å½•å·²å¤„ç† messageIdï¼ˆRedisï¼‰ |
| æ¶ˆæ¯ä¹±åº | å• partition + key åˆ†åŒºï¼ˆå¦‚ orderIdï¼‰ |
| æ¶ˆæ¯ä¸¢å¤± | ç”Ÿäº§è€… ACK=allï¼Œæ¶ˆè´¹è€…æ‰‹åŠ¨æäº¤ offset |

---

### 8.4 æœåŠ¡ç½‘æ ¼ï¼ˆIstioï¼‰ï¼šä¸‹ä¸€ä»£æœåŠ¡é€šä¿¡åŸºç¡€è®¾æ–½

#### 8.4.1 ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼ï¼Ÿ

æœåŠ¡ç½‘æ ¼æ˜¯ä¸€ç§**åŸºç¡€è®¾æ–½å±‚**ï¼Œç”¨äºå¤„ç†æœåŠ¡é—´é€šä¿¡ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†æµé‡æ²»ç†èƒ½åŠ›ä»åº”ç”¨ä»£ç ä¸­å‰¥ç¦»ï¼Œä¸‹æ²‰åˆ°ç‹¬ç«‹çš„ä»£ç†å±‚ï¼ˆSidecarï¼‰ã€‚

å…¸å‹æ¶æ„ï¼š**Istio + Envoy**

```
[pod] â†’ [app container] â†” [envoy sidecar] â†” network
```

æ‰€æœ‰è¿›å‡ºæµé‡å‡ç»è¿‡ Envoy ä»£ç†ã€‚

---

#### 8.4.2 æ ¸å¿ƒèƒ½åŠ›ä¸€è§ˆ

| èƒ½åŠ› | è¯´æ˜ |
|------|------|
| **æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡** | åŸºäº Pilot ä¸‹å‘è·¯ç”±è§„åˆ™ |
| **mTLS åŠ å¯†** | è‡ªåŠ¨å¯ç”¨åŒå‘ TLSï¼Œä¿éšœå†…ç½‘é€šä¿¡å®‰å…¨ |
| **æµé‡ç®¡ç†** | æ”¯æŒé‡‘ä¸é›€å‘å¸ƒã€è“ç»¿éƒ¨ç½²ã€æ•…éšœæ³¨å…¥ |
| **ç†”æ–­ä¸é‡è¯•** | åœ¨ä»£ç†å±‚å®ç°ï¼Œæ— éœ€ä¿®æ”¹ä»£ç  |
| **å¯è§‚æµ‹æ€§** | è‡ªåŠ¨ç”ŸæˆæŒ‡æ ‡ã€æ—¥å¿—ã€é“¾è·¯è¿½è¸ªï¼ˆMixer/Telemetry V2ï¼‰ |

---

#### 8.4.3 æµé‡æ²»ç†ç¤ºä¾‹ï¼šç°åº¦å‘å¸ƒ

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: order-service
spec:
  hosts:
    - order-service
  http:
    - match:
        - headers:
            x-version:
              exact: v2
      route:
        - destination:
            host: order-service
            subset: v2
    - route:
        - destination:
            host: order-service
            subset: v1
```

> è¡¨ç¤ºï¼šæºå¸¦ `x-version: v2` çš„è¯·æ±‚è½¬å‘åˆ° v2 ç‰ˆæœ¬ï¼Œå…¶ä½™èµ° v1ã€‚

---

#### 8.4.4 é€‚ç”¨åœºæ™¯ä¸æˆæœ¬è¯„ä¼°

| ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|
| âœ”ï¸ æµé‡æ²»ç†ä¸ä¸šåŠ¡è§£è€¦ | âŒ è¿ç»´å¤æ‚åº¦é«˜ |
| âœ”ï¸ ç»Ÿä¸€å®‰å…¨ç­–ç•¥ï¼ˆmTLSï¼‰ | âŒ èµ„æºæ¶ˆè€—å¢åŠ ï¼ˆæ¯ä¸ª Pod å¤šä¸€ä¸ª Sidecarï¼‰ |
| âœ”ï¸ æ”¯æŒç»†ç²’åº¦ç°åº¦å‘å¸ƒ | âŒ å­¦ä¹ æ›²çº¿é™¡å³­ |
| âœ”ï¸ å¤šè¯­è¨€æ— ä¾µå…¥ | âŒ æ•…éšœæ’æŸ¥éš¾åº¦ä¸Šå‡ |

> âœ… é€‚ç”¨è§„æ¨¡ï¼š**50+ å¾®æœåŠ¡**ï¼Œå›¢é˜Ÿå…·å¤‡ Kubernetes å’Œç½‘ç»œçŸ¥è¯†å‚¨å¤‡ã€‚

---

### 8.5 é€šä¿¡æ¨¡å¼é€‰å‹å†³ç­–æ ‘

```text
                             å¼€å§‹
                               â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                               â”‚
       æ˜¯å¦è¦æ±‚å®æ—¶å“åº”ï¼Ÿ                æ˜¯å¦ä¸ºè·¨è¯­è¨€è°ƒç”¨ï¼Ÿ
               â”‚                               â”‚
             YES                              YES
               â”‚                               â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                   â”‚           â”‚                   â”‚
æ•°æ®é‡å°ä¸”é¢‘ç‡ä½ï¼Ÿ   æ•°æ®é‡å¤§æˆ–é«˜é¢‘ï¼Ÿ     å¿…é¡»é«˜æ€§èƒ½ï¼Ÿ     å¯æ¥å—ä¸€èˆ¬æ€§èƒ½ï¼Ÿ
     â”‚                   â”‚           â”‚                   â”‚
    YES                 NO           YES                 NO
     â”‚                   â”‚           â”‚                   â”‚
  ä½¿ç”¨ Feign        ä½¿ç”¨ gRPC       ä½¿ç”¨ gRPC         ä½¿ç”¨ Feign
     â”‚                   â”‚           â”‚                   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚             â”‚                   â”‚
éœ€å¼ºä¸€è‡´æ€§ï¼Ÿ   å¯æ¥å—æœ€ç»ˆä¸€è‡´æ€§ï¼Ÿ   éœ€è¦è§£è€¦ & å¼‚æ­¥ï¼Ÿ   éœ€è¦é›†ä¸­æ²»ç†ï¼Ÿ
       â”‚               â”‚             â”‚                   â”‚
      YES             NO             YES                 NO
       â”‚               â”‚             â”‚                   â”‚
   ç›´æ¥è°ƒç”¨      æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafkaï¼‰   æ¶ˆæ¯é˜Ÿåˆ—           æœåŠ¡ç½‘æ ¼ï¼ˆIstioï¼‰
```

---

### 8.6 ä¸Šä¸‹æ–‡ä¼ é€’ä¸é“¾è·¯è¿½è¸ªé›†æˆ

æ— è®ºé‡‡ç”¨å“ªç§é€šä¿¡æ–¹å¼ï¼Œéƒ½å¿…é¡»ä¿è¯**è®¤è¯ä¸Šä¸‹æ–‡ã€Trace IDã€Tenant ID ç­‰ä¿¡æ¯çš„é€ä¼ **ã€‚

#### 8.6.1 HTTP Header é€ä¼ ï¼ˆFeign/gRPCï¼‰

```java
@Bean
public RequestInterceptor requestInterceptor() {
    return template -> {
        ReactorContext context = ReactorContext.current();
        if (context != null) {
            String userId = context.getOrDefault("userId", "");
            String traceId = context.getOrDefault("traceId", "");

            template.header("X-User-ID", userId);
            template.header("Trace-ID", traceId);
        }
    };
}
```

gRPC ä¸­ä½¿ç”¨ `ClientInterceptor` å®ç°ç±»ä¼¼åŠŸèƒ½ã€‚

#### 8.6.2 æ¶ˆæ¯å¤´é€ä¼ ï¼ˆKafkaï¼‰

ç”Ÿäº§è€…æ·»åŠ å¤´ä¿¡æ¯ï¼š
```java
ProducerRecord<String, String> record = new ProducerRecord<>(topic, key, value);
record.headers().add("X-User-ID", userId.getBytes());
kafkaTemplate.send(record);
```

æ¶ˆè´¹è€…è¯»å–ï¼š
```java
@KafkaListener(topics = "...")
public void listen(ConsumerRecord<String, String> record) {
    String userId = new String(record.headers().lastHeader("X-User-ID").value());
}
```

---

### 8.7 å°ç»“ï¼šå†…ç½‘é€šä¿¡è®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **æŒ‰éœ€é€‰å‹** | ä¸è¦â€œä¸€åˆ€åˆ‡â€ï¼Œæ ¹æ®æ€§èƒ½ã€å»¶è¿Ÿã€ä¸€è‡´æ€§è¦æ±‚é€‰æ‹©åˆé€‚åè®® |
| **é¿å…å¾ªç¯ä¾èµ–** | é€šè¿‡äº‹ä»¶é©±åŠ¨æ‰“ç ´å¼ºä¾èµ– |
| **ç»Ÿä¸€ä¸Šä¸‹æ–‡ä¼ é€’** | æ‰€æœ‰é€šä¿¡æ–¹å¼éƒ½åº”æ”¯æŒ Trace IDã€ç”¨æˆ·èº«ä»½ç­‰ä¸Šä¸‹æ–‡é€ä¼  |
| **å…³æ³¨å¯è§‚æµ‹æ€§** | æ‰€æœ‰è°ƒç”¨é“¾å¿…é¡»å¯è¿½è¸ªã€å¯ç›‘æ§ã€å¯å‘Šè­¦ |
| **é€æ­¥æ¼”è¿›** | åˆæœŸå¯ç”¨ Feign + MQï¼ŒåæœŸå†å¼•å…¥ gRPC æˆ–æœåŠ¡ç½‘æ ¼ |

---

## 9 å®‰å…¨æ€§è®¾è®¡è§„èŒƒ

åœ¨åˆ†å¸ƒå¼å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œç³»ç»Ÿçš„æ”»å‡»é¢æ˜¾è‘—æ‰©å¤§ï¼šä»å…¬ç½‘å…¥å£åˆ°å†…éƒ¨æœåŠ¡è°ƒç”¨ï¼Œä»APIæ¥å£åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»»ä½•ä¸€ä¸ªç¯èŠ‚çš„ç–å¿½éƒ½å¯èƒ½å¯¼è‡´æ•°æ®æ³„éœ²ã€æœåŠ¡ç˜«ç—ªæˆ–ä¸šåŠ¡æŸå¤±ã€‚å› æ­¤ï¼Œå¿…é¡»å»ºç«‹**å¤šå±‚æ¬¡ã€çºµæ·±é˜²å¾¡çš„å®‰å…¨ä½“ç³»**ï¼Œç¡®ä¿ç³»ç»Ÿåœ¨è®¾è®¡ã€å¼€å‘ã€éƒ¨ç½²å’Œè¿ç»´å„é˜¶æ®µå‡å…·å¤‡è¶³å¤Ÿçš„å®‰å…¨èƒ½åŠ›ã€‚

æœ¬ç« å°†å›´ç»• **â€œè¾¹ç•Œé˜²æŠ¤ + å†…éƒ¨åŠ å›º + æŒç»­ç›‘æ§â€** çš„æ ¸å¿ƒç†å¿µï¼Œè¯¦ç»†é˜è¿°åŸºäº Spring Cloud Gateway åŠå…¶ä¸Šä¸‹æ¸¸ç»„ä»¶çš„å®‰å…¨å®è·µã€‚

---

### 9.1 ä¼ è¾“å±‚å®‰å…¨ï¼ˆHTTPS / mTLSï¼‰

#### 9.1.1 å…¬ç½‘é€šä¿¡ï¼šå¼ºåˆ¶å¯ç”¨ HTTPS

æ‰€æœ‰å¯¹å¤–æš´éœ²çš„ API æ¥å£å¿…é¡»é€šè¿‡ HTTPS åŠ å¯†ä¼ è¾“ï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»ï¼ˆMITMï¼‰ã€çªƒå¬ä¸ç¯¡æ”¹ã€‚

##### å®æ–½è¦æ±‚ï¼š
- ä½¿ç”¨ TLS 1.2 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆç¦ç”¨ SSLv3ã€TLS 1.0/1.1ï¼‰ï¼›
- é…ç½®å¼ºåŠ å¯†å¥—ä»¶ï¼ˆå¦‚ `ECDHE-RSA-AES256-GCM-SHA384`ï¼‰ï¼›
- å¯ç”¨ OCSP Stapling æå‡è¯ä¹¦éªŒè¯æ•ˆç‡ï¼›
- ä½¿ç”¨å¯ä¿¡ CA ç­¾å‘è¯ä¹¦ï¼ˆLet's Encryptã€DigiCertã€GlobalSignï¼‰ï¼›

> âœ… ç”Ÿäº§ç¯å¢ƒç¦æ­¢ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ã€‚

##### åœ¨ Spring Boot ä¸­é…ç½®ï¼š
```yaml
server:
  ssl:
    enabled: true
    key-store-type: PKCS12
    key-store: classpath:keystore.p12
    key-store-password: changeit
    key-alias: tomcat
```

##### è´Ÿè½½å‡è¡¡å™¨å±‚é¢å»ºè®®ï¼š
- åœ¨ ALB/SLB/Nginx å±‚ç»ˆæ­¢ HTTPSï¼ˆSSL å¸è½½ï¼‰ï¼Œå‡è½»åç«¯å‹åŠ›ï¼›
- åç«¯ç½‘å…³é›†ç¾¤é—´é€šä¿¡ä»å»ºè®®ä½¿ç”¨ HTTPS æˆ– mTLSã€‚

---

#### 9.1.2 å†…ç½‘é€šä¿¡ï¼šæ¨èå¯ç”¨ mTLSï¼ˆåŒå‘ TLSï¼‰

å¯¹äºé«˜å®‰å…¨ç­‰çº§ç³»ç»Ÿï¼ˆå¦‚é‡‘èã€åŒ»ç–—ã€æ”¿åŠ¡ï¼‰ï¼Œåº”å¯ç”¨ **mTLSï¼ˆMutual TLSï¼‰**ï¼Œå®ç°æœåŠ¡é—´çš„åŒå‘èº«ä»½è®¤è¯ã€‚

##### å·¥ä½œåŸç†ï¼š
- å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å‡æŒæœ‰ç”±ç§æœ‰ CA ç­¾å‘çš„è¯ä¹¦ï¼›
- æ¡æ‰‹æ—¶åŒæ–¹äº’ç›¸éªŒè¯å¯¹æ–¹è¯ä¹¦åˆæ³•æ€§ï¼›
- æˆåŠŸå»ºç«‹åŠ å¯†é€šé“åæ‰å…è®¸é€šä¿¡ã€‚

##### ä¼˜åŠ¿ï¼š
- é˜²æ­¢éæ³•æœåŠ¡æ¥å…¥å†…ç½‘ï¼›
- æŠµå¾¡ä¸­é—´äººæ”»å‡»ï¼›
- å®ç°ç»†ç²’åº¦çš„æœåŠ¡èº«ä»½è¯†åˆ«ã€‚

##### å®ç°æ–¹å¼ï¼š
- æ‰‹åŠ¨ç®¡ç†è¯ä¹¦åˆ†å‘ï¼ˆé€‚ç”¨äºå°è§„æ¨¡ç³»ç»Ÿï¼‰ï¼›
- ä½¿ç”¨ **Istio + Citadel** è‡ªåŠ¨ç­¾å‘ä¸è½®æ¢è¯ä¹¦ï¼›
- ä½¿ç”¨ **HashiCorp Vault** æä¾›åŠ¨æ€ PKI æœåŠ¡ã€‚

> âš ï¸ æ³¨æ„ï¼šmTLS ä¼šå¢åŠ è¿æ¥å»ºç«‹å¼€é”€ï¼Œéœ€è¯„ä¼°æ€§èƒ½å½±å“ã€‚

---

#### 9.1.3 è¯ä¹¦ç”Ÿå‘½å‘¨æœŸç®¡ç†

| é˜¶æ®µ | æœ€ä½³å®è·µ |
|------|----------|
| **ç­¾å‘** | ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·ï¼ˆå¦‚ Cert-Managerï¼‰é›†æˆ Let's Encrypt æˆ–ç§æœ‰ CA |
| **éƒ¨ç½²** | å°†è¯ä¹¦æŒ‚è½½ä¸º Kubernetes Secret æˆ–é…ç½®ä¸­å¿ƒåŠ å¯†å­˜å‚¨ |
| **è½®æ¢** | è®¾ç½®è‡ªåŠ¨ç»­æœŸä»»åŠ¡ï¼ˆLet's Encrypt æ¯ 90 å¤©æ›´æ–°ä¸€æ¬¡ï¼‰ |
| **åŠé”€** | å»ºç«‹ CRLï¼ˆè¯ä¹¦åŠé”€åˆ—è¡¨ï¼‰æœºåˆ¶ï¼ŒåŠæ—¶é€šçŸ¥å·²å¤±æ•ˆè¯ä¹¦ |

---

### 9.2 è¾“å…¥éªŒè¯ä¸å‚æ•°è¿‡æ»¤

ä»»ä½•æœªç»éªŒè¯çš„è¾“å…¥éƒ½æ˜¯æ½œåœ¨çš„å®‰å…¨å¨èƒã€‚åº”åœ¨ç½‘å…³å±‚å®æ–½ä¸¥æ ¼çš„è¯·æ±‚æ ¡éªŒï¼Œä½œä¸ºç¬¬ä¸€é“é˜²çº¿ã€‚

#### 9.2.1 å¸¸è§æ”»å‡»ç±»å‹åŠé˜²å¾¡

| æ”»å‡»ç±»å‹ | ç‰¹å¾ | é˜²å¾¡æªæ–½ |
|--------|------|----------|
| SQL æ³¨å…¥ | `' OR 1=1 --` | å‚æ•°åŒ–æŸ¥è¯¢ã€WAF è§„åˆ™æ‹¦æˆª |
| XSS è·¨ç«™è„šæœ¬ | `<script>alert(1)</script>` | HTML è½¬ä¹‰ã€CSP å¤´é™åˆ¶ |
| å‘½ä»¤æ³¨å…¥ | `; rm -rf /` | ç¦æ­¢ç‰¹æ®Šå­—ç¬¦ã€ç™½åå•è¿‡æ»¤ |
| è·¯å¾„éå† | `../../../etc/passwd` | æ ¡éªŒè·¯å¾„æ˜¯å¦åˆæ³• |
| XML å®ä½“è†¨èƒ€ | XXE æ”»å‡» | ç¦ç”¨ DTD è§£æ |

---

#### 9.2.2 ç½‘å…³å±‚è¾“å…¥æ ¡éªŒå®ç°

##### æ–¹å¼ä¸€ï¼šå†…ç½®æ–­è¨€ + æ­£åˆ™åŒ¹é…
```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://USER-SERVICE
          predicates:
            - Path=/user/**
            - Header=Authorization, Bearer [a-zA-Z0-9\-\._~]+\.[a-zA-Z0-9\-\._~]+\.[a-zA-Z0-9\-_]+
            - Query=id, ^[0-9]{1,10}$  # ID å¿…é¡»æ˜¯ 1~10 ä½æ•°å­—
```

##### æ–¹å¼äºŒï¼šè‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨
```java
@Component
public class InputValidationFilter implements GlobalFilter, Ordered {

    private static final Pattern SQL_INJECTION_PATTERN = 
        Pattern.compile("(?i)(union\\s+select|insert\\s+into|drop\\s+table|delete\\s+from)");

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        String path = request.getURI().getPath();
        MultiValueMap<String, String> queryParams = request.getQueryParams();

        // æ£€æŸ¥è·¯å¾„
        if (path.contains("..") || path.contains("%")) {
            return reject(exchange, "Invalid path");
        }

        // æ£€æŸ¥æŸ¥è¯¢å‚æ•°
        for (List<String> values : queryParams.values()) {
            for (String value : values) {
                if (SQL_INJECTION_PATTERN.matcher(value).find()) {
                    return reject(exchange, "Potential SQL injection detected");
                }
                if (value.contains("<script>") || value.contains("javascript:")) {
                    return reject(exchange, "XSS attempt detected");
                }
            }
        }

        return chain.filter(exchange);
    }

    private Mono<Void> reject(ServerWebExchange exchange, String message) {
        exchange.getResponse().setStatusCode(HttpStatus.BAD_REQUEST);
        // è¿”å› JSON é”™è¯¯å“åº”
        ...
        return exchange.getResponse().setComplete();
    }

    @Override
    public int getOrder() {
        return 0;
    }
}
```

---

#### 9.2.3 ç»“åˆ WAF è¿›ä¸€æ­¥å¼ºåŒ–

å³ä½¿ç½‘å…³åšäº†åŸºç¡€æ ¡éªŒï¼Œä»å»ºè®®åœ¨å…¬ç½‘ LB å‰éƒ¨ç½²ä¸“ä¸š WAFï¼ˆå¦‚ AWS WAFã€Cloudflareã€ModSecurityï¼‰ï¼Œæä¾›ä»¥ä¸‹èƒ½åŠ›ï¼š

- å®æ—¶æ›´æ–°çš„æ”»å‡»æŒ‡çº¹åº“ï¼›
- Bot æµé‡è¯†åˆ«ä¸æ‹¦æˆªï¼›
- CC æ”»å‡»é˜²æŠ¤ï¼ˆHTTP Floodï¼‰ï¼›
- è‡ªå®šä¹‰è§„åˆ™å¼•æ“ï¼ˆå¦‚é™åˆ¶å• IP è¯·æ±‚é¢‘ç‡ï¼‰ï¼›

---

### 9.3 é˜²é‡æ”¾æ”»å‡»ä¸æ—¶é—´æˆ³æ ¡éªŒ

#### 9.3.1 ä»€ä¹ˆæ˜¯é‡æ”¾æ”»å‡»ï¼Ÿ

æ”»å‡»è€…æˆªè·åˆæ³•è¯·æ±‚ï¼ˆå¦‚æ”¯ä»˜æŒ‡ä»¤ï¼‰ï¼Œåœ¨ç¨åæ—¶é—´é‡å¤å‘é€ï¼Œå¯¼è‡´é‡å¤æ‰£æ¬¾ã€è®¢å•åˆ›å»ºç­‰é—®é¢˜ã€‚

#### 9.3.2 é˜²æŠ¤æœºåˆ¶è®¾è®¡

##### ï¼ˆ1ï¼‰æ·»åŠ æ—¶é—´æˆ³ä¸éšæœºæ•°ï¼ˆNonceï¼‰
```http
POST /api/payment HTTP/1.1
X-Timestamp: 1743600000
X-Nonce: a3f8e2b1-c9d4-4a5c-bd1e-f2c8a7d6e1b9
Authorization: Bearer eyJ...
```

##### ï¼ˆ2ï¼‰ç½‘å…³æ ¡éªŒé€»è¾‘
```java
@Component
@RequiredArgsConstructor
public class ReplayAttackFilter implements GlobalFilter, Ordered {

    private final StringRedisTemplate redisTemplate;

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        String timestampStr = request.getHeaders().getFirst("X-Timestamp");
        String nonce = request.getHeaders().getFirst("X-Nonce");

        if (timestampStr == null || nonce == null) {
            return forbidden(exchange, "Missing required headers");
        }

        long timestamp;
        try {
            timestamp = Long.parseLong(timestampStr);
        } catch (NumberFormatException e) {
            return badRequest(exchange, "Invalid timestamp");
        }

        // 1. æ£€æŸ¥æ—¶é—´åå·®ï¼ˆÂ±5åˆ†é’Ÿï¼‰
        long currentTime = System.currentTimeMillis() / 1000;
        if (Math.abs(currentTime - timestamp) > 300) {
            return forbidden(exchange, "Timestamp out of range");
        }

        // 2. æ£€æŸ¥ Nonce æ˜¯å¦å·²ä½¿ç”¨
        String cacheKey = "replay:nonce:" + nonce;
        Boolean exists = redisTemplate.hasKey(cacheKey);
        if (Boolean.TRUE.equals(exists)) {
            return forbidden(exchange, "Request already processed");
        }

        // 3. å­˜å‚¨ Nonceï¼ŒTTL = å‰©ä½™æœ‰æ•ˆæœŸï¼ˆæœ€å¤šä¿ç•™5åˆ†é’Ÿï¼‰
        redisTemplate.opsForValue().set(
            cacheKey,
            "used",
            Duration.ofSeconds(300 - Math.abs(currentTime - timestamp))
        );

        return chain.filter(exchange);
    }

    private Mono<Void> forbidden(ServerWebExchange exchange, String msg) {
        exchange.getResponse().setStatusCode(HttpStatus.FORBIDDEN);
        ...
        return exchange.getResponse().setComplete();
    }

    @Override
    public int getOrder() {
        return -2; // æ—©äºè®¤è¯è¿‡æ»¤å™¨æ‰§è¡Œ
    }
}
```

> ğŸ’¡ æç¤ºï¼šè¯¥æœºåˆ¶é€‚ç”¨äºå¹‚ç­‰æ€§è¦æ±‚é«˜çš„æ¥å£ï¼ˆæ”¯ä»˜ã€æç°ã€è®¢å•æäº¤ç­‰ï¼‰ã€‚

---

### 9.4 æ•æ„Ÿå­—æ®µè„±æ•å¤„ç†

#### 9.4.1 è„±æ•åŸåˆ™

- **æœ€å°åŒ–æš´éœ²**ï¼šä»…è¿”å›å‰ç«¯å¿…éœ€çš„æ•°æ®ï¼›
- **ä¸å¯é€†è„±æ•**ï¼šé¿å…ä½¿ç”¨ç®€å•æ›¿æ¢å¯¼è‡´ä¿¡æ¯è¿˜åŸï¼›
- **åˆ†çº§è„±æ•**ï¼šä¸åŒè§’è‰²çœ‹åˆ°ä¸åŒç¨‹åº¦çš„ä¿¡æ¯ï¼ˆå¦‚å®¢æœåªèƒ½çœ‹éƒ¨åˆ†æ‰‹æœºå·ï¼‰ï¼›

#### 9.4.2 è„±æ•å­—æ®µç¤ºä¾‹

| å­—æ®µ | æ˜æ–‡ | è„±æ•å |
|------|------|--------|
| æ‰‹æœºå· | 13812345678 | 138****5678 |
| èº«ä»½è¯å· | 110101199001011234 | 110101********1234 |
| é“¶è¡Œå¡å· | 6222080200001234 | **** **** **** 1234 |
| å§“å | å¼ ä¸‰ | *ä¸‰ æˆ– å¼ * |
| åœ°å€ | åŒ—äº¬å¸‚æœé˜³åŒºxxxè¡—é“ | åŒ—äº¬å¸‚æœé˜³åŒº |

---

#### 9.4.3 ç½‘å…³å±‚å“åº”ä½“è„±æ•å®ç°

ç”±äº Spring Cloud Gateway åŸºäº Netty å’Œ Reactorï¼Œä¿®æ”¹å“åº”ä½“éœ€ä½¿ç”¨ `ModifyResponseBodyGatewayFilterFactory`ã€‚

##### æ­¥éª¤ 1ï¼šå¯ç”¨å“åº”ä¿®æ”¹åŠŸèƒ½
```yaml
spring:
  cloud:
    gateway:
      httpserver:
        access-log-enabled: true
```

##### æ­¥éª¤ 2ï¼šæ³¨å†Œè„±æ•è¿‡æ»¤å™¨
```java
@Bean
public GlobalFilter sensitiveDataMaskingFilter() {
    return (exchange, chain) -> {
        return chain.filter(exchange)
            .then(Mono.defer(() -> {
                ServerHttpResponse response = exchange.getResponse();
                DataBuffer buffer = response.bufferFactory().allocateBuffer();
                // åœ¨æ­¤å¤„è¯»å–å¹¶ä¿®æ”¹å“åº”å†…å®¹ï¼ˆéœ€ååºåˆ—åŒ–JSONï¼‰
                // å¯ç»“åˆ Jackson ObjectMapper å®ç°å­—æ®µæ›¿æ¢
                return Mono.empty();
            }));
    };
}
```

> âš ï¸ æ³¨æ„ï¼šç›´æ¥æ“ä½œ `DataBuffer` è¾ƒå¤æ‚ï¼Œå»ºè®®åœ¨ä¸šåŠ¡æœåŠ¡å±‚å®Œæˆè„±æ•ï¼Œç½‘å…³ä»…åšå…œåº•ã€‚

##### æ›´ä¼˜æ–¹æ¡ˆï¼šç»Ÿä¸€è„±æ•æ³¨è§£ + AOP
```java
@Target(ElementType.FIELD)
@Retention(RetentionPolicy.RUNTIME)
public @interface Masked {
    MaskType value() default MaskType.PHONE;
}

// ä½¿ç”¨
public class User {
    @Masked(PHONE)
    private String phone;
}
```

é…åˆ Jackson åºåˆ—åŒ–å™¨è‡ªåŠ¨è„±æ•ã€‚

---

### 9.5 å®‰å…¨å“åº”å¤´è®¾ç½®

HTTP å“åº”å¤´æ˜¯æµè§ˆå™¨å®‰å…¨ç­–ç•¥çš„é‡è¦ä¾æ®ï¼Œåˆç†è®¾ç½®å¯æœ‰æ•ˆé˜²èŒƒå¤šç§å®¢æˆ·ç«¯æ”»å‡»ã€‚

#### 9.5.1 å…³é”®å®‰å…¨å¤´è¯¦è§£

| å“åº”å¤´ | æ¨èå€¼ | ä½œç”¨ |
|--------|--------|------|
| `X-Content-Type-Options` | `nosniff` | é˜²æ­¢ MIME ç±»å‹å—…æ¢å¯¼è‡´ XSS |
| `X-Frame-Options` | `DENY` æˆ– `SAMEORIGIN` | é˜²æ­¢ç‚¹å‡»åŠ«æŒï¼ˆClickjackingï¼‰ |
| `X-XSS-Protection` | `1; mode=block` | å¯ç”¨æµè§ˆå™¨ XSS è¿‡æ»¤å™¨ |
| `Strict-Transport-Security (HSTS)` | `max-age=31536000; includeSubDomains; preload` | å¼ºåˆ¶ HTTPSï¼Œé˜²æ­¢é™çº§æ”»å‡» |
| `Content-Security-Policy (CSP)` | `default-src 'self'; script-src 'self' 'unsafe-inline'` | æ§åˆ¶èµ„æºåŠ è½½æ¥æºï¼Œé˜²å¾¡ XSS |
| `Referrer-Policy` | `no-referrer-when-downgrade` | æ§åˆ¶ Referer ä¿¡æ¯æ³„éœ² |
| `Permissions-Policy` | `geolocation=(), camera=()` | é™åˆ¶æµè§ˆå™¨æƒé™ä½¿ç”¨ |

---

#### 9.5.2 åœ¨ Spring Cloud Gateway ä¸­é…ç½®

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: secure-route
          uri: lb://BACKEND-SERVICE
          predicates:
            - Path=/**
          filters:
            - AddResponseHeader=X-Content-Type-Options, nosniff
            - AddResponseHeader=X-Frame-Options, DENY
            - AddResponseHeader=X-XSS-Protection, 1; mode=block
            - AddResponseHeader, Strict-Transport-Security, max-age=31536000; includeSubDomains; preload
            - AddResponseHeader, Content-Security-Policy, default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'
            - AddResponseHeader, Referrer-Policy, no-referrer-when-downgrade
            - AddResponseHeader, Permissions-Policy, geolocation=(), microphone=(), camera=()
```

> âœ… å»ºè®®å¯¹æ‰€æœ‰è·¯ç”±ç»Ÿä¸€æ·»åŠ å®‰å…¨å¤´ï¼Œå¯é€šè¿‡å…¨å±€è¿‡æ»¤å™¨å®ç°ã€‚

---

### 9.6 è®¤è¯ä¸Šä¸‹æ–‡å®‰å…¨ä¼ é€’

åœ¨å¾®æœåŠ¡è°ƒç”¨é“¾ä¸­ï¼Œç”¨æˆ·èº«ä»½ä¿¡æ¯å¿…é¡»å®‰å…¨ä¼ é€’ï¼Œé¿å…è¢«ä¼ªé€ æˆ–ç¯¡æ”¹ã€‚

#### 9.6.1 å®‰å…¨ä¼ é€’æ–¹å¼å¯¹æ¯”

| æ–¹å¼ | æ˜¯å¦æ¨è | è¯´æ˜ |
|------|----------|------|
| `Authorization: Bearer <token>` | âœ… æ¨è | ä¸‹æ¸¸æœåŠ¡å¯ç‹¬ç«‹æ ¡éªŒ Token |
| `X-User-ID`, `X-Roles` ç­‰ Header | âš ï¸ è°¨æ…ä½¿ç”¨ | å¿…é¡»ç”±ç½‘å…³ç”Ÿæˆï¼Œä¸‹æ¸¸ä¸å¾—ä¿¡ä»» |
| Cookie é€ä¼  | âŒ ä¸æ¨è | å¾®æœåŠ¡é—´ä¸åº”å…±äº«ä¼šè¯ Cookie |
| è¯·æ±‚ä½“åµŒå…¥èº«ä»½ | âŒ ä¸æ¨è | æ˜“è¢«ç¯¡æ”¹ï¼Œç ´åèŒè´£åˆ†ç¦» |

#### 9.6.2 æœ€ä½³å®è·µï¼šToken é€ä¼  + Header è¡¥å……

- ç½‘å…³éªŒè¯ Token åˆæ³•æ€§ï¼›
- å°† `X-Auth-User`, `X-Auth-Roles` ç­‰åªè¯»å¤´æ³¨å…¥è¯·æ±‚ï¼›
- ä¸‹æ¸¸æœåŠ¡å¯æ ¹æ®éœ€è¦ä½¿ç”¨è¿™äº›å¤´ï¼Œä½†**ä¸ç”¨äºæƒé™åˆ¤æ–­ä¸»ä¾æ®**ï¼›
- å…³é”®æƒé™å†³ç­–ä»åº”å›è°ƒ Auth Server æˆ–æœ¬åœ°è§£æåŸå§‹ Tokenã€‚

---

### 9.7 æƒé™æ§åˆ¶æ¨¡å‹ï¼ˆABAC/RBACï¼‰

è™½ç„¶æƒé™åˆ¤æ–­é€šå¸¸ä¸åœ¨ç½‘å…³å±‚å®Œæˆï¼Œä½†ç½‘å…³å¯æ”¯æŒç²—ç²’åº¦è®¿é—®æ§åˆ¶ã€‚

#### 9.7.1 RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰

- ç”¨æˆ· â†’ è§’è‰² â†’ æƒé™
- ç¤ºä¾‹ï¼š`ADMIN` è§’è‰²å¯è®¿é—® `/admin/**`

```yaml
predicates:
  - Path=/admin/**
  - Header=X-Role, ADMIN
```

#### 9.7.2 ABACï¼ˆåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼‰

æ›´çµæ´»çš„åŠ¨æ€ç­–ç•¥ï¼Œæ”¯æŒå¤šç»´åº¦åˆ¤æ–­ï¼š

```java
- Path=/data/${tenantId}/**
- Expression: #request.getHeader("X-Tenant-ID") == #jwt.getClaim("tenant_id")
```

å¯ç»“åˆ Open Policy Agentï¼ˆOPAï¼‰å®ç°å¤–éƒ¨ç­–ç•¥å¼•æ“é›†æˆã€‚

---

### 9.8 æ—¥å¿—ä¸å®¡è®¡å®‰å…¨

#### 9.8.1 å®‰å…¨æ—¥å¿—è®°å½•è¦æ±‚

- è®°å½•æ‰€æœ‰è®¤è¯å¤±è´¥äº‹ä»¶ï¼ˆIPã€æ—¶é—´ã€ç”¨æˆ·åï¼‰ï¼›
- è®°å½•æ•æ„Ÿæ“ä½œï¼ˆåˆ é™¤ã€æ”¯ä»˜ã€æƒé™å˜æ›´ï¼‰ï¼›
- æ—¥å¿—ä¸­ç¦æ­¢è®°å½•å¯†ç ã€Token æ˜æ–‡ã€èº«ä»½è¯å·ç­‰æ•æ„Ÿä¿¡æ¯ï¼›

#### 9.8.2 å®¡è®¡æ—¥å¿—ç»“æ„åŒ–è¾“å‡º

```json
{
  "timestamp": "2025-04-05T10:00:00Z",
  "level": "AUDIT",
  "event": "LOGIN_FAILED",
  "userId": "unknown",
  "clientIp": "1.2.3.4",
  "userAgent": "Mozilla/5.0...",
  "failureReason": "INVALID_CREDENTIALS"
}
```

---

### 9.9 å°ç»“ï¼šå¾®æœåŠ¡å®‰å…¨è®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **çºµæ·±é˜²å¾¡** | å¤šå±‚è®¾é˜²ï¼ˆWAF â†’ LB â†’ Gateway â†’ Serviceï¼‰ |
| **æœ€å°æƒé™** | æ¯ä¸ªæœåŠ¡åªæ‹¥æœ‰å¿…è¦æƒé™ |
| **é›¶ä¿¡ä»»ç½‘ç»œ** | ä¸é»˜è®¤ä¿¡ä»»ä»»ä½•èŠ‚ç‚¹ï¼Œå§‹ç»ˆéªŒè¯èº«ä»½ |
| **å®‰å…¨å·¦ç§»** | åœ¨å¼€å‘é˜¶æ®µå¼•å…¥å®‰å…¨æ£€æŸ¥ï¼ˆSAST/DASTï¼‰ |
| **æŒç»­ç›‘æ§** | æ‰€æœ‰å®‰å…¨äº‹ä»¶å¯è¿½è¸ªã€å¯å‘Šè­¦ |
| **è‡ªåŠ¨åŒ–æ²»ç†** | è¯ä¹¦è½®æ¢ã€æ¼æ´æ‰«æã€åˆè§„æ£€æŸ¥è‡ªåŠ¨åŒ– |

---

## 10 é«˜å¯ç”¨ä¸æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼ˆå¢å¼ºç‰ˆï¼‰

åœ¨ç°ä»£å¾®æœåŠ¡ç³»ç»Ÿä¸­ï¼ŒSpring Cloud Gateway ä½œä¸ºæ‰€æœ‰å¤–éƒ¨æµé‡çš„ç»Ÿä¸€å…¥å£ï¼Œå…¶ç¨³å®šæ€§ä¸æ€§èƒ½ç›´æ¥å½±å“æ•´ä¸ªç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚é¢å¯¹çªå‘æµé‡ã€æ…¢è°ƒç”¨ã€ç½‘ç»œæŠ–åŠ¨ç­‰æŒ‘æˆ˜ï¼Œå¿…é¡»ä»**éƒ¨ç½²æ¶æ„ã€èµ„æºé…ç½®ã€è¿è¡Œæ—¶è°ƒä¼˜ã€ç›‘æ§é¢„è­¦**ç­‰å¤šä¸ªç»´åº¦è¿›è¡Œç³»ç»Ÿæ€§ä¼˜åŒ–ï¼Œç¡®ä¿ç½‘å…³å…·å¤‡é«˜ååã€ä½å»¶è¿Ÿã€å¼¹æ€§ä¼¸ç¼©çš„èƒ½åŠ›ã€‚

æœ¬ç« å°†å›´ç»•â€œ**ç¨³å®šä¸ºå…ˆã€æ€§èƒ½ä¸ºè¦ã€å¯è§‚æµ‹ä¸ºåŸº**â€çš„è®¾è®¡åŸåˆ™ï¼Œè¯¦ç»†é˜è¿°å¦‚ä½•æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„ API ç½‘å…³ä½“ç³»ã€‚

---

### 10.1 ç½‘å…³é›†ç¾¤éƒ¨ç½²æ¨¡å¼

#### 10.1.1 å¤šå®ä¾‹éƒ¨ç½²å¿…è¦æ€§

å•å®ä¾‹ç½‘å…³å­˜åœ¨ä»¥ä¸‹é£é™©ï¼š
- å•ç‚¹æ•…éšœï¼šä¸€æ—¦å®•æœºï¼Œå…¨ç«™ä¸å¯è®¿é—®ï¼›
- æ€§èƒ½ç“¶é¢ˆï¼šæ— æ³•åº”å¯¹çªå‘æµé‡ï¼›
- ç»´æŠ¤å›°éš¾ï¼šå‡çº§éœ€åœæœºæˆ–ç°åº¦åˆ‡æ¢å¤æ‚ã€‚

å› æ­¤ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»é‡‡ç”¨**å¤šå®ä¾‹é›†ç¾¤éƒ¨ç½²**ã€‚

##### æ¨èéƒ¨ç½²æ–¹æ¡ˆï¼š

| åœºæ™¯ | éƒ¨ç½²æ–¹å¼ |
|------|----------|
| ä¼ ç»Ÿè™šæ‹Ÿæœºç¯å¢ƒ | Nginx + Keepalived å®ç°ä¸»å¤‡ VIP |
| Kubernetes ç¯å¢ƒ | Deployment + Service + Ingress Controller |
| æ··åˆäº‘/è·¨åŒºåŸŸ | å¤šåœ°åŸŸéƒ¨ç½²ï¼Œç»“åˆ DNS è´Ÿè½½å‡è¡¡ |

---

#### 10.1.2 è·¨å¯ç”¨åŒºï¼ˆAZï¼‰é«˜å¯ç”¨è®¾è®¡

ä¸ºé˜²æ­¢å•ä¸€æœºæˆ¿æ•…éšœå¯¼è‡´æœåŠ¡ä¸­æ–­ï¼Œå»ºè®®è‡³å°‘éƒ¨ç½²ä¸¤ä¸ªå®ä¾‹ï¼Œå¹¶åˆ†å¸ƒåœ¨ä¸åŒå¯ç”¨åŒºï¼ˆAvailability Zoneï¼‰ã€‚

```
[ç”¨æˆ·] 
   â†“
[å…¬ç½‘ LB]
   â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Gateway Instance 1 â”‚ â† AZ1
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†‘
                    Heartbeat
                     â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Gateway Instance 2 â”‚ â† AZ2
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> âœ… **ä¼˜åŠ¿**ï¼š
> - æ•…éšœéš”ç¦»ï¼šä¸€å°å®•æœºä¸å½±å“æ•´ä½“æœåŠ¡ï¼›
> - åœ°ç†å®¹ç¾ï¼šæ”¯æŒè·¨åŒºåŸŸå®¹é”™ï¼›
> - è´Ÿè½½åˆ†æ‹…ï¼šè¯·æ±‚å‡åŒ€åˆ†å¸ƒã€‚

---

#### 10.1.3 Kubernetes ä¸Šçš„æ ‡å‡†éƒ¨ç½²é…ç½®ï¼ˆYAML ç¤ºä¾‹ï¼‰

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-deployment
  labels:
    app: spring-cloud-gateway
spec:
  replicas: 3
  selector:
    matchLabels:
      app: spring-cloud-gateway
  template:
    metadata:
      labels:
        app: spring-cloud-gateway
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - spring-cloud-gateway
                topologyKey: kubernetes.io/hostname
      containers:
        - name: gateway
          image: registry.example.com/gateway:latest
          ports:
            - containerPort: 8080
          resources:
            requests:
              memory: "1Gi"
              cpu: "500m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          livenessProbe:
            httpGet:
              path: /actuator/health
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /actuator/health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: gateway-service
spec:
  selector:
    app: spring-cloud-gateway
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
  type: ClusterIP
```

> âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
> - è®¾ç½®åˆç†çš„ `livenessProbe` å’Œ `readinessProbe`ï¼Œé¿å…è¯¯æ€æ­£åœ¨å¯åŠ¨çš„å®ä¾‹ï¼›
> - ä½¿ç”¨ `podAntiAffinity` å°½é‡å°† Pod åˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹ï¼›
> - å†…å­˜é™åˆ¶ä¸å®œè¿‡å°ï¼Œé˜²æ­¢é¢‘ç¹ Full GCã€‚

---

### 10.2 æ°´å¹³æ‰©å±•ä¸è‡ªåŠ¨æ‰©ç¼©å®¹ï¼ˆHPAï¼‰

#### 10.2.1 åŸºäºæŒ‡æ ‡çš„è‡ªåŠ¨æ‰©ç¼©å®¹æœºåˆ¶

Kubernetes æä¾› Horizontal Pod Autoscalerï¼ˆHPAï¼‰ï¼Œå¯æ ¹æ® CPUã€å†…å­˜æˆ–è‡ªå®šä¹‰æŒ‡æ ‡åŠ¨æ€è°ƒæ•´å‰¯æœ¬æ•°ã€‚

##### é…ç½®ç¤ºä¾‹ï¼ˆåŸºäº CPU å’Œè‡ªå®šä¹‰æŒ‡æ ‡ï¼‰ï¼š

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: gateway-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: gateway-deployment
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Pods
      pods:
        metric:
          name: http_server_requests_seconds_count
        target:
          type: AverageValue
          averageValue: "1000"  # æ¯ç§’è¯·æ±‚æ•°è¶…è¿‡1000åˆ™æ‰©å®¹
```

> ğŸ“Œ éœ€é…åˆ Prometheus Adapter å°† Micrometer æŒ‡æ ‡æš´éœ²ç»™ HPAã€‚

---

#### 10.2.2 æ‰©å®¹è§¦å‘æ¡ä»¶è®¾è®¡

| æŒ‡æ ‡ | é˜ˆå€¼ | åŠ¨ä½œ | è§¦å‘é¢‘ç‡ |
|------|------|------|-----------|
| CPU ä½¿ç”¨ç‡ | > 70% æŒç»­ 2 åˆ†é’Ÿ | å¢åŠ å‰¯æœ¬ | æ¯ 15 ç§’è¯„ä¼°ä¸€æ¬¡ |
| å†…å­˜ä½¿ç”¨ç‡ | > 80% | å‘Šè­¦å¹¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼ | â€”â€” |
| è¯·æ±‚å»¶è¿Ÿ P99 | > 500ms æŒç»­ 3 åˆ†é’Ÿ | æ‰©å®¹ + å‘Šè­¦ | ç»“åˆå‘Šè­¦å¹³å° |
| é”™è¯¯ç‡ | > 1% æŒç»­ 5 åˆ†é’Ÿ | å‘Šè­¦ + å›æ»šæ£€æŸ¥ | â€”â€” |
| QPS å³°å€¼ | æ¥è¿‘å½“å‰å®¹é‡ä¸Šé™ | æå‰æ‰©å®¹ | å¯ç»“åˆé¢„æµ‹æ¨¡å‹ |

> ğŸ’¡ å»ºè®®è®¾ç½®â€œå†·å´æœŸâ€ï¼ˆcoolDownPeriodï¼‰ï¼Œé˜²æ­¢éœ‡è¡æ‰©ç¼©å®¹ã€‚

---

#### 10.2.3 æ‰‹åŠ¨é¢„æ‰©å®¹ç­–ç•¥ï¼ˆå¤§ä¿ƒåœºæ™¯ï¼‰

å¯¹äºç”µå•†ã€ç›´æ’­ç­‰æœ‰æ˜ç¡®é«˜å³°æ—¶æ®µçš„ä¸šåŠ¡ï¼Œåº”æå‰æ‰‹åŠ¨æ‰©å®¹ï¼š

- å¤§ä¿ƒå‰ 1 å°æ—¶å°†å‰¯æœ¬æ•°æå‡è‡³å³°å€¼éœ€æ±‚çš„ 1.5 å€ï¼›
- æ´»åŠ¨ç»“æŸåé€æ­¥ç¼©å®¹ï¼Œé¿å…èµ„æºæµªè´¹ï¼›
- é…åˆè“ç»¿å‘å¸ƒæˆ–é‡‘ä¸é›€éƒ¨ç½²é™ä½å˜æ›´é£é™©ã€‚

---

### 10.3 è¿æ¥æ± ä¼˜åŒ–ï¼ˆNetty EventLoop é…ç½®ï¼‰

Spring Cloud Gateway åŸºäº **Netty** æ„å»ºï¼Œé‡‡ç”¨éé˜»å¡ I/O æ¨¡å‹ï¼Œå…·å¤‡é«˜å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚ä½†è‹¥é…ç½®ä¸å½“ï¼Œä»å¯èƒ½å‡ºç°çº¿ç¨‹äº‰ç”¨ã€è¿æ¥è€—å°½ç­‰é—®é¢˜ã€‚

#### 10.3.1 Netty æ ¸å¿ƒç»„ä»¶è§£æ

| ç»„ä»¶ | è¯´æ˜ |
|------|------|
| `EventLoopGroup` | è´Ÿè´£äº‹ä»¶å¾ªç¯ï¼Œå¤„ç† I/O æ“ä½œï¼ˆå¦‚ acceptã€readã€writeï¼‰ |
| `Channel` | æŠ½è±¡çš„è¿æ¥é€šé“ |
| `ByteBuf` | é«˜æ•ˆçš„ç¼“å†²åŒºç®¡ç† |
| `HttpClient` | WebFlux åº•å±‚ä½¿ç”¨çš„ HTTP å®¢æˆ·ç«¯ |

é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring WebFlux ä½¿ç”¨ Reactor Netty æä¾›çš„å…±äº«èµ„æºæ± ã€‚

---

#### 10.3.2 HttpClient è¿æ¥æ± é…ç½®è¯¦è§£

```yaml
spring:
  cloud:
    gateway:
      httpclient:
        # è¿æ¥æ± ç±»å‹
        pool:
          type: ELASTIC           # å¼¹æ€§æ± ï¼ˆæŒ‰éœ€åˆ›å»ºï¼‰
          # type: FIXED           # å›ºå®šå¤§å°æ± 
          # max-size: 500         # æœ€å¤§è¿æ¥æ•°ï¼ˆä»…FIXEDæœ‰æ•ˆï¼‰
          acquire-timeout: 10000  # è·å–è¿æ¥è¶…æ—¶æ—¶é—´
          max-per-route-connections: 200  # æ¯ä¸ªè·¯ç”±æœ€å¤§è¿æ¥æ•°
          max-total-connections: 1000     # æ€»è¿æ¥ä¸Šé™
        connect-timeout: 10000            # å»ºç«‹è¿æ¥è¶…æ—¶
        response-timeout: 30s             # å“åº”ç­‰å¾…è¶…æ—¶
        proxy:                            # å¯é€‰ä»£ç†é…ç½®
          host: proxy.example.com
          port: 8080
```

##### å‚æ•°è¯´æ˜ï¼š

| å‚æ•° | é»˜è®¤å€¼ | å»ºè®®å€¼ | è¯´æ˜ |
|------|--------|--------|------|
| `type` | ELASTIC | ELASTICï¼ˆå¼€å‘ï¼‰ã€FIXEDï¼ˆç”Ÿäº§ï¼‰ | ELASTIC è‡ªåŠ¨ä¼¸ç¼©ï¼ŒFIXED æ›´ç¨³å®š |
| `max-total-connections` | Integer.MAX_VALUE | 500~2000 | æ§åˆ¶æ€»è¿æ¥æ•°ï¼Œé˜²æ­¢èµ„æºè€—å°½ |
| `max-per-route-connections` | æ— é™ | 100~500 | é˜²æ­¢å•ä¸ªåç«¯æœåŠ¡å ç”¨è¿‡å¤šè¿æ¥ |
| `acquire-timeout` | 45s | 10s | è·å–è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œé¿å…é˜»å¡ |
| `connect-timeout` | 45s | 5~10s | TCP æ¡æ‰‹è¶…æ—¶ |
| `response-timeout` | æ— é™åˆ¶ | 30s | é˜²æ­¢é•¿è¿æ¥æ‹–å®çº¿ç¨‹ |

---

#### 10.3.3 è‡ªå®šä¹‰ HttpClient Beanï¼ˆæ›´ç²¾ç»†æ§åˆ¶ï¼‰

```java
@Bean
public HttpClient customHttpClient() {
    return HttpClient.create()
        .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 10_000)
        .responseTimeout(Duration.ofSeconds(30))
        .compress(true)  // å¯ç”¨å“åº”å‹ç¼©
        .keepAlive(true)
        .metrics(true, Function.identity())  // å¯ç”¨ Micrometer æŒ‡æ ‡
        .doOnConnected(conn -> conn
            .addHandlerLast(new ReadTimeoutHandler(30))  // è¯»è¶…æ—¶
            .addHandlerLast(new WriteTimeoutHandler(30))) // å†™è¶…æ—¶
        )
        .poolResources(PoolResources.fixed("custom-pool", 50)); // å›ºå®šè¿æ¥æ± 
}
```

> âœ… ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ `fixed` æ± ä»¥å‡å°‘è¿æ¥åˆ›å»ºå¼€é”€ã€‚

---

### 10.4 å“åº”å‹ç¼©ä¸ç¼“å­˜ç­–ç•¥

#### 10.4.1 å¯ç”¨ GZIP å‹ç¼©

å¯¹æ–‡æœ¬ç±»å“åº”å¯ç”¨å‹ç¼©å¯æ˜¾è‘—å‡å°‘ä¼ è¾“ä½“ç§¯ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

##### é…ç½®æ–¹å¼ï¼š

```yaml
server:
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,application/json,application/javascript
    min-response-size: 1024  # è‡³å°‘1KBæ‰å‹ç¼©
```

##### æ•ˆæœç¤ºä¾‹ï¼š
| åŸå§‹å¤§å° | å‹ç¼©åå¤§å° | å‹ç¼©ç‡ |
|---------|------------|--------|
| 10 KB JSON | ~3 KB | 70% |
| 100 KB HTML | ~20 KB | 80% |

> âš ï¸ æ³¨æ„ï¼šå·²å‹ç¼©æ ¼å¼ï¼ˆå¦‚å›¾ç‰‡ã€è§†é¢‘ã€Protobufï¼‰ä¸åº”å†å¯ç”¨ GZIPã€‚

---

#### 10.4.2 ç¼“å­˜ç­–ç•¥è®¾è®¡

å¯¹äºå¹‚ç­‰æ€§ GET è¯·æ±‚ï¼Œå¯åœ¨å¤šä¸ªå±‚çº§å®æ–½ç¼“å­˜ï¼š

| å±‚çº§ | æŠ€æœ¯ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| CDN å±‚ | Edge Cache | é™æ€èµ„æºã€å…¬å…±æ•°æ® |
| ç½‘å…³å±‚ | Redis + GlobalFilter | åŠ¨æ€æ¥å£ç»“æœç¼“å­˜ |
| æœåŠ¡å±‚ | Caffeine / Redis | æœ¬åœ°çƒ­ç‚¹æ•°æ® |

##### ç¤ºä¾‹ï¼šç½‘å…³å±‚ç¼“å­˜è¿‡æ»¤å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰

```java
@Component
@RequiredArgsConstructor
public class ResponseCacheFilter implements GlobalFilter, Ordered {

    private final StringRedisTemplate redisTemplate;
    private final ObjectMapper objectMapper;

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        if (!request.getMethod().equals(HttpMethod.GET)) {
            return chain.filter(exchange);
        }

        String cacheKey = "cache:" + request.getURI().toString();

        // å°è¯•ä» Redis è¯»å–ç¼“å­˜
        return redisTemplate.opsForValue().get(cacheKey)
            .map(json -> {
                try {
                    LinkedCaseInsensitiveMap<Object> headers = new LinkedCaseInsensitiveMap<>();
                    headers.put("X-Cache", "HIT");
                    exchange.getResponse().getHeaders().putAll(headers);

                    byte[] bytes = json.getBytes(StandardCharsets.UTF_8);
                    DataBuffer buffer = exchange.getResponse().bufferFactory().wrap(bytes);
                    return exchange.getResponse().writeWith(Mono.just(buffer));
                } catch (Exception e) {
                    return chain.filter(exchange);
                }
            })
            .switchIfEmpty(chain.filter(exchange)
                .doOnSuccess(v -> {
                    // ç¼“å­˜æˆåŠŸå“åº”ï¼ˆå¼‚æ­¥ï¼‰
                    if (exchange.getResponse().getStatusCode() == HttpStatus.OK) {
                        exchange.getResponse().writeWith(
                            exchange.getResponse().getBody().map(dataBuffer -> {
                                byte[] bytes = new byte[dataBuffer.readableByteCount()];
                                dataBuffer.read(bytes);
                                String body = new String(bytes, StandardCharsets.UTF_8);
                                redisTemplate.opsForValue().set(cacheKey, body, Duration.ofMinutes(5));
                                return dataBuffer;
                            })
                        );
                    }
                })
            );
    }

    @Override
    public int getOrder() {
        return -1;
    }
}
```

> âš ï¸ æ³¨æ„ï¼šç¼“å­˜éœ€è€ƒè™‘ TTLã€ç¼“å­˜ç©¿é€ã€é›ªå´©ç­‰é—®é¢˜ï¼Œå»ºè®®ç»“åˆå¸ƒéš†è¿‡æ»¤å™¨å’Œéšæœºè¿‡æœŸæ—¶é—´ã€‚

---

### 10.5 æ€§èƒ½å‹æµ‹å»ºè®®ä¸ç“¶é¢ˆåˆ†æ

#### 10.5.1 å‹æµ‹å·¥å…·é€‰å‹å¯¹æ¯”

| å·¥å…· | ç±»å‹ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|----------|
| **wrk** | å‘½ä»¤è¡Œ | é«˜å¹¶å‘ã€è½»é‡çº§ã€è„šæœ¬åŒ– | ä¸æ”¯æŒå¤æ‚é€»è¾‘ | åŸºå‡†æ€§èƒ½æµ‹è¯• |
| **JMeter** | å›¾å½¢åŒ– | æ”¯æŒå‚æ•°åŒ–ã€æ–­è¨€ã€åˆ†å¸ƒå¼ | èµ„æºæ¶ˆè€—å¤§ | å¤æ‚ä¸šåŠ¡æµç¨‹å‹æµ‹ |
| **k6** | è„šæœ¬åŒ– | Go ç¼–å†™ï¼Œæ€§èƒ½å¥½ï¼ŒCI/CD å‹å¥½ | å­¦ä¹ æˆæœ¬ç•¥é«˜ | è‡ªåŠ¨åŒ–æ€§èƒ½æµ‹è¯• |
| **Gatling** | Scala DSL | é«˜æ€§èƒ½ã€æŠ¥å‘Šç¾è§‚ | é…ç½®å¤æ‚ | æŒç»­æ€§èƒ½éªŒè¯ |

---

#### 10.5.2 å‹æµ‹åœºæ™¯è®¾è®¡

| åœºæ™¯ | ç›®æ ‡ | é…ç½®ç¤ºä¾‹ |
|------|------|-----------|
| åŸºå‡†æ€§èƒ½æµ‹è¯• | æµ‹é‡æœ€å¤§ QPS | 100 å¹¶å‘ï¼ŒæŒç»­ 5 åˆ†é’Ÿ |
| çªå‘æµé‡æµ‹è¯• | éªŒè¯é™æµæ•ˆæœ | ä» 10/s å¿«é€Ÿå¢è‡³ 1000/s |
| é•¿æ—¶é—´ç¨³å®šæ€§æµ‹è¯• | æ£€æŸ¥å†…å­˜æ³„æ¼ | 100 å¹¶å‘ï¼ŒæŒç»­ 24 å°æ—¶ |
| æ•…éšœæ³¨å…¥æµ‹è¯• | éªŒè¯ç†”æ–­æœºåˆ¶ | æ¨¡æ‹Ÿåç«¯å»¶è¿Ÿ 2s æˆ–è¿”å› 500 |
| èµ„æºç«äº‰æµ‹è¯• | æ£€æŸ¥è¿æ¥æ± è¡¨ç° | å¤šå®¢æˆ·ç«¯åŒæ—¶è¯·æ±‚åŒä¸€æœåŠ¡ |

---

#### 10.5.3 å…³é”®æ€§èƒ½æŒ‡æ ‡ç›‘æ§

| æŒ‡æ ‡ | æ­£å¸¸èŒƒå›´ | å¼‚å¸¸ä¿¡å· |
|------|----------|----------|
| QPS | æ ¹æ®ç¡¬ä»¶è€Œå®šï¼ˆç›®æ ‡å€¼ï¼‰ | æ˜æ˜¾ä½äºé¢„æœŸ |
| å¹³å‡å»¶è¿Ÿ | < 100ms | > 500ms |
| P99 å»¶è¿Ÿ | < 300ms | > 1s |
| é”™è¯¯ç‡ | < 0.1% | > 1% |
| CPU ä½¿ç”¨ç‡ | < 70% | > 90% æŒç»­ |
| å†…å­˜ä½¿ç”¨ | ç¨³å®šæ³¢åŠ¨ | æŒç»­å¢é•¿ï¼ˆå†…å­˜æ³„æ¼ï¼‰ |
| GC é¢‘ç‡ | Minor GC æ­£å¸¸ï¼ŒFull GC < 1æ¬¡/å°æ—¶ | é¢‘ç¹ Full GC |

---

#### 10.5.4 ç“¶é¢ˆå®šä½æ–¹æ³•

| ç°è±¡ | å¯èƒ½åŸå›  | æ’æŸ¥æ‰‹æ®µ |
|------|----------|----------|
| CPU å ç”¨è¿‡é«˜ | Reactor çº¿ç¨‹é˜»å¡ã€GC é¢‘ç¹ | `jstack`, `async-profiler` |
| å†…å­˜æŒç»­ä¸Šæ¶¨ | å¯¹è±¡æœªé‡Šæ”¾ã€ç¼“å­˜æœªæ¸…ç† | `jmap -histo`, MAT åˆ†æ dump æ–‡ä»¶ |
| å»¶è¿Ÿå‡é«˜ | åç«¯æœåŠ¡æ…¢ã€ç½‘ç»œå»¶è¿Ÿ | Zipkin é“¾è·¯è¿½è¸ª |
| è¿æ¥è€—å°½ | è¿æ¥æ± å¤ªå°ã€æœªåŠæ—¶é‡Šæ”¾ | æŸ¥çœ‹ Netty è¿æ¥ç»Ÿè®¡æŒ‡æ ‡ |
| é”™è¯¯å¢å¤š | é™æµå¤±æ•ˆã€ä¸‹æ¸¸å¼‚å¸¸ | æŸ¥çœ‹æ—¥å¿—ã€Prometheus é”™è¯¯è®¡æ•° |

---

### 10.6 å°ç»“ï¼šé«˜å¯ç”¨ä¸æ€§èƒ½ä¼˜åŒ–è®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **å¤šå‰¯æœ¬ + å¤šå¯ç”¨åŒº** | é¿å…å•ç‚¹æ•…éšœï¼Œå®ç°é«˜å¯ç”¨ |
| **åˆç†èµ„æºé…ç½®** | è®¾ç½®åˆé€‚çš„ CPU/Memory Limitsï¼Œé¿å… OOM |
| **è¿æ¥æ± ç²¾ç»†åŒ–ç®¡ç†** | æ§åˆ¶æœ€å¤§è¿æ¥æ•°ï¼Œé˜²æ­¢èµ„æºè€—å°½ |
| **å¯ç”¨å‹ç¼©ä¸ç¼“å­˜** | å‡å°‘ä¼ è¾“å¼€é”€ï¼Œæå‡å“åº”é€Ÿåº¦ |
| **è‡ªåŠ¨åŒ–æ‰©ç¼©å®¹** | åº”å¯¹æµé‡æ³¢åŠ¨ï¼Œé™ä½æˆæœ¬ |
| **å®šæœŸå‹æµ‹éªŒè¯** | æå‰å‘ç°æ€§èƒ½ç“¶é¢ˆ |
| **å…¨é“¾è·¯å¯è§‚æµ‹** | ç»“åˆç›‘æ§ã€æ—¥å¿—ã€é“¾è·¯è¿½è¸ªå¿«é€Ÿå®šä½é—®é¢˜ |

---



## 11 å¯è§‚æµ‹æ€§ä½“ç³»å»ºè®¾

### 11.1 åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼ˆSleuth + Zipkinï¼‰

å¼•å…¥ä¾èµ–ï¼š
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-sleuth</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-sleuth-zipkin</artifactId>
</dependency>
```

é…ç½®ï¼š
```yaml
spring:
  zipkin:
    base-url: http://zipkin-server:9411
  sleuth:
    sampler:
      probability: 1.0 # é‡‡æ ·ç‡ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®® 0.1~0.5
```

æ•ˆæœï¼šæ¯ä¸ªè¯·æ±‚ç”Ÿæˆå”¯ä¸€ `Trace ID`ï¼Œè´¯ç©¿æ‰€æœ‰æœåŠ¡è°ƒç”¨é“¾ã€‚

---

### 11.2 æŒ‡æ ‡ç›‘æ§ï¼ˆMicrometer + Prometheusï¼‰

è‡ªåŠ¨æš´éœ²æŒ‡æ ‡ç«¯ç‚¹ï¼š
```yaml
management:
  endpoints:
    web:
      exposure:
        include: prometheus,health,info
```

Prometheus æŠ“å– `/actuator/prometheus` æ•°æ®ï¼Œé‡‡é›†å…³é”®æŒ‡æ ‡ï¼š
- `http_server_requests_seconds_count`ï¼šè¯·æ±‚æ•°
- `http_server_requests_seconds_max`ï¼šæœ€å¤§å»¶è¿Ÿ
- `gateway_requests_count`ï¼šç½‘å…³è½¬å‘æ•°
- `jvm_memory_used`ï¼šå†…å­˜ä½¿ç”¨

---

### 11.3 æ—¥å¿—èšåˆï¼ˆELK / Lokiï¼‰

å°†ç½‘å…³æ—¥å¿—è¾“å‡ºä¸º JSON æ ¼å¼ï¼Œä¾¿äºç»“æ„åŒ–è§£æï¼š

```json
{
  "timestamp": "2025-04-05T10:00:00Z",
  "level": "INFO",
  "thread": "reactor-http-nio-1",
  "logger": "c.n.g.a.AuthenticationFilter",
  "message": "Authenticated user: u123",
  "requestId": "abc-123",
  "path": "/order/123",
  "status": 200
}
```

é€šè¿‡ Filebeat æˆ– Promtail æ”¶é›†æ—¥å¿—ï¼Œé€å…¥ Elasticsearch æˆ– Loki å­˜å‚¨æŸ¥è¯¢ã€‚

---

### 11.4 å‘Šè­¦æœºåˆ¶ï¼ˆAlertmanagerï¼‰

åŸºäº Prometheus è§„åˆ™è§¦å‘å‘Šè­¦ï¼š

```yaml
groups:
  - name: gateway-alerts
    rules:
      - alert: HighGatewayErrorRate
        expr: rate(http_server_requests_seconds_count{status=~"5.."}[5m]) / rate(http_server_requests_seconds_count[5m]) > 0.01
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "ç½‘å…³é”™è¯¯ç‡è¶…è¿‡1%"
```

é€šçŸ¥æ–¹å¼ï¼šé‚®ä»¶ã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€Slackã€‚

---

### 11.5 ç›‘æ§å¤§ç›˜è®¾è®¡ï¼ˆGrafanaï¼‰

åˆ›å»º Grafana ä»ªè¡¨æ¿å±•ç¤ºå…³é”®æŒ‡æ ‡ï¼š

- å®æ—¶ QPS æ›²çº¿
- å»¶è¿Ÿåˆ†å¸ƒå›¾ï¼ˆP50/P95/P99ï¼‰
- é”™è¯¯ç‡è¶‹åŠ¿
- é™æµè§¦å‘æ¬¡æ•°
- JVM å†…å­˜ä¸ GC æƒ…å†µ

---

## 12 é…ç½®ç®¡ç†ä¸åŠ¨æ€æ›´æ–°

### 12.1 é…ç½®ä¸­å¿ƒé›†æˆï¼ˆNacos Config / Spring Cloud Configï¼‰

å°†è·¯ç”±è§„åˆ™å¤–ç½®åˆ°é…ç½®ä¸­å¿ƒï¼Œå®ç°åŠ¨æ€å˜æ›´ï¼š

```yaml
# bootstrap.yml
spring:
  application:
    name: gateway-service
  cloud:
    nacos:
      config:
        server-addr: nacos-server:8848
        file-extension: yaml
```

åœ¨ Nacos ä¸­åˆ›å»º `gateway-service.yaml` é…ç½®æ–‡ä»¶ï¼Œå†…å®¹ä¸ºè·¯ç”±å®šä¹‰ã€‚

---

### 12.2 åŠ¨æ€è·¯ç”±åˆ·æ–°æœºåˆ¶

ç›‘å¬é…ç½®å˜æ›´äº‹ä»¶ï¼Œå®æ—¶æ›´æ–°è·¯ç”±è¡¨ï¼š

```java
@RefreshScope
@RestController
public class RouteController {

    @Autowired
    private RouteDefinitionWriter routeDefinitionWriter;

    @PostMapping("/routes")
    public Mono<Void> addRoute(@RequestBody RouteDefinition definition) {
        return routeDefinitionWriter.save(Mono.just(definition));
    }

    @DeleteMapping("/routes/{id}")
    public Mono<Void> deleteRoute(@PathVariable String id) {
        return routeDefinitionWriter.delete(Mono.just(id));
    }
}
```

é…åˆ `@RefreshScope` å’Œ `/actuator/refresh` å®ç°çƒ­æ›´æ–°ã€‚

---

### 12.3 ç°åº¦å‘å¸ƒæ”¯æŒï¼ˆåŸºäº Header æˆ– IP çš„è·¯ç”±åˆ†æµï¼‰

å®ç°ç°åº¦å‘å¸ƒçš„ä¸¤ç§æ–¹å¼ï¼š

#### æ–¹å¼ä¸€ï¼šåŸºäºè¯·æ±‚å¤´
```yaml
predicates:
  - Path=/user/**
  - Header=X-Release,canary
```

#### æ–¹å¼äºŒï¼šåŸºäºå®¢æˆ·ç«¯ IP
```java
@Bean
public Predicate<Key> ipWhitelistPredicate() {
    Set<String> whitelist = Set.of("192.168.1.100", "10.0.2.50");
    return exchange -> {
        String clientIp = exchange.getRequest().getRemoteAddress().getHostName();
        return whitelist.contains(clientIp);
    };
}
```

ç»“åˆ Nacos é…ç½®å¼€å…³ï¼Œæ§åˆ¶ç°åº¦æµé‡æ¯”ä¾‹ã€‚

---

## 13 å¸¸è§é—®é¢˜æ’æŸ¥æŒ‡å—

### 13.1 è·¯ç”±ä¸ç”Ÿæ•ˆåŸå› åˆ†æ

| ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ³• |
|------|----------|----------|
| 404 Not Found | è·¯ç”± ID å†²çªæˆ–æœªåŠ è½½ | æ£€æŸ¥æ—¥å¿—æ˜¯å¦æœ‰ `RouteDefinition` åŠ è½½è®°å½• |
| è·¯å¾„æœªåŒ¹é… | æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯ | ä½¿ç”¨ `- Path=/api/**` è€Œé `/api/*` |
| HTTPS é‡å®šå‘ | ç¼ºå°‘ secure=false é…ç½® | æ·»åŠ  `spring.cloud.gateway.httpclient.ssl.use-insecure-trust-manager=true`ï¼ˆä»…æµ‹è¯•ç¯å¢ƒï¼‰ |

---

### 13.2 è®¤è¯å¤±è´¥å¸¸è§åœºæ™¯

| ç°è±¡ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| Token æ— æ•ˆ | ç­¾åå¯†é’¥ä¸ä¸€è‡´ | ç¡®ä¿ç½‘å…³ä¸ Auth Server ä½¿ç”¨ç›¸åŒ secret |
| æ—¶é—´åå·®è¿‡å¤§ | æœåŠ¡å™¨æ—¶é—´ä¸åŒæ­¥ | å¯ç”¨ NTP æ—¶é—´åŒæ­¥ |
| CORS é˜»æ­¢ | æœªå…è®¸ Authorization å¤´ | é…ç½® `Access-Control-Allow-Headers: Authorization` |

---

### 13.3 é™æµå¤±æ•ˆæ’æŸ¥æ­¥éª¤

1. æ£€æŸ¥ Redis æ˜¯å¦æ­£å¸¸è¿æ¥ï¼›
2. æŸ¥çœ‹ Lua è„šæœ¬æ˜¯å¦æˆåŠŸæ‰§è¡Œï¼›
3. ç¡®è®¤ `key-resolver` è¿”å›çš„ key æ˜¯å¦å”¯ä¸€ï¼›
4. ä½¿ç”¨ `redis-cli monitor` è§‚å¯Ÿå‘½ä»¤æ‰§è¡Œæƒ…å†µã€‚

---

### 13.4 é«˜å»¶è¿Ÿé—®é¢˜è¯Šæ–­æ–¹æ³•

1. ä½¿ç”¨ Zipkin æŸ¥çœ‹è°ƒç”¨é“¾è·¯ï¼Œå®šä½ç“¶é¢ˆç¯èŠ‚ï¼›
2. æ£€æŸ¥ Netty çº¿ç¨‹æ˜¯å¦é˜»å¡ï¼›
3. æŸ¥çœ‹ GC æ—¥å¿—æ˜¯å¦å­˜åœ¨é¢‘ç¹ Full GCï¼›
4. åˆ†ææ•°æ®åº“æ…¢æŸ¥è¯¢æ—¥å¿—ï¼›
5. ä½¿ç”¨ `jstack` æŠ“å–çº¿ç¨‹æ ˆï¼ŒæŸ¥æ‰¾æ­»é”æˆ–é˜»å¡ç‚¹ã€‚

---

## 14 æœªæ¥æ¼”è¿›æ–¹å‘

### 14.1 å‘æœåŠ¡ç½‘æ ¼è¿ç§»å¯è¡Œæ€§

éšç€æœåŠ¡æ•°é‡å¢é•¿ï¼Œä¼ ç»Ÿ SDK æ¨¡å¼ï¼ˆå¦‚ Feign + Ribbonï¼‰ç»´æŠ¤æˆæœ¬ä¸Šå‡ã€‚æœåŠ¡ç½‘æ ¼ï¼ˆIstioï¼‰æä¾›æ›´é«˜çº§çš„æµé‡æ²»ç†èƒ½åŠ›ï¼š

- æ— éœ€ä¿®æ”¹ä»£ç å³å¯å®ç°ç†”æ–­ã€é‡è¯•ã€é•œåƒæµé‡ã€‚
- æ”¯æŒç»†ç²’åº¦çš„æµé‡æ‹†åˆ†ï¼ˆCanary Releaseï¼‰ã€‚
- ç»Ÿä¸€ mTLS åŠ å¯†ä¸èº«ä»½è®¤è¯ã€‚

ä½†éœ€è¯„ä¼°è¿ç»´å¤æ‚åº¦å’Œèµ„æºå¼€é”€ã€‚

---

### 14.2 BFFï¼ˆBackend For Frontendï¼‰æ¨¡å¼åº”ç”¨

é’ˆå¯¹ä¸åŒå‰ç«¯ï¼ˆWebã€Mobileã€Third-party APIï¼‰ï¼Œå¯æ„å»ºä¸“ç”¨ BFF å±‚ï¼š

- Web-BFFï¼šèšåˆå¤šä¸ªå¾®æœåŠ¡æ•°æ®ï¼Œå‡å°‘å‰ç«¯è¯·æ±‚æ•°ã€‚
- Mobile-BFFï¼šé€‚é…ç§»åŠ¨ç«¯ç½‘ç»œç¯å¢ƒï¼Œå‹ç¼©å“åº”ä½“ã€‚
- OpenAPI-BFFï¼šå¯¹å¤–æä¾›æ ‡å‡†åŒ– REST æ¥å£ï¼Œéšè—å†…éƒ¨ç»“æ„ã€‚

Spring Cloud Gateway å¯ä½œä¸ºè½»é‡çº§ BFF å®ç°ã€‚

---

### 14.3 å¤šç§Ÿæˆ·ç½‘å…³è®¾è®¡æ€è·¯

æ”¯æŒ SaaS åœºæ™¯ä¸‹çš„å¤šç§Ÿæˆ·éš”ç¦»ï¼š

- è·¯ç”±æ ¹æ® `X-Tenant-ID` åˆ†æµè‡³ä¸åŒé›†ç¾¤ï¼›
- é™æµç­–ç•¥æŒ‰ç§Ÿæˆ·ç»´åº¦é…ç½®ï¼›
- æ—¥å¿—ä¸ç›‘æ§æŒ‰ tenant_id åˆ‡ç‰‡ï¼›
- è®¤è¯æ—¶æ ¡éªŒç§Ÿæˆ·æƒé™ã€‚

---

### 14.4 GraphQL èšåˆç½‘å…³æ¢ç´¢

å¯¹äºå¤æ‚æŸ¥è¯¢åœºæ™¯ï¼Œå¯å¼•å…¥ GraphQL ä½œä¸ºèšåˆå±‚ï¼š

- å‰ç«¯è‡ªç”±ç»„åˆå­—æ®µï¼Œå‡å°‘ over-fetchingï¼›
- ç½‘å…³è°ƒç”¨å¤šä¸ªå¾®æœåŠ¡ç»„è£…ç»“æœï¼›
- ç»“åˆ DataLoader è§£å†³ N+1 æŸ¥è¯¢é—®é¢˜ã€‚

å·¥å…·æ¨èï¼š`graphql-java-kickstart` + `spring-boot-starter-graphql`ã€‚

---

## 15 é™„å½•

### 15.1 æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| API Gateway | API ç½‘å…³ï¼Œç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ |
| JWT | JSON Web Tokenï¼Œç”¨äºèº«ä»½è®¤è¯çš„ä»¤ç‰Œæ ¼å¼ |
| OAuth2 | å¼€æ”¾æˆæƒåè®®ï¼Œæ”¯æŒç¬¬ä¸‰æ–¹æˆæƒ |
| WAF | Web Application Firewallï¼ŒWeb åº”ç”¨é˜²ç«å¢™ |
| DDoS | åˆ†å¸ƒå¼æ‹’ç»æœåŠ¡æ”»å‡» |
| LB | Load Balancerï¼Œè´Ÿè½½å‡è¡¡å™¨ |
| mTLS | Mutual TLSï¼ŒåŒå‘ TLS è®¤è¯ |
| SLA | Service Level Agreementï¼ŒæœåŠ¡ç­‰çº§åè®® |
| P99 | 99% è¯·æ±‚çš„å“åº”æ—¶é—´ä¸è¶…è¿‡è¯¥å€¼ |
| CDN | Content Delivery Networkï¼Œå†…å®¹åˆ†å‘ç½‘ç»œ |
| BFF | Backend For Frontendï¼Œé¢å‘å‰ç«¯çš„åç«¯ç½‘å…³ |
| Istio | å¼€æºæœåŠ¡ç½‘æ ¼é¡¹ç›®ï¼Œæä¾›æµé‡æ²»ç†èƒ½åŠ› |

---

### 15.2 æ¨èæŠ€æœ¯æ ˆç»„åˆ

| ç»„ä»¶ç±»åˆ« | æ¨èæ–¹æ¡ˆ |
|--------|----------|
| ç½‘å…³ | Spring Cloud Gateway |
| æ³¨å†Œä¸­å¿ƒ | Nacos |
| é…ç½®ä¸­å¿ƒ | Nacos Config |
| è®¤è¯æœåŠ¡ | Keycloak æˆ–è‡ªç ” JWT æœåŠ¡ |
| é™æµå­˜å‚¨ | Redis Cluster |
| ç›‘æ§ | Prometheus + Grafana |
| é“¾è·¯è¿½è¸ª | Zipkin æˆ– Jaeger |
| æ—¥å¿— | ELK Stack æˆ– Loki + Promtail + Grafana |
| æ¶ˆæ¯é˜Ÿåˆ— | Kafka æˆ– RabbitMQ |
| æ•°æ®åº“ | MySQL + Redis |
| éƒ¨ç½²å¹³å° | Kubernetes + Helm |

---

### 15.3 å‚è€ƒèµ„æ–™ä¸å®˜æ–¹æ–‡æ¡£é“¾æ¥

- Spring Cloud Gateway å®˜æ–¹æ–‡æ¡£ï¼š  
  https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/

- Nacos å®˜æ–¹æ–‡æ¡£ï¼š  
  https://nacos.io/zh-cn/docs/v2/guide.html

- Resilience4j æ–‡æ¡£ï¼š  
  https://resilience4j.readme.io/

- OpenTelemetry è§„èŒƒï¼š  
  https://opentelemetry.io/

- OAuth 2.0 RFC 6749ï¼š  
  https://datatracker.ietf.org/doc/html/rfc6749

- JWT RFC 7519ï¼š  
  https://datatracker.ietf.org/doc/html/rfc7519

---

## ç»“è¯­

Spring Cloud Gateway ä½œä¸ºç°ä»£å¾®æœåŠ¡æ¶æ„çš„å…³é”®åŸºç¡€è®¾æ–½ï¼Œä¸ä»…æ‰¿æ‹…äº†æµé‡è°ƒåº¦çš„åŸºæœ¬èŒèƒ½ï¼Œæ›´æ˜¯ç³»ç»Ÿå®‰å…¨æ€§ã€ç¨³å®šæ€§ä¸å¯è§‚æµ‹æ€§çš„æ ¸å¿ƒä¿éšœã€‚é€šè¿‡åˆç†è®¾è®¡è·¯ç”±è§„åˆ™ã€é›†æˆè®¤è¯æœºåˆ¶ã€å®æ–½é™æµç­–ç•¥ï¼Œå¹¶é…åˆå®Œå–„çš„ç›‘æ§ä½“ç³»ï¼Œå¯ä»¥æ„å»ºä¸€ä¸ªé«˜æ•ˆã€å¯é ã€æ˜“äºç»´æŠ¤çš„ä¼ä¸šçº§å¾®æœåŠ¡å¹³å°ã€‚

æœ¬æ–‡æ¡£æ—¨åœ¨æä¾›ä¸€å¥—å®Œæ•´çš„å®è·µæŒ‡å—ï¼Œå¸®åŠ©æŠ€æœ¯äººå‘˜æ·±å…¥ç†è§£ç½‘å…³åœ¨æ•´ä¸ªæ¶æ„ä¸­çš„ä½œç”¨ï¼Œå¹¶æŒ‡å¯¼å®é™…é¡¹ç›®çš„è½åœ°å®æ–½ã€‚å»ºè®®ç»“åˆå…·ä½“ä¸šåŠ¡åœºæ™¯çµæ´»è°ƒæ•´æ–¹æ¡ˆï¼ŒæŒç»­ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ä¸ç”¨æˆ·ä½“éªŒã€‚
