# 📚 途虎统一文件上传系统接入文档

> **版本**：v1.2  
> **最后更新**：2025年6月5日  
> **维护团队**：李俊义、张凯凯、刘忠良、孟强军  
> **适用对象**：途虎内部服务端/前端开发者  
> **支持接入方式**：Java SDK、HTTP Gateway、NPM 包

---

## 🔖 文档目的与适用范围

本文档旨在指导途虎内部开发者接入**统一文件上传系统**，提供标准化的文件上传、存储、访问能力，保障系统稳定性与安全性。

### ✅ 支持场景

| 场景          | 示例             |
|-------------|----------------|
| 用户资料上传      | 头像、身份证照片、营业执照  |
| 多媒体上传与转码    | 技师工单拍照/录像、客服录音 |
| 敏感文件私有读     | 合同、财务报表、审批附件   |
| 公开文件 CDN 加速 | 图片、公开 PDF、宣传视频 |

### 📞 技术支持

如有问题，请联系：

- 李俊义（xxx）
- 张凯凯（xxx）
- 刘忠良（xxx）
- 孟强军（xxx）

---

## 🏗️ 系统架构概览

```
+------------------+     +---------------------+
|  客户端 (Web/APP)  | --> |  公网 Gateway / CDN  |
+------------------+     +----------+----------+
                                    |
                    +---------------v---------------+
                    |   统一文件上传服务（微服务）    |
                    +---------------+---------------+
                                    |
            +-----------------------+------------------------+
            |                                                |
+-----------v------------+                     +-------------v-------------+
| 腾讯云 COS（主存储）     |<--双向同步-->         | 华为云 OBS（容灾备份）       |
+------------------------+                     +---------------------------+
```

### 🔧 核心特性

- **双云存储**：腾讯云 COS + 华为云 OBS 实时同步，支持自动容灾切换
- **永久存储**：默认不删除文件，业务可设置过期时间自动清理
- **权限控制**：
    - 公开读：支持 CDN 加速访问
    - 私有读：需服务端生成临时签名链接（默认有效期 5 分钟）
- **CDN 域名**
    - 小文件（图片等）：`https://img1.tuhu.org`
    - 大文件（视频等）：`https://v.tuhu.org`

> 📌 示例：公开图片访问 `https://img1.tuhu.org/path/to/image.jpg`

---

## 🚀 快速开始（Java SDK 接入）

推荐内网服务使用 Java SDK 接入，简单、安全、高效。

### 步骤 1：添加 Maven 依赖

```xml

<dependency>
	<groupId>com.tuhu.file</groupId>
	<artifactId>file-upload-sdk</artifactId>
	<version>1.2.0</version>
</dependency>
```

### 步骤 2：配置 `application.yml`

```yaml
tuhu:
  file-upload:
    enabled: true
    app-id: your_app_id
    app-secret: ${FILE_UPLOAD_SECRET}  # 建议通过环境变量注入
    timeout: 10000
    debug: false
```

### 步骤 3：启用自动装配

```java

@SpringBootApplication
@EnableTuhuFileUpload  // 启用文件上传 SDK
public class Application {
	public static void main(String[] args) {
		SpringApplication.run(Application.class, args);
	}
}
```

### 步骤 4：调用上传接口

```java

@Service
public class UserService {

	@Autowired
	private FileUploadClient fileUploadClient;

	public String uploadAvatar(MultipartFile file) throws IOException {
		UploadRequest request = UploadRequest.builder()
				.bizType("USER_AVATAR")           // 业务类型
				.fileName(file.getOriginalFilename())
				.fileStream(file.getInputStream())
				.fileSize(file.getSize())
				.isPublicRead(true)               // 是否公开读
				.build();

		UploadResponse response = fileUploadClient.upload(request);
		return response.getFileUrl(); // 返回 CDN 链接或签名链接
	}
}
```

---

## 🛠️ 接入方式详解

### 1. Java SDK（推荐 · 内网服务）

| 项目       | 说明                                    |
|----------|---------------------------------------|
| 适用环境     | 内网 Spring Boot 服务                     |
| 传输限制     | 单文件 ≤ 100MB                           |
| 是否鉴权     | 是（通过 appId/appSecret）                 |
| 是否支持大文件  | 否（如需 >100MB，请使用【三步上传】）                |
| Maven 坐标 | `com.tuhu.file:file-upload-sdk:1.2.0` |

> ✅ 优势：封装 Feign 调用，无需关心编码器、超时、重试等细节

#### 支持功能

- 普通上传
- 图片压缩（v1.1 新增）
- 自动生成 CDN 链接或签名链接
- 异常统一处理

---

### 2. Gateway HTTP 接入（多语言通用）

适用于非 Java 服务（如 Go、Python、Node.js）或公网调用。

#### 环境与端点

| 网络 | 环境       | 请求路径                                                 | 是否鉴权 | 鉴权方式                              | 用途           |
|----|----------|------------------------------------------------------|------|-----------------------------------|--------------|
| 内网 | tuhutest | `https://shop-gateway.tuhutest.cn/file-upload`       | 否    | -                                 | 测试环境通用上传     |
| 内网 | tuhutest | `https://shop-gateway.tuhutest.cn/arch-file-upload`  | 是    | SSO Token（Header: `X-Boss-Token`） | 敏感文件上传       |
| 内网 | prod     | `https://office-gateway.tuhuyun.cn/file-upload`      | 否    | -                                 | 生产环境通用上传     |
| 内网 | prod     | `https://office-gateway.tuhuyun.cn/arch-file-upload` | 是    | SSO Token                         | 生产环境敏感文件上传   |
| 公网 | -        | `https://upload.tuhu.cn/api/file`                    | 是    | API Key / Token                   | C端应用上传（≤3MB） |

#### 请求示例（curl）

```bash
curl -X POST https://office-gateway.tuhuyun.cn/file-upload \
  -H "Content-Type: multipart/form-data" \
  -F "file=@avatar.jpg" \
  -F "bizType=USER_AVATAR" \
  -F "isPublicRead=true"
```

> 📄 完整接口文档见：[Gateway API 文档链接]

---

### 3. 前端 NPM 包接入（Web / H5 / 小程序）

```bash
npm install @tuhu/file-upload
```

```js
import { uploadFile } from '@tuhu/file-upload';

const result = await uploadFile({
  file: fileInput.files[0],
  bizType: 'USER_ID_CARD',
  isPublicRead: false,
  onProgress: (percent) => console.log(`上传进度: ${percent}%`)
});

console.log(result.url); // 返回访问链接
```

> ⚠️ 注意：前端上传默认限制 ≤10MB（C端 ≤3MB），如需上传更大文件，请使用【三步上传】。

---

## 📦 大文件上传方案（支持最大 5GB）

对于 >100MB 的文件（如视频、备份包），推荐使用 **三步上传模式**：

### 步骤 1：申请上传凭证

```http
POST /file-upload/init
{
  "fileName": "big-video.mp4",
  "fileSize": 2147483648,
  "bizType": "WORK_ORDER_VIDEO"
}
```

### 步骤 2：分片上传（直接传到 COS/OBS）

系统返回 `uploadId` 和 `partUrls`，客户端按片上传。

### 步骤 3：完成上传

```http
POST /file-upload/complete
{
  "uploadId": "xxx",
  "parts": [
    { "partNumber": 1, "etag": "abc" },
    { "partNumber": 2, "etag": "def" }
  ]
}
```

> 📚 详细说明见：[客户端上传方案文档]

---

## 🔐 权限与安全

| 文件类型 | 访问方式        | 说明                       |
|------|-------------|--------------------------|
| 公开读  | 直接访问 CDN 链接 | 无需鉴权，长期有效                |
| 私有读  | 临时签名链接      | 由服务端调用 SDK 生成，有效期默认 5 分钟 |

### 生成私有文件链接（Java 示例）

```java
String signedUrl = fileUploadClient.generateSignedUrl("file-key-123", 300); // 5分钟
```

---

## 📊 文件大小限制汇总

| 接入方式             | 最大文件大小 | 说明        |
|------------------|--------|-----------|
| Java SDK         | 100MB  | 内网服务推荐    |
| Gateway HTTP（内网） | 100MB  | 非 Java 服务 |
| Gateway HTTP（公网） | 10MB   | B端业务      |
| NPM 包 / C端业务     | 3MB    | 用户上传头像等   |
| 三步上传             | 5GB    | 视频、大附件    |

> 💡 限制原因：降低网络压力、防止服务雪崩、提升用户体验

---

## 📚 附录

### A. 版本更新日志

| 版本   | 日期         | 维护人 | 变更说明                |
|------|------------|-----|---------------------|
| v1.0 | 2025-05-21 | 张凯凯 | 初始化文档，Java SDK 接入说明 |
| v1.1 | 2025-06-05 | 张凯凯 | 支持图片压缩功能（服务端侧）      |
| v1.2 | 2025-06-05 | 李俊义 | 新增网关接入说明，优化文档结构     |

---

### B. 废弃说明

- ❌ 【废弃】旧版 `FileUpload` Java SDK（v0.x）已停用，请升级至 v1.x
- ❌ 文件系统架构 V2.1 已过时，当前为 V3.0

---

### C. 相关文档链接

- [客户端上传方案](#)
- [Gateway API 详细接口文档](#)
- [三步上传流程图解](#)
- [Feign 封装最佳实践（内部）](#)

---

## ❓ 常见问题（FAQ）

**Q1：Java SDK 是否线程安全？**  
A：是的，`FileUploadClient` 是单例且线程安全，建议全局使用。

**Q2：上传后如何获取 CDN 链接？**  
A：调用返回的 `response.getFileUrl()`，公开文件返回 CDN 链接，私有文件返回临时签名链接。

**Q3：如何处理上传失败？**  
A：SDK 会抛出 `FileUploadException`，包含错误码和消息，建议打印日志并重试。

**Q4：能否自定义文件存储路径？**  
A：路径由系统根据 `bizType` 自动生成，不可自定义，但可通过 `metadata` 添加业务标签。

**Q5：文件过期后还能恢复吗？**  
A：不能。过期文件会被自动清理，请提前做好归档。

---

## ✅ 总结

| 接入方式         | 推荐场景              | 开发难度     | 维护成本 |
|--------------|-------------------|----------|------|
| Java SDK     | 内网 Spring Boot 服务 | ⭐️⭐️     | 低    |
| Gateway HTTP | 非 Java 服务 / 公网调用  | ⭐️⭐️⭐️   | 中    |
| NPM 包        | Web / 小程序 / App   | ⭐️⭐️     | 低    |
| 三步上传         | 大文件（>100MB）       | ⭐️⭐️⭐️⭐️ | 高    |

> 🎯 **推荐策略**：
> - 内网服务 → 用 Java SDK
> - 前端上传 → 用 NPM 包
> - 大文件 → 用三步上传
> - 其他语言 → 用 Gateway HTTP
