# 📄 文件上传客户端系统设计文档

> **版本**：1.0  
> **适用场景**：大文件上传、断点续传、限速控制、多任务调度、弱网适配  
> **目标平台**：Android / iOS / Desktop / 跨平台 SDK（Kotlin Multiplatform / Flutter）  
> **核心特性**：分片上传、断点续传、流量控制、自动重试、任务队列、安全传输、可观测性

---

## 一、总体架构概览

### 1.1 架构目标

- ✅ 支持大文件上传（GB 级别）
- ✅ 实现断点续传与任务恢复
- ✅ 可配置带宽限制（限速）
- ✅ 多任务并发管理与优先级调度
- ✅ 弱网环境下自动降级与重试
- ✅ 安全通信（HTTPS + Token 认证）
- ✅ 结构化日志与性能监控
- ✅ 可维护、可测试、可扩展

### 1.2 系统分层架构图

```plaintext
+----------------------------+
|     Application Layer      |  ← 用户界面 / SDK 接口
|   - UI Components          |
|   - UploadManager          |
|   - Progress Display       |
+--------------+-------------+
               |
               v
+----------------------------+
|      Service Layer         |  ← 核心业务逻辑
|   - UploadController       |
|   - UploadService          |
|   - RetryService           |
|   - ProgressMonitor        |
+--------------+-------------+
               |
               v
+----------------------------+
|   Upload Queue Manager     |  ← 任务调度中心
|   - Priority Queue         |
|   - Concurrent Control     |
|   - Auto Resume Policy     |
+--------------+-------------+
               |
               v
+----------------------------+
|   Communication Layer      |  ← 网络通信
|   - HttpService (Interface)|
|   - OkHttp 实现             |
|   - Request Builder        |
+--------------+-------------+
               |
               v
+----------------------------+
|   Traffic Control Layer    |  ← 流量控制
|   - RateLimiter            |
|   - ThrottledRequestBody   |
+--------------+-------------+
               |
               v
+----------------------------+
|   Storage / Cache Layer    |  ← 持久化状态
|   - UploadSessionDAO       |
|   - CheckpointManager      |
|   - SQLite / SharedPreferences |
+--------------+-------------+
               |
               v
+----------------------------+
|        Utility Layer       |  ← 工具支撑
|   - Logger                 |
|   - ConfigManager          |
|   - ErrorHandler           |
|   - NetworkMonitor         |
|   - TelemetryReporter      |
+----------------------------+
```

---

## 二、各层模块详细设计

### 2.1 应用层（Application Layer）

#### 职责

- 接收用户输入，启动/暂停/取消上传
- 展示上传进度、速度、预计时间
- 提供 SDK 接口供外部调用

#### 模块说明

| 模块                | 功能                                           |
|-------------------|----------------------------------------------|
| `UploadManager`   | 主入口类，提供 `startUpload(file)`、`pauseAll()` 等方法 |
| `ProgressDisplay` | UI 组件，绑定 `ProgressMonitor` 实时更新界面            |
| `UploadRequest`   | 封装上传请求参数（文件路径、元数据、标签、优先级等）                   |

#### 示例 API（Kotlin 风格）

```kotlin
val request = UploadRequest.Builder()
    .file(file)
    .tag("backup")
    .priority(HIGH)
    .encrypt(true)
    .build()

uploadManager.enqueue(request)
```

---

### 2.2 服务层（Service Layer）

#### 职责

- 协调上传流程
- 执行分片上传逻辑
- 管理重试与进度反馈

#### 模块说明

| 模块                 | 功能                                               |
|--------------------|--------------------------------------------------|
| `UploadController` | 控制器，接收请求并分发到 `UploadService`                     |
| `UploadService`    | 核心服务，负责：<br>• 文件分片<br>• 分片上传<br>• 合并通知           |
| `RetryService`     | 实现指数退避重试策略：<br>`delay = base * 2^retry + jitter` |
| `ProgressMonitor`  | 监听上传进度，回调通知应用层                                   |

#### 分片上传流程

```text
1. 初始化上传 → POST /upload/init → 返回 uploadId
2. 查询已上传分片 → GET /upload/{id}/parts → 返回已成功列表
3. 并行上传未完成分片 → PUT /upload/{id}/part?partNum=1
4. 所有分片完成后 → POST /upload/{id}/complete
```

> 🔐 支持每片 MD5 校验，防止数据损坏。

---

### 2.3 上传队列管理器（Upload Queue Manager）

#### 职责

- 统一管理所有上传任务
- 支持优先级排序、并发控制、批量操作

#### 特性

- 支持优先级队列（High > Normal > Low）
- 最大并发数限制（默认 3）
- 支持暂停/恢复所有任务
- 自动在网络恢复后重试失败任务

#### 数据结构

```java
class UploadTask {
	String taskId;
	File file;
	int priority; // HIGH=3, NORMAL=2, LOW=1
	UploadStatus status; // PENDING, UPLOADING, PAUSED, SUCCESS, FAILED
	long uploadedBytes;
	String uploadId;
}
```

---

### 2.4 通信层（Communication Layer）

#### 职责

- 封装 HTTP 请求与响应
- 抽象网络实现，便于替换或 Mock

#### 模块说明

| 模块                 | 功能                            |
|--------------------|-------------------------------|
| `HttpService`      | 接口抽象，定义 `execute(request)` 方法 |
| `OkHttpClientImpl` | 基于 OkHttp 的实现，支持拦截器、超时、认证     |
| `RequestBuilder`   | 构建带 Token、分片信息的请求             |

#### 安全增强

- 使用 HTTPS + 证书绑定（Certificate Pinning）
- 自动注入 Bearer Token（从 `ConfigManager` 获取）
- 设置合理超时（connect: 10s, read: 30s, write: 60s）

---

### 2.5 流量控制层（Traffic Control Layer）

#### 职责

- 控制上传速率，避免占用过多带宽
- 实时监控上传速度与进度

#### 模块说明

| 模块                     | 功能                         |
|------------------------|----------------------------|
| `RateLimiter`          | 限流器，支持动态设置速率（如 512KB/s）    |
| `ThrottledRequestBody` | 自定义 `RequestBody`，在写入时进行节流 |

#### 节流算法（改进版）

```java
private void throttle(long bytesWritten) throws IOException {
	long now = System.currentTimeMillis();
	long durationMs = now - lastTimestamp;

	// 计算理论应消耗时间
	long expectedTimeMs = (bytesAccumulated * 1000) / rateLimitBps;

	if (durationMs < expectedTimeMs) {
		long sleep = expectedTimeMs - durationMs;
		Thread.sleep(sleep);
	}

	if (durationMs >= 1000) {
		// 每秒更新一次速率
		currentSpeed = bytesAccumulated;
		bytesAccumulated = 0;
		lastTimestamp = now;
		progressMonitor.onProgress(currentSpeed);
	}
}
```

> ⏱ 支持动态调整限速（如用户手动滑动限速条）。

---

### 2.6 存储层（Storage / Cache Layer）

#### 职责

- 持久化上传任务状态
- 支持崩溃后恢复上传

#### 模块说明

| 模块                  | 功能                                                       |
|---------------------|----------------------------------------------------------|
| `UploadSession`     | 存储上传会话信息：<br>• 文件路径<br>• uploadId<br>• 已上传字节<br>• 分片状态数组 |
| `UploadSessionDAO`  | 使用 SQLite 或轻量数据库持久化                                      |
| `CheckpointManager` | 定期保存进度（如每上传 1MB 保存一次）                                    |

#### 表结构示例（SQLite）

```sql
CREATE TABLE upload_sessions (
    id TEXT PRIMARY KEY,
    file_path TEXT NOT NULL,
    upload_id TEXT,
    total_size INTEGER,
    uploaded_bytes INTEGER,
    status TEXT, -- PENDING, UPLOADING, SUCCESS, FAILED
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

---

### 2.7 工具层（Utility Layer）

#### 模块说明

| 模块                  | 功能                                     |
|---------------------|----------------------------------------|
| `Logger`            | 结构化日志输出，支持级别（DEBUG/INFO/WARN/ERROR）    |
| `ConfigManager`     | 加载配置文件（JSON/YAML），支持动态刷新               |
| `ErrorHandler`      | 统一异常处理，区分网络错误、权限错误、服务端错误               |
| `NetworkMonitor`    | 监听网络变化（Wi-Fi ↔ 移动网络），触发自动续传            |
| `TelemetryReporter` | 上报关键指标：<br>• 上传成功率<br>• 平均耗时<br>• 重试次数 |

#### 配置项（config.json）

```json
{
  "max_concurrent_uploads": 3,
  "chunk_size_bytes": 5242880,
  "max_retry_count": 3,
  "base_retry_delay_ms": 1000,
  "rate_limit_mobile_kbps": 512,
  "rate_limit_wifi_kbps": 5120,
  "auto_resume_on_network": true,
  "enable_telemetry": true,
  "telemetry_endpoint": "https://api.example.com/telemetry"
}
```

---

## 三、关键功能实现细节

### 3.1 断点续传流程

```text
启动上传
   ↓
检查本地是否有 UploadSession
   ↓ 是
加载 uploadId 和已上传字节
   ↓
查询服务端已上传分片
   ↓
仅上传缺失分片
   ↓
合并完成

   ↓ 否
新建 uploadId，从头上传
```

> ✅ 支持跨设备恢复？可通过用户 ID + 文件哈希同步状态（需服务端支持）。

---

### 3.2 自适应上传策略

| 网络类型  | 限速策略      | 并发数 | 后台上传  |
|-------|-----------|-----|-------|
| Wi-Fi | 不限或高速     | 3~5 | 允许    |
| 4G/5G | 低速限流      | 1~2 | 提示或禁止 |
| 弱网    | 降速 + 增加超时 | 1   | 暂停    |

通过 `NetworkMonitor` 实时感知并调整策略。

---

### 3.3 安全机制

| 机制        | 说明                                      |
|-----------|-----------------------------------------|
| HTTPS     | 强制使用 TLS 1.2+                           |
| Token 认证  | 请求头自动添加 `Authorization: Bearer <token>` |
| 证书绑定      | 防止中间人攻击                                 |
| 客户端加密（可选） | 使用 AES-256 加密文件内容，密钥由服务端分发              |

---

### 3.4 异常处理策略

| 错误类型                  | 处理方式                  |
|-----------------------|-----------------------|
| 网络中断                  | 进入“等待网络”状态，监听恢复       |
| 401 Unauthorized      | 清除 Token，跳转登录         |
| 403 Forbidden         | 提示权限不足，停止上传           |
| 413 Payload Too Large | 分片上传                  |
| 5xx Server Error      | 可重试，触发 `RetryService` |
| 文件不存在                 | 提前校验，提示用户             |

---

## 四、可观测性与监控

### 4.1 日志格式（JSON 示例）

```json
{
  "timestamp": "2025-04-05T10:00:00Z",
  "level": "INFO",
  "event": "upload_progress",
  "task_id": "task_123",
  "file": "/photos/IMG_001.jpg",
  "uploaded": 10485760,
  "total": 104857600,
  "speed_kbps": 2048,
  "retry_count": 0
}
```

### 4.2 埋点事件

| 事件                | 上报内容      |
|-------------------|-----------|
| `upload_start`    | 文件大小、网络类型 |
| `upload_success`  | 耗时、平均速度   |
| `upload_failed`   | 错误码、重试次数  |
| `retry_triggered` | 重试原因、延迟时间 |

---

## 五、扩展性设计

| 扩展方向  | 实现方式                                |
|-------|-------------------------------------|
| 多线程上传 | 分片并行上传，`OkHttpClient` 支持异步          |
| 跨平台   | 使用 Kotlin Multiplatform 抽象核心逻辑      |
| 插件化   | 提供 `Interceptor` 接口，支持自定义行为（如压缩、加密） |
| 插件机制  | 支持第三方扩展（如上传到 S3、七牛云）                |

---

## 六、测试策略

| 测试类型   | 内容                                       |
|--------|------------------------------------------|
| 单元测试   | Mock `HttpService` 测试 `UploadService` 逻辑 |
| 集成测试   | 搭建 Mock Server 验证分片上传流程                  |
| 弱网测试   | 使用 Charles / Android Studio 网络模拟         |
| 崩溃恢复测试 | 强杀进程后验证断点续传                              |

---

## 七、部署与集成指南（简要）

### 7.1 集成方式

```gradle
implementation 'com.example:upload-sdk:1.0.0'
```

### 7.2 初始化

```kotlin
UploadClient.init(context, config)
val manager = UploadClient.getUploadManager()
```

### 7.3 权限要求（Android）

```xml

<uses-permission android:name="android.permission.INTERNET"/>
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/>
```

---

## 八、总结

本设计文档提供了一个**生产级文件上传客户端系统**的完整架构方案，具备：

- ✅ **高可靠性**：断点续传 + 持久化 + 重试
- ✅ **良好体验**：限速 + 自适应 + 进度反馈
- ✅ **强安全性**：HTTPS + 认证 + 加密
- ✅ **可观测性**：日志 + 埋点 + 监控
- ✅ **易维护性**：模块化 + 可测试 + 配置化

---

## 九、后续建议

1. 输出 UML 类图与序列图
2. 编写 SDK 使用手册
3. 提供 Demo App 演示功能
4. 集成 CI/CD 与自动化测试
5. 支持 WebAssembly 或 Flutter 插件版本

---

✅ **附件建议**：

- [ ] UML 类图
- [ ] 上传流程时序图
- [ ] 数据库 Schema
- [ ] API 接口文档（OpenAPI 风格）
- [ ] 配置文件模板



