
## 一、演进目标与范围

### ✅ 演进目标

1. **服务端**：在现有基础上，补齐 **文件处理服务** 与 **后台管理服务**，形成完整闭环。
2. **客户端**：**重构 Java SDK**，支持统一接入网关、双云容灾、异步任务回调。
3. **基础设施**：实现 **双云（如阿里云 + 腾讯云）部署**，通过容灾切换服务实现跨云故障转移。
4. **接入层**：全面对接 **统一接入网关（已上线）**，统一公网入口、认证、限流。

### 🚫 范围排除

- 暂不建设独立的访问控制服务（复用网关 + 现有权限逻辑）
- 暂不集成 Elasticsearch（后台管理初期支持基础查询）
- 安全、监控、日志等复用公司统一平台

---

## 二、当前架构现状（Baseline）

| 模块       | 状态      | 说明                 |
|----------|---------|--------------------|
| 文件上传服务   | ✅ 已上线   | 支持分片、断点续传、COS 上传   |
| 文件访问服务   | ✅ 已上线   | 支持代理下载、权限校验        |
| 文件存储服务   | ✅ 已上线   | 对接单云 COS（如腾讯云 COS） |
| 容灾切换服务   | ⚠️ 初步可用 | 仅支持本地多可用区，未支持跨云    |
| 统一接入网关   | ✅ 已上线   | 支持公网接入、JWT 认证、限流   |
| Java SDK | ❌ 陈旧    | 直连服务，未适配网关，无双云感知   |
| 文件处理服务   | ❌ 未建设   | 无转码、缩略图、水印等能力      |
| 后台管理服务   | ❌ 未建设   | 无运维界面              |

---

## 三、演进后目标架构

```mermaid
graph TD
    subgraph Client
        App[业务系统 / Web]
        SDK[Java SDK v2]
    end

subgraph Edge
APIGW[统一接入网关 ✅]
end

subgraph Services
Upload[文件上传服务 ✅]
Access[文件访问服务 ✅]
Storage[文件存储服务 ✅]
Processing[文件处理服务 🟡 新增]
Admin[后台管理服务 🟡 新增]
DR[容灾切换服务 🔵 升级]
end

subgraph Storage
COS_A[(腾讯云 COS)]
COS_B[(阿里云 OSS)]
DB[(元数据 DB - 双活)]
end

subgraph Middleware
MQ[(Kafka)]
end

%% 调用关系
App -->|HTTP|APIGW
SDK -->|封装调用| APIGW

APIGW --> Upload
APIGW --> Access
APIGW --> Admin

Upload --> Storage
Upload -->|事件|MQ
Storage --> COS_A
Storage --> COS_B

MQ --> Processing
Processing --> Storage

Admin --> Upload
Admin --> Access
Admin --> Storage

DR --> COS_A
DR --> COS_B
DR --> DB
DR -->|切换指令|APIGW

classDef existing fill: #c8e6c9, stroke: #4a4;
classDef new fill: #fff3e0, stroke: #fa0;
classDef upgrading fill: #bbdefb, stroke: #007;

class Upload, Access, Storage, APIGW existing
class Processing, Admin new
class DR upgrading
```

---

## 四、分阶段演进计划

### ▶️ Phase 1：夯实基础，打通双云容灾（1~2 周）

**目标**：实现双云部署 + 容灾切换能力，为后续服务提供高可用存储底座。

| 任务            | 说明                                                                                  |
|---------------|-------------------------------------------------------------------------------------|
| 1.1 存储服务改造    | 支持配置多云存储后端（COS_A / COS_B），写入时**双写**或**主备写**（初期建议主备）                                 |
| 1.2 元数据 DB 双活 | 使用 MySQL MGR 或 TiDB 实现跨云元数据同步                                                       |
| 1.3 容灾切换服务升级  | <br>- 增加跨云健康检查（HTTP + 存储写入测试）<br>- 故障时自动切换主存储云<br>- 通知 API 网关更新路由策略（如通过 Nacos 配置推送） |
| 1.4 网关联动      | API 网关根据 DR 服务指令，动态调整上传/下载请求的后端服务地址（支持灰度切换）                                         |

> ✅ 产出：双云部署验证报告、RTO < 3 分钟、RPO ≈ 0（主备同步延迟 < 10s）

---

### ▶️ Phase 2：新增核心服务（2~3 周）

#### 2.1 文件处理服务（Processing Service）

| 能力   | 实现方案                                                                                         |
|------|----------------------------------------------------------------------------------------------|
| 异步触发 | 上传完成 → 发送 Kafka 事件（含 file_id, type）                                                          |
| 处理类型 | 初期支持：<br>- 图片缩略图（ImageMagick）<br>- PDF/Word 预览图（LibreOffice + ImageMagick）<br>- 视频封面（FFmpeg） |
| 结果回写 | 处理完成后，更新元数据 DB，标记 `processed=true`                                                           |
| 扩展性  | Worker 可水平扩展，支持新增处理类型插件                                                                      |

#### 2.2 后台管理服务（Admin Service）

| 功能   | 说明                              |
|------|---------------------------------|
| 文件列表 | 分页查询 DB，支持按文件名、上传者、时间范围筛选       |
| 文件操作 | 支持删除、重新触发处理                     |
| 存储监控 | 展示各云存储使用量、健康状态                  |
| 容灾状态 | 可视化主备云状态，支持**手动切换**（用于演练）       |
| 技术栈  | Spring Boot + Vue（轻量级，复用现有前端框架） |

> ✅ 产出：可管理文件生命周期的运维后台，支持处理任务重试。

---

### ▶️ Phase 3：Java SDK 重构（1~2 周）

**目标**：提供**统一、简洁、容灾感知**的客户端 SDK。

#### 核心特性

| 特性     | 说明                                               |
|--------|--------------------------------------------------|
| 网关接入   | 所有请求走 `https://gateway.company.com/file-api/...` |
| 双云透明   | SDK **不感知具体云厂商**，由服务端 DR 决定                      |
| 断点续传   | 支持大文件分片上传 + 进度回调                                 |
| 异步处理监听 | 支持 `onProcessed(FileResult result)` 回调           |
| 临时链接下载 | 支持 `getDownloadUrl(fileId, expireSeconds)`       |
| 配置简化   | 仅需 `appId`, `appSecret`, `gatewayUrl`            |

#### 示例代码

```java
FileClient client = FileClient.builder()
		.gatewayUrl("https://gateway.company.com")
		.appId("my-app")
		.appSecret("xxx")
		.build();

// 上传
FileUploadResult result = client.upload(new File("report.pdf"));

// 监听处理完成
client.

onProcessed(result.getFileId(),file ->{
		System.out.

println("预览图: "+file.getPreviewUrl());
		});

// 获取下载链接（带权限）
String url = client.getDownloadUrl(result.getFileId(), 3600);
```

> ✅ 产出：Maven 发布 `company-file-sdk:2.0.0`，兼容旧版迁移指南。

---

### ▶️ Phase 4：全面对接统一接入网关（持续推动）

| 事项     | 责任方  | 说明                                         |
|--------|------|--------------------------------------------|
| 路由配置   | 平台团队 | 在网关配置 `/file/upload`, `/file/download` 等路由 |
| 认证对接   | 平台团队 | 复用网关 JWT 鉴权，透传 `userId` 到后端                |
| 限流策略   | 平台团队 | 按 appId 限流（如 100 QPS）                      |
| 推动业务接入 | 你    | 提供 SDK + 文档，组织培训，推动 2~3 个核心业务试点            |

> ✅ 产出：网关接入 checklist、业务接入率 100%。

---

## 五、关键风险与应对

| 风险          | 应对措施                              |
|-------------|-----------------------------------|
| 双云写入性能下降    | 初期采用**主备写**（仅主云写入，异步复制到备云），避免强双写  |
| SDK 业务迁移成本高 | 提供 **Adapter 兼容层**，旧接口调用新 SDK     |
| 容灾切换导致短暂不可用 | 切换前通知业务方，网关返回 `503 + Retry-After` |
| 文件处理积压      | 设置 Kafka 分区 + 多 Worker，监控积压告警     |

---

## 六、演进路线图（Timeline）

| 时间   | 阶段      | 里程碑            |
|------|---------|----------------|
| W1-2 | Phase 1 | 双云部署上线，容灾切换自动化 |
| W3-5 | Phase 2 | 文件处理 + 后台管理上线  |
| W6   | Phase 3 | Java SDK v2 发布 |
| W7+  | Phase 4 | 全量业务接入网关，旧直连下线 |

---

## 七、总结

本方案聚焦**最小可行演进**，在已有基础上：

- ✅ 利用**统一接入网关**统一入口
- ✅ 通过**容灾切换服务**实现双云高可用
- ✅ 新增**文件处理**与**后台管理**补齐能力闭环
- ✅ **重构 Java SDK** 提升接入体验与容灾透明性

> 下一步建议：
> 1. 召开技术方案评审会，确认双云写入策略（主备 vs 双写）
> 2. 与网关团队对齐路由与认证细节
> 3. 启动 Java SDK 重构设计（可提供详细接口草案）

如需我协助输出 **Java SDK 接口设计文档**、**容灾切换状态机** 或 **双云存储抽象层代码模板**，请随时告知。